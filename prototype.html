<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Obiegu Kopert v2.0</title>
    <!-- Fonty: Inter dla czysto≈õci i nowoczesno≈õci -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-green: #00e676;
            /* Vibrant Green for Success */
            --accent-blue: #2979ff;
            /* Vibrant Blue for Info */
            --accent-orange: #ff9100;
            /* Vibrant Orange for Return/Warning */
            --accent-red: #ff1744;
            /* Vibrant Red for Error */
            --border-radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* --- UTILS --- */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .col {
            flex-direction: column;
        }

        .row {
            flex-direction: row;
        }

        .center {
            align-items: center;
            justify-content: center;
        }

        .full-height {
            height: 100%;
        }

        .btn {
            border: none;
            padding: 18px 40px;
            border-radius: var(--border-radius);
            font-weight: 900;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 2px solid transparent;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-green {
            background: var(--accent-green);
            color: #000;
            box-shadow: 0 4px 20px rgba(0, 230, 118, 0.6);
            border-color: var(--accent-green);
        }

        .btn-green:hover {
            box-shadow: 0 6px 30px rgba(0, 230, 118, 0.8);
            transform: translateY(-2px);
        }

        .btn-blue {
            background: var(--accent-blue);
            color: #fff;
            box-shadow: 0 4px 20px rgba(41, 121, 255, 0.6);
            border-color: var(--accent-blue);
        }

        .btn-blue:hover {
            box-shadow: 0 6px 30px rgba(41, 121, 255, 0.8);
            transform: translateY(-2px);
        }

        .btn-orange {
            background: var(--accent-orange);
            color: #000;
            box-shadow: 0 4px 20px rgba(255, 145, 0, 0.6);
            border-color: var(--accent-orange);
        }

        .btn-orange:hover {
            box-shadow: 0 6px 30px rgba(255, 145, 0, 0.8);
            transform: translateY(-2px);
        }

        /* Style dla podpowiedzi w slotach paletyzacji */
        .slot-hints-container {
            position: absolute;
            top: 65px;
            left: 0;
            width: 90%;
            background: #333;
            border: 1px solid #555;
            border-radius: 0 0 8px 8px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            box-sizing: border-box;
        }

        /* Style dla podpowiedzi w magazynie */
        .warehouse-hints-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 50px;
            background: #333;
            border: 1px solid #555;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        /* --- WAREHOUSE RESPONSIVE (Tablet + mniejsze ekrany) --- */
        @media (max-width: 1280px) {
            #screen-warehouse .pane-header {
                font-size: clamp(1.1rem, 2vw, 1.35rem);
            }

            #screen-warehouse {
                overflow-y: auto;
            }

            #screen-warehouse .split-container {
                flex-direction: column;
                min-height: 100%;
            }

            #screen-warehouse .warehouse-search-pane,
            #screen-warehouse .warehouse-ops-pane {
                flex: none !important;
                width: 100%;
                border-right: none;
            }

            #screen-warehouse .warehouse-search-pane {
                border-bottom: 1px solid #333;
                min-height: auto;
                position: relative;
                overflow: visible;
                z-index: 30;
            }

            #screen-warehouse .warehouse-ops-pane {
                min-height: 48vh;
                position: relative;
                z-index: 10;
            }

            #screen-warehouse #search-results {
                flex: none !important;
                min-height: 24px;
                max-height: 44px;
                overflow: hidden !important;
                position: relative;
                z-index: 80;
                transition: max-height 0.18s ease;
            }

            #screen-warehouse #search-results.search-results-active {
                max-height: 260px;
                overflow-y: auto !important;
                border: 1px solid #333;
                border-radius: 8px;
                background: #141414;
                box-shadow: 0 12px 24px rgba(0, 0, 0, 0.45);
            }

            #screen-warehouse #search-results p {
                padding: 4px !important;
                margin: 0 !important;
                font-size: 0.92rem !important;
            }

            #screen-warehouse #warehouse-login-view {
                justify-content: flex-start;
                padding-top: 22px;
            }

            #screen-warehouse #warehouse-login-view h2 {
                font-size: 1.55rem !important;
                margin-bottom: 14px !important;
            }

            #screen-warehouse #warehouse-login-view #warehouse-pin-input {
                width: 230px !important;
                font-size: 2.3rem !important;
            }

            #screen-warehouse #warehouse-login-view .btn {
                width: 74px !important;
                height: 74px !important;
                font-size: 1.55rem !important;
            }

            #screen-warehouse #filter-shop-floor {
                transform: scale(1.45) !important;
            }

            #screen-warehouse label[for="filter-shop-floor"] {
                font-size: 1.02rem !important;
            }

            #warehouse-ops-view .warehouse-topbar {
                flex-wrap: wrap;
                justify-content: flex-start !important;
                gap: 8px !important;
                padding: 10px 12px !important;
            }

            #warehouse-ops-view .warehouse-topbar .btn {
                font-size: 0.72rem !important;
                padding: 6px 10px !important;
            }

            #warehouse-ops-view #connection-status {
                width: 100%;
                margin: 0 0 4px 0 !important;
            }

            #warehouse-normal-panel {
                flex-direction: column !important;
                min-height: auto;
            }

            #warehouse-normal-panel .warehouse-column {
                border-right: none !important;
                border-bottom: 1px solid #333;
                min-height: 52vh;
            }

            #warehouse-normal-panel .warehouse-column:last-child {
                border-bottom: none;
            }

            #warehouse-normal-panel .warehouse-history-grid,
            #warehouse-normal-panel .warehouse-return-grid {
                grid-template-columns: 1fr !important;
                height: auto !important;
                min-height: 260px;
            }

            #warehouse-normal-panel .warehouse-zone-row {
                display: grid !important;
                grid-template-columns: repeat(6, minmax(0, 1fr));
            }

            #warehouse-normal-panel .warehouse-zone-row .btn-zone {
                padding: 8px 0 !important;
                min-width: 0;
                font-size: 0.86rem !important;
            }

            #warehouse-admin-panel {
                grid-template-columns: 1fr !important;
                grid-template-rows: auto !important;
                gap: 14px !important;
            }
        }

        @media (max-width: 900px) {
            #warehouse-login-view {
                padding: 14px;
            }

            #warehouse-login-view h2 {
                font-size: 1.35rem !important;
            }

            #warehouse-login-view #warehouse-pin-input {
                width: 100% !important;
                max-width: 300px;
                font-size: 2rem !important;
            }

            #warehouse-login-view .btn {
                width: 100% !important;
                min-width: 0;
                height: 62px !important;
                padding: 0 !important;
                font-size: 1.25rem !important;
            }
        }

        /* --- SCREENS --- */

        /* 1. ROLE SELECTION */
        #screen-role {
            flex: 0 0 auto;
            min-height: 100vh;
            gap: 30px;
            background: radial-gradient(circle at center, #2c2c2c 0%, #121212 100%);
            justify-content: flex-start;
            overflow-y: visible;
            padding: 80px 20px 30px;
            box-sizing: border-box;
        }

        .role-card {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            width: 300px;
            text-align: center;
            border: 1px solid #333;
            cursor: pointer;
            transition: transform 0.3s, border-color 0.3s;
        }

        .role-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-blue);
        }

        .role-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
        }

        .role-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-main);
        }

        .role-desc {
            color: var(--text-secondary);
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* 2. WAREHOUSE DASHBOARD */
        #screen-warehouse {
            flex: 1;
            overflow-y: auto;
            /* Dodano scrollowanie */
        }

        .split-container {
            flex: 1;
            display: flex;
        }

        .split-pane {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
            position: relative;
        }

        .pane-header {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 20px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scanner-area {
            background: rgba(255, 255, 255, 0.03);
            border: 2px dashed #444;
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            transition: background 0.3s;
            min-height: 80px;
            max-height: 100px;
            padding: 10px;
        }

        .scanner-area:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .scan-icon {
            font-size: 1.5rem;
            color: #555;
            margin-bottom: 5px;
        }

        .scan-text {
            color: #777;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .warehouse-scan-text {
            color: var(--accent-orange);
        }

        .warehouse-scan-btn {
            background: linear-gradient(135deg, #ff9100 0%, #ffb74d 100%);
            border: 2px solid #ffc57a;
            box-shadow: 0 10px 24px rgba(255, 145, 0, 0.35);
            cursor: pointer;
            transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
        }

        .warehouse-scan-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 28px rgba(255, 145, 0, 0.45);
            filter: saturate(1.05);
        }

        .warehouse-scan-btn:active {
            transform: translateY(0);
            box-shadow: 0 8px 16px rgba(255, 145, 0, 0.35);
        }

        .warehouse-scan-btn .scan-icon {
            color: #2d1c00;
        }

        .warehouse-scan-btn .warehouse-scan-text {
            color: #7fd7ff;
            font-size: clamp(0.95rem, 1.5vw, 1.15rem);
            font-weight: 900;
            letter-spacing: 0.8px;
            text-shadow: 0 1px 0 rgba(0, 0, 0, 0.35);
        }

        .list-container {
            height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            background: #181818;
            border-radius: var(--border-radius);
            padding: 10px;
            max-height: 400px;
        }

        .list-item {
            background: #252525;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #555;
        }

        .status-ok {
            border-left-color: var(--accent-green);
        }

        .status-loc {
            border-left-color: var(--accent-blue);
        }

        /* Lokalizacja Popup Effect */
        .location-pop {
            font-size: 5rem;
            font-weight: 900;
            color: var(--accent-blue);
            text-shadow: 0 0 20px rgba(41, 121, 255, 0.6);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* 3. OPERATOR WORKSTATION */
        #screen-operator {
            flex: 1;
            min-height: 100vh;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch;
        }

        #operator-standard-view {
            min-height: 0;
            overflow: visible;
        }

        #operator-palletizing-view {
            align-content: start;
            height: auto !important;
            min-height: 0;
            overflow: visible;
        }

        #knowledge-section {
            height: auto !important;
            min-height: 400px;
        }

        .op-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }

        .machine-badge {
            background: #333;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 0.9rem;
            color: #ccc;
        }

        .current-task-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-info h1 {
            margin: 0;
            font-size: 2.5rem;
            color: #fff;
        }

        .task-info p {
            margin: 5px 0 0;
            color: var(--accent-green);
            font-weight: 600;
            letter-spacing: 1px;
        }

        .task-meta {
            text-align: right;
        }

        .meta-label {
            color: var(--text-secondary);
            font-size: 0.8em;
            display: block;
        }

        .meta-val {
            font-size: 1.2em;
            font-weight: 700;
            color: #fff;
        }

        .knowledge-section {
            background: #181818;
            border-radius: 20px;
            padding: 25px;
            border: 1px solid #2a2a2a;
        }

        .operator-search-controls {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: flex-start;
        }

        .operator-search-input-wrap {
            width: min(760px, 100%);
            position: relative;
        }

        .operator-search-actions {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .operator-search-btn {
            width: 220px;
            min-width: 220px;
            flex: 0 0 220px !important;
            padding: 16px 20px !important;
            font-size: 1.2rem !important;
        }

        @media (max-width: 560px) {
            .operator-search-actions {
                width: 100%;
            }

            .operator-search-btn {
                width: 100%;
                min-width: 0;
                flex: 1 1 100% !important;
            }
        }

        .note-card {
            background: #252525;
            border-left: 4px solid var(--accent-orange);
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .note-author {
            font-weight: 700;
            color: var(--text-main);
        }

        .note-date {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .params-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .param-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .param-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .param-val {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-orange);
        }

        /* BACK BUTTON */
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 10px 15px;
            border-radius: 50px;
            cursor: pointer;
            z-index: 100;
        }

        .global-back-btn {
            position: fixed;
            top: 14px;
            left: 14px;
            z-index: 3000;
            border: 1px solid #555;
            font-size: 0.95rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* WAREHOUSE ZONE BUTTONS */
        .btn-zone {
            background: #333;
            color: #fff;
            padding: 10px 15px;
            font-size: 1rem;
            font-weight: 600;
            flex: 1;
            transition: all 0.2s;
        }

        .btn-zone:hover {
            background: #444;
            transform: translateY(-1px);
        }
    </style>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
    <script>
        (function ensureHtml5Qrcode() {
            if (typeof Html5Qrcode !== 'undefined') return;
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'vendor/html5-qrcode.min.js';
            fallbackScript.type = 'text/javascript';
            document.head.appendChild(fallbackScript);
        })();
    </script>
    <script src="https://unpkg.com/konva@9.3.22/konva.min.js" type="text/javascript"></script>
    <script>
        (function ensureKonva() {
            if (typeof Konva !== 'undefined') return;
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'vendor/konva.min.js';
            fallbackScript.type = 'text/javascript';
            document.head.appendChild(fallbackScript);
        })();
    </script>
    <script src="image-annotation-editor.js"></script>
    <style>
        /* MODAL KAMERY */
        #scanner-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #reader {
            width: 100%;
            max-width: 600px;
            background: #000;
            border: 2px solid #555;
            border-radius: 8px;
        }

        .close-scanner-btn {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 1.2rem;
            background: #442222;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* LANGUAGE SWITCHER */
        .lang-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .lang-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
            border: 1px solid #444;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lang-btn.active-lang {
            background: var(--accent-blue);
            color: #fff;
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px rgba(41, 121, 255, 0.4);
        }
    </style>
    <script src="translations.js"></script> <!-- ADDED -->

</head>

<body>

    <!-- MODAL SKANERA (UKRYTY) -->
    <div id="scanner-modal" class="hidden">
        <div id="reader"></div>
        <button class="close-scanner-btn" onclick="closeScanner()" data-i18n="close_camera">ZAMKNIJ KAMERƒò</button>
    </div>

    <button id="global-back-btn" class="back-btn global-back-btn hidden" type="button" onclick="goBack()">
        ‚Üê COFNIJ
    </button>



    <!-- 1. EKRAN WYBORU ROLI -->
    <div id="screen-role" class="flex center col full-height">
        <div class="lang-switch">
            <button id="btn-lang-pl" class="lang-btn active-lang" onclick="setLanguage('pl')">PL</button>
            <button id="btn-lang-en" class="lang-btn" onclick="setLanguage('en')">EN</button>
        </div>

        <h1 style="margin-bottom: 40px; font-weight: 900; letter-spacing: -1px;" data-i18n="system_title">SYSTEM KOPERT
            v2.0</h1>
        <div class="flex row center" style="gap: 30px; flex-wrap: wrap;">
            <div class="role-card" onclick="showWarehouse()">
                <div class="role-icon">üì¶</div>
                <div class="role-title" data-i18n="role_warehouse">MAGAZYNIER</div>
                <div class="role-desc" data-i18n="role_warehouse_desc">Przyjƒôcia, Wydania, Sortowanie</div>
            </div>
            <div class="role-card" onclick="showOperator()">
                <div class="role-icon">‚öôÔ∏è</div>
                <div class="role-title" data-i18n="role_operator">OPERATOR</div>
                <div class="role-desc" data-i18n="role_operator_desc">Produkcja, Ustawienia, Baza Wiedzy</div>
            </div>
        </div>

        <!-- HISTORY SEARCH SECTION -->
        <div style="margin-top: 25px; width: 600px; max-width: 90%;">
            <h2 style="color: var(--accent-blue); margin-bottom: 20px; font-size: 1.3rem; text-align: center;">
                üìú ENVELOPE HISTORY
            </h2>
            <div style="background: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid #333;">
                <div style="margin-bottom: 15px; display: flex; justify-content: center;">
                    <input type="text" id="main-screen-history-search" placeholder="Wpisz ID koperty..."
                        list="main-screen-history-suggestions" oninput="debouncedSearchMainScreenHistory()"
                        style="width: 90%; background: #333; border: 2px solid #444; color: #fff; font-size: 1rem; padding: 12px; border-radius: 8px;">
                    <datalist id="main-screen-history-suggestions"></datalist>
                </div>
                <div id="main-screen-history-results" style="min-height: 50px; max-height: 400px; overflow-y: auto;">
                    <p style="color: #666; text-align: center; padding: 20px;">Wpisz ID koperty aby zobaczyƒá historiƒô...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 1.5 EKRAN WYBORU MASZYNY -->
    <div id="screen-machine-select" class="hidden flex center col full-height" style="background: #1a1a1a;">
        <h2 style="margin-bottom: 20px; color: #fff;" data-i18n="select_machine">WYBIERZ SWOJƒÑ MASZYNƒò</h2>

        <!-- Language Switcher -->
        <div style="margin-bottom: 25px;">
            <button id="lang-toggle-btn" class="btn"
                style="padding: 8px 25px; font-size: 1rem; background: #2979ff; font-weight: bold;"
                onclick="toggleOperatorLanguage()">
                üåê EN
            </button>
        </div>

        <div id="machine-list-grid"
            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 600px;">
            <button class="btn btn-blue" onclick="selectMachine('PRINTER MAIN')">1. PRINTER MAIN</button>
            <button class="btn btn-blue" onclick="selectMachine('PRINTER 2')">2. PRINTER 2</button>
            <button class="btn btn-blue" onclick="selectMachine('VISON')">3. VISON</button>
            <button class="btn btn-blue" onclick="selectMachine('ETERNA')">4. ETERNA</button>
            <button class="btn btn-blue" onclick="selectMachine('CUTER')">5. CUTER</button>
            <button class="btn btn-blue" onclick="selectMachine('ST2')">6. ST2</button>
            <button class="btn btn-blue" onclick="selectMachine('VERSOR')">7. VERSOR</button>
            <button class="btn btn-blue" onclick="selectMachine('BOOBST 1')">8. BOOBST 1</button>
            <button class="btn btn-blue" onclick="selectMachine('BOOBST 2')">9. BOOBST 2</button>
            <button class="btn btn-blue" onclick="selectMachine('PALLETIZING')">10. PALLETIZING</button>
        </div>
    </div>

    <!-- 1.6 EKRAN PIN -->
    <div id="screen-pin" class="hidden flex center col full-height" style="background: #111;">
        <h2 style="color: #fff; margin-bottom: 10px;" data-i18n="enter_pin">PODAJ PIN MASZYNY</h2>
        <h3 id="pin-machine-name" style="color: var(--accent-blue); margin-top: 0;" data-i18n="machine_name">NAZWA
            MASZYNY</h3>

        <input type="password" id="pin-input" readonly style="
            background: #222; border: 2px solid #444; color: #fff; 
            font-size: 2rem; padding: 15px; width: 200px; text-align: center; 
            border-radius: 10px; margin-bottom: 20px; letter-spacing: 5px;
        ">

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
            <button class="btn" style="background: #333; width: 80px; height: 80px; font-size: 1.5rem;"
                onclick="addPin('1')">1</button>
            <button class="btn" style="background: #333; width: 80px; height: 80px; font-size: 1.5rem;"
                onclick="addPin('2')">2</button>
            <button class="btn" style="background: #333; width: 80px; height: 80px; font-size: 1.5rem;"
                onclick="addPin('3')">3</button>
            <button class="btn" style="background: #333; width: 80px; height: 80px; font-size: 1.5rem;"
                onclick="addPin('4')">4</button>
            <button class="btn" style="background: #333; width: 80px; height: 80px; font-size: 1.5rem;"
                onclick="addPin('5')">5</button>
            <button class="btn" style="background: #333; width: 80px; height: 80px; font-size: 1.5rem;"
                onclick="addPin('6')">6</button>
            <button class="btn" style="background: #333; width: 80px; height: 80px; font-size: 1.5rem;"
                onclick="addPin('7')">7</button>
            <button class="btn" style="background: #333; width: 80px; height: 80px; font-size: 1.5rem;"
                onclick="addPin('8')">8</button>
            <button class="btn" style="background: #333; width: 80px; height: 80px; font-size: 1.5rem;"
                onclick="addPin('9')">9</button>
            <button class="btn" style="background: #442222; width: 80px; height: 80px; font-size: 1.5rem;"
                onclick="clearPin()">C</button>
            <button class="btn" style="background: #333; width: 80px; height: 80px; font-size: 1.5rem;"
                onclick="addPin('0')">0</button>
            <button class="btn btn-green" style="width: 80px; height: 80px; font-size: 1.5rem;"
                onclick="verifyPin()">OK</button>
        </div>
        <div id="pin-error" style="color: var(--accent-red); margin-top: 20px; font-weight: bold; opacity: 0;"
            data-i18n="error_pin">B≈ÅƒòDNY
            PIN!</div>
    </div>



    <!-- 2.5 EKRAN MAGAZYNU - G≈Å√ìWNY (po zalogowaniu) -->
    <div id="screen-warehouse" class="hidden flex col">
        <div class="split-container">
            <!-- LEWA: WYSZUKIWARKA KOPERT -->
            <div class="split-pane warehouse-search-pane" style="flex: 0.4; background: #1a1a1a;">
                <div class="pane-header" style="color: var(--accent-blue); margin-left: 100px;">
                    <span data-i18n="search_envelope">WYSZUKAJ KOPERTƒò</span>
                </div>

                <div style="margin-bottom: 15px; background: #252525; padding: 15px; border-radius: 8px;">
                    <label style="color: #888; font-size: 0.8rem; display: block; margin-bottom: 5px;"
                        data-i18n="search_hint">Wpisz dowolne
                        liczby z numeru koperty:</label>
                    <input type="text" id="search-envelope-input"
                        style="width: 95%; background: #333; border: 2px solid #444; color: #fff; font-size: 1.2rem; padding: 12px; border-radius: 8px;"
                        placeholder="np. 765 lub 432345" data-i18n="search_placeholder" oninput="searchEnvelopes()"
                        onfocus="searchEnvelopes()">
                </div>

                <div style="margin: -10px 0 15px 5px; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="filter-shop-floor" onchange="searchEnvelopes()"
                        style="transform: scale(1.3); cursor: pointer; accent-color: var(--accent-orange);">
                    <label for="filter-shop-floor" style="color: #ccc; cursor: pointer; font-size: 0.9rem;"
                        data-i18n="filter_shop_floor">Tylko na
                        Hali (SHOP FLOOR)</label>
                </div>

                <div id="search-results" class="list-container" style="flex: 1; overflow-y: auto;">
                    <p style="color: #666; text-align: center; padding: 20px;" data-i18n="empty_search">Wpisz liczby aby
                        wyszukaƒá...</p>
                </div>
            </div>

            <!-- PRAWA: PANEL OPERACYJNY (Logowanie -> Operacje) -->
            <div class="split-pane warehouse-ops-pane" style="flex: 0.6; padding: 0; background: #111;">

                <!-- WIDOK A: LOGOWANIE MAGAZYNIERA (Domy≈õlny) -->
                <div id="warehouse-login-view" class="flex center col full-height">
                    <h2 style="color: #fff; margin-bottom: 10px; font-size: 1.2rem;" data-i18n="login_required">üîí
                        WYMAGANE LOGOWANIE</h2>

                    <input type="password" id="warehouse-pin-input" readonly style="
                        background: #222; border: 2px solid #444; color: #fff; 
                        font-size: 2rem; padding: 10px; width: 180px; text-align: center; 
                        border-radius: 10px; margin-bottom: 15px; letter-spacing: 5px;
                    ">

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                        <button class="btn" style="background: #333; width: 60px; height: 60px; font-size: 1.2rem;"
                            onclick="addWarehousePin('1')">1</button>
                        <button class="btn" style="background: #333; width: 60px; height: 60px; font-size: 1.2rem;"
                            onclick="addWarehousePin('2')">2</button>
                        <button class="btn" style="background: #333; width: 60px; height: 60px; font-size: 1.2rem;"
                            onclick="addWarehousePin('3')">3</button>
                        <button class="btn" style="background: #333; width: 60px; height: 60px; font-size: 1.2rem;"
                            onclick="addWarehousePin('4')">4</button>
                        <button class="btn" style="background: #333; width: 60px; height: 60px; font-size: 1.2rem;"
                            onclick="addWarehousePin('5')">5</button>
                        <button class="btn" style="background: #333; width: 60px; height: 60px; font-size: 1.2rem;"
                            onclick="addWarehousePin('6')">6</button>
                        <button class="btn" style="background: #333; width: 60px; height: 60px; font-size: 1.2rem;"
                            onclick="addWarehousePin('7')">7</button>
                        <button class="btn" style="background: #333; width: 60px; height: 60px; font-size: 1.2rem;"
                            onclick="addWarehousePin('8')">8</button>
                        <button class="btn" style="background: #333; width: 60px; height: 60px; font-size: 1.2rem;"
                            onclick="addWarehousePin('9')">9</button>
                        <button class="btn" style="background: #442222; width: 60px; height: 60px; font-size: 1.2rem;"
                            onclick="clearWarehousePin()">C</button>
                        <button class="btn" style="background: #333; width: 60px; height: 60px; font-size: 1.2rem;"
                            onclick="addWarehousePin('0')">0</button>
                        <button class="btn btn-green" style="width: 60px; height: 60px; font-size: 1.2rem;"
                            onclick="verifyWarehousePin()">OK</button>
                    </div>
                    <div id="warehouse-pin-error"
                        style="color: var(--accent-red); margin-top: 15px; font-weight: bold; opacity: 0; font-size: 0.9rem;">
                        B≈ÅƒòDNY PIN!</div>
                </div>

                <!-- WIDOK B: OPERACJE (Ukryty przed zalogowaniem) -->
                <!-- WIDOK B: OPERACJE (Ukryty przed zalogowaniem) -->
                <div id="warehouse-ops-view" class="hidden full-height"
                    style="display: flex; flex-direction: column; width: 100%;">

                    <!-- G√ìRNY PASEK NAWIGACJI -->
                    <div class="warehouse-topbar"
                        style="background: #1a1a1a; padding: 10px; display: flex; justify-content: flex-end; gap: 10px; border-bottom: 1px solid #333; align-items: center;">

                        <!-- Wska≈∫nik po≈ÇƒÖczenia -->
                        <div id="connection-status"
                            style="margin-right: auto; margin-left: 10px; font-size: 0.8rem; color: #666; display: flex; align-items: center; gap: 6px;">
                            <div id="connection-dot"
                                style="width: 8px; height: 8px; border-radius: 50%; background: #666;"></div>
                            <span id="connection-text">≈ÅƒÖczenie...</span>
                            <span id="api-url-debug" style="font-size: 0.7rem; color: #444; margin-left: 5px;"></span>
                        </div>

                        <button id="btn-toggle-warehouse-view" onclick="toggleWarehouseView()" class="btn btn-orange"
                            style="width: 140px; height: 45px; font-size: 0.75rem; padding: 0; margin: 0; line-height: 1.2; flex-direction: column; gap: 2px; text-align: center;"
                            data-i18n="btn_toggle_warehouse">RECEIVE</button>
                        <button onclick="window.open('generator-qr.html', '_blank')" class="btn"
                            style="width: 140px; height: 45px; font-size: 0.75rem; padding: 0; margin: 0; background: #2196F3; color: white; line-height: 1.2; flex-direction: column; gap: 2px; text-align: center;"
                            data-i18n="btn_generator">üñ®Ô∏è GENERATOR QR</button>
                        <button id="btn-admin-panel" class="hidden btn btn-orange" onclick="toggleAdminPanel()"
                            style="width: 140px; height: 45px; font-size: 0.75rem; padding: 0; margin: 0; line-height: 1.2; flex-direction: column; gap: 2px; text-align: center;"
                            data-i18n="btn_admin">‚öôÔ∏è PANEL ADMINA</button>
                        <button id="btn-machine-panel" class="hidden btn btn-blue" onclick="toggleMachinePanel()"
                            style="width: 140px; height: 45px; font-size: 0.75rem; padding: 0; margin: 0; line-height: 1.2; flex-direction: column; gap: 2px; text-align: center;"
                            data-i18n="btn_machines">‚öôÔ∏è MASZYNY</button>
                        <button onclick="logoutWarehouse()" class="btn btn-red"
                            style="width: 140px; height: 45px; font-size: 0.75rem; padding: 0; margin: 0; line-height: 1.2; flex-direction: column; gap: 2px; text-align: center;"
                            data-i18n="btn_logout">WYLOGUJ</button>
                    </div>

                    <!-- STANDARDOWY PANEL OPERACYJNY -->
                    <div id="warehouse-normal-panel" style="display: flex; flex-direction: row; flex: 1;">

                        <!-- WEWNƒòTRZNA LEWA: WYDANIE -->
                        <div class="warehouse-column warehouse-column-out" id="warehouse-col-out"
                            style="flex: 1; padding: 20px; border-right: none; display: flex; flex-direction: column;">
                            <div class="pane-header" style="color: var(--accent-green);">
                                <span>‚≠°</span> <span data-i18n="header_issue">WYDANIE (OUT)</span>
                            </div>
                            <!-- Karty z w√≥zkami -->
                            <div
                                style="margin-bottom: 15px; background: #252525; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between;">
                                <span style="color: #888" data-i18n="active_cart">Aktywny W√≥zek:</span>
                                <strong style="color: #fff">CART-OUT-01</strong>
                            </div>

                            <!-- Rƒôczne dodawanie (OUT) -->
                            <div style="display: flex; gap: 5px; margin-bottom: 10px; position: relative;">
                                <input type="text" id="manual-input-out" placeholder="Wpisz nr koperty..."
                                    oninput="showWarehouseSuggestions('out')"
                                    style="flex: 1; background: #333; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px;"
                                    data-i18n="manual_placeholder">
                                <button class="btn btn-green" style="padding: 0 15px;"
                                    onclick="manualAddEnvelope('out')">+</button>
                                <div id="warehouse-hints-out" class="warehouse-hints-container" style="display: none;">
                                </div>
                            </div>

                            <div class="scanner-area warehouse-scan-btn" onclick="simulateScan('out')">
                                <div class="scan-icon">üì°</div>
                                <div class="scan-text warehouse-scan-text">TAP TO SCAN</div>
                            </div>

                            <!-- SPLIT PANEL: Historia + Lista Wyszukiwania -->
                            <div class="warehouse-history-grid"
                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; height: 350px;">

                                <!-- LEFT: Historia Skanowania (OUT) -->
                                <div style="display: flex; flex-direction: column;">
                                    <h4 style="margin: 0 0 8px 0; color: #888; font-size: 0.85rem;"
                                        data-i18n="history_cart_out">üìú HISTORIA (NA W√ìZKU)</h4>
                                    <div class="list-container" id="list-out"
                                        style="flex: 1; overflow-y: auto; background: #1a1a1a; border-radius: 6px; padding: 8px;">
                                        <!-- Elementy dodawane przez JS -->
                                        <div
                                            style="color: #666; font-style: italic; text-align: center; padding: 20px;">
                                            Brak zeskanowanych kopert</div>
                                    </div>
                                </div>

                                <!-- RIGHT: Lista Wyszukiwania -->
                                <div style="display: flex; flex-direction: column;">
                                    <div
                                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <h4 style="margin: 0; color: var(--accent-blue); font-size: 0.85rem;"
                                            data-i18n="today_searched">üîç DZI≈ö
                                            SZUKANE</h4>
                                        <span id="search-list-count-out"
                                            style="font-size: 0.75rem; color: #666;">0/0</span>
                                    </div>

                                    <!-- Przyciski zarzƒÖdzania listƒÖ -->
                                    <div style="display: flex; gap: 5px; margin-bottom: 8px;">
                                        <button onclick="showAddToSearchList('out')" class="btn"
                                            style="flex: 1; padding: 6px; font-size: 0.75rem; background: #444;"
                                            data-i18n="add_btn">+
                                            Dodaj</button>
                                        <button onclick="showImportSearchList('out')" class="btn btn-blue"
                                            style="flex: 1; padding: 6px; font-size: 0.75rem;" data-i18n="import_btn">üìã
                                            Import</button>
                                        <button onclick="clearSearchList('out')" class="btn"
                                            style="padding: 6px 10px; font-size: 0.75rem; background: var(--accent-red);">üóëÔ∏è</button>
                                    </div>

                                    <div id="search-list-out"
                                        style="flex: 1; overflow-y: auto; background: #1a1a1a; border-radius: 6px; padding: 8px;">
                                        <div
                                            style="color: #666; font-style: italic; text-align: center; padding: 20px;">
                                            Lista pusta</div>
                                    </div>
                                </div>
                            </div>

                            <button class="btn btn-green" style="margin-top: 15px;" onclick="confirmCartOut()"
                                data-i18n="btn_confirm_out">ZATWIERDZ
                                W√ìZEK</button>
                        </div>

                        <!-- WEWNƒòTRZNA PRAWA: PRZYJƒòCIE -->
                        <div class="warehouse-column warehouse-column-in" id="warehouse-col-in"
                            style="flex: 1; padding: 20px; display: none; flex-direction: column; position: relative;">

                            <div class="pane-header" style="color: var(--accent-blue);">
                                <span>‚≠£</span> <span data-i18n="header_receive">PRZYJƒòCIE (RET)</span>
                            </div>

                            <div
                                style="margin-bottom: 15px; background: #252525; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between;">
                                <span style="color: #888" data-i18n="active_cart">Aktywny W√≥zek:</span>
                                <strong style="color: #fff">CART-RET-05</strong>
                            </div>

                            <!-- Wyb√≥r strefy -->
                            <div style="margin-bottom: 10px;">
                                <div style="color: #888; font-size: 0.75rem; margin-bottom: 5px;"
                                    data-i18n="target_zone_label">DOCELOWA STREFA
                                    MAGAZYNOWA</div>
                                <!-- Row 1: A-F -->
                                <div class="warehouse-zone-row" style="display: flex; gap: 5px; margin-bottom: 5px;">
                                    <button class="btn btn-zone" id="btn-zone-A" onclick="setManualZone('A')">A</button>
                                    <button class="btn btn-zone" id="btn-zone-B" onclick="setManualZone('B')">B</button>
                                    <button class="btn btn-zone" id="btn-zone-C" onclick="setManualZone('C')">C</button>
                                    <button class="btn btn-zone" id="btn-zone-D" onclick="setManualZone('D')">D</button>
                                    <button class="btn btn-zone" id="btn-zone-E" onclick="setManualZone('E')">E</button>
                                    <button class="btn btn-zone" id="btn-zone-F" onclick="setManualZone('F')">F</button>
                                </div>
                                <!-- Row 2: G-L -->
                                <div class="warehouse-zone-row" style="display: flex; gap: 5px; margin-bottom: 5px;">
                                    <button class="btn btn-zone" id="btn-zone-G" onclick="setManualZone('G')">G</button>
                                    <button class="btn btn-zone" id="btn-zone-H" onclick="setManualZone('H')">H</button>
                                    <button class="btn btn-zone" id="btn-zone-I" onclick="setManualZone('I')">I</button>
                                    <button class="btn btn-zone" id="btn-zone-J" onclick="setManualZone('J')">J</button>
                                    <button class="btn btn-zone" id="btn-zone-K" onclick="setManualZone('K')">K</button>
                                    <button class="btn btn-zone" id="btn-zone-L" onclick="setManualZone('L')">L</button>
                                </div>
                                <!-- Row 3: M-R -->
                                <div class="warehouse-zone-row" style="display: flex; gap: 5px;">
                                    <button class="btn btn-zone" id="btn-zone-M" onclick="setManualZone('M')">M</button>
                                    <button class="btn btn-zone" id="btn-zone-N" onclick="setManualZone('N')">N</button>
                                    <button class="btn btn-zone" id="btn-zone-O" onclick="setManualZone('O')">O</button>
                                    <button class="btn btn-zone" id="btn-zone-P" onclick="setManualZone('P')">P</button>
                                    <button class="btn btn-zone" id="btn-zone-Q" onclick="setManualZone('Q')">Q</button>
                                    <button class="btn btn-zone" id="btn-zone-R" onclick="setManualZone('R')">R</button>
                                </div>
                            </div>


                            <!-- Rƒôczne dodawanie (IN) -->
                            <div style="display: flex; gap: 5px; margin-bottom: 10px; position: relative;">
                                <input type="text" id="manual-input-in" placeholder="Wpisz nr koperty..."
                                    oninput="showWarehouseSuggestions('in')"
                                    style="flex: 1; background: #333; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px;"
                                    data-i18n="manual_placeholder">
                                <button class="btn btn-green" style="padding: 0 15px;"
                                    onclick="manualAddEnvelope('in')">+</button>
                                <div id="warehouse-hints-in" class="warehouse-hints-container" style="display: none;">
                                </div>
                            </div>

                            <div class="scanner-area warehouse-scan-btn" onclick="simulateScan('in')">
                                <div class="scan-icon">üì°</div>
                                <div class="scan-text warehouse-scan-text">TAP TO SCAN</div>
                                <!-- Animowany element strefy -->
                                <div id="loc-display" class="location-display hidden">[ A ]</div>
                            </div>

                            <!-- Licznik Zwrot√≥w (API) -->
                            <div id="cart-return-counter-box"
                                style="margin-top: 15px; background: #222; padding: 10px; border-radius: 8px; text-align: center; border: 1px dashed #555;">
                                <div style="font-size: 0.75rem; color: #aaa; margin-bottom: 4px; letter-spacing: 1px;"
                                    data-i18n="cart_return_label">
                                    NA W√ìZKU ZWROTNYM</div>
                                <div
                                    style="font-size: 2rem; font-weight: bold; color: var(--accent-orange); line-height: 1;">
                                    <span id="cart-return-count">-</span>
                                </div>
                            </div>

                            <!-- SPLIT PANEL: Historia + Lista Wyszukiwania -->
                            <div class="warehouse-return-grid"
                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; height: 200px;">

                                <!-- LEFT: Historia Skanowania (IN) -->
                                <div style="display: flex; flex-direction: column;">
                                    <h4 style="margin: 0 0 8px 0; color: #888; font-size: 0.85rem;"
                                        data-i18n="history_cart_in">üìú HISTORIA (Z W√ìZKA)
                                    </h4>
                                    <div class="list-container" id="list-in"
                                        style="flex: 1; overflow-y: auto; background: #1a1a1a; border-radius: 6px; padding: 8px;">
                                        <!-- Elementy dodawane przez JS -->
                                        <div style="color: #666; font-style: italic; text-align: center; padding: 20px;"
                                            data-i18n="no_scanned">
                                            Brak
                                            zeskanowanych kopert</div>
                                    </div>
                                </div>

                                <!-- RIGHT: Lista Wyszukiwania -->
                                <div style="display: flex; flex-direction: column;">
                                    <div
                                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <h4 style="margin: 0; color: var(--accent-orange); font-size: 0.85rem;"
                                            data-i18n="return_cart_title">
                                            üì¶ DO ZWROTU
                                        </h4>
                                        <span id="return-cart-count-in"
                                            style="font-size: 0.75rem; color: #666;">0</span>
                                    </div>



                                    <div id="return-cart-list-in"
                                        style="flex: 1; overflow-y: auto; background: #1a1a1a; border-radius: 6px; padding: 8px;">
                                        <div style="color: #666; font-style: italic; text-align: center; padding: 20px;"
                                            data-i18n="no_envelopes">
                                            Brak kopert</div>
                                    </div>
                                </div>
                            </div>

                            <button class="btn btn-blue" style="margin-top: 15px;" onclick="confirmCartIn()"
                                data-i18n="btn_finish_in">ZAKO≈ÉCZ
                                PRZYJƒòCIE</button>
                        </div>
                    </div>

                    <!-- PANEL ADMINA (UKRYTY) -->
                    <div id="warehouse-admin-panel" class="hidden"
                        style="flex: 1; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto 1fr; gap: 20px; overflow-y: auto;">

                        <!-- ZARZƒÑDZANIE PRODUKTAMI (NOWE) -->
                        <div style="background: #252525; padding: 20px; border-radius: 10px; border: 1px solid #333;">
                            <h3 style="margin-top: 0; color: var(--accent-orange);" data-i18n="header_add_product">üè≠
                                DODAJ PRODUKT</h3>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div>
                                    <label style="color: #888; font-size: 0.8rem;" data-i18n="label_company">Nazwa
                                        Firmy</label>
                                    <input id="new-product-company" type="text" placeholder="np. PROTEGA GLOBAL LTD"
                                        style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="color: #888; font-size: 0.8rem;" data-i18n="label_product">Nazwa
                                        Produktu</label>
                                    <input id="new-product-name" type="text" placeholder="np. T22684 OXED (NEW FSC)"
                                        style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="color: #888; font-size: 0.8rem;" data-i18n="label_rcs">Identyfikator
                                        RCS</label>
                                    <input id="new-product-rcs" type="text" placeholder="np. RCS044563/C"
                                        style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;">
                                </div>
                                <button onclick="createNewProduct()" class="btn btn-orange"
                                    style="padding: 12px; font-weight: bold;" data-i18n="btn_add_product">
                                    DODAJ PRODUKT
                                </button>
                            </div>
                        </div>

                        <!-- LISTA PRODUKT√ìW -->
                        <div
                            style="background: #252525; padding: 20px; border-radius: 10px; border: 1px solid #333; display: flex; flex-direction: column;">
                            <h3 style="margin-top: 0; color: var(--accent-orange);" data-i18n="header_product_list">üìã
                                LISTA PRODUKT√ìW</h3>

                            <!-- Przyciski zarzƒÖdzania -->
                            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                                <button onclick="loadProductsList()" class="btn"
                                    style="padding: 8px 15px; background: #444; font-size: 0.85rem;"
                                    data-i18n="btn_refresh">
                                    üîÑ Od≈õwie≈º
                                </button>
                                <button onclick="showImportModal('csv')" class="btn btn-orange"
                                    style="padding: 8px 15px; font-size: 0.85rem;" data-i18n="btn_import_csv">
                                    üì§ Importuj CSV
                                </button>
                                <button onclick="showImportModal('excel')" class="btn btn-orange"
                                    style="padding: 8px 15px; font-size: 0.85rem;" data-i18n="btn_import_excel">
                                    üìä Importuj Excel
                                </button>
                                <button onclick="downloadCSVTemplate()" class="btn"
                                    style="padding: 8px 15px; background: #555; font-size: 0.85rem;"
                                    data-i18n="btn_template_csv">
                                    üì• Szablon CSV
                                </button>
                            </div>

                            <!-- Wyszukiwarka -->
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input id="search-product-input" type="text" placeholder="Szukaj produktu..."
                                    oninput="searchProductsAdmin()"
                                    style="flex: 1; padding: 8px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;"
                                    data-i18n="placeholder_search_product">
                            </div>

                            <!-- Lista produkt√≥w -->
                            <div id="products-list"
                                style="flex: 1; background: #1a1a1a; border-radius: 6px; padding: 10px; overflow-y: auto; border: 1px solid #333; max-height: 200px;">
                                <div style="color: #555; text-align: center; margin-top: 20px;"
                                    data-i18n="products_loading">≈Åadowanie produkt√≥w...
                                </div>
                            </div>
                        </div>

                        <!-- TWORZENIE KOPERTY (ZMODYFIKOWANE) -->
                        <div style="background: #252525; padding: 20px; border-radius: 10px; border: 1px solid #333;">
                            <h3 style="margin-top: 0; color: var(--accent-green);" data-i18n="header_register_envelope">
                                üìù REJESTRACJA NOWEJ KOPERTY</h3>
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <div>
                                    <label style="color: #888; font-size: 0.8rem;"
                                        data-i18n="label_choose_product">Wybierz Produkt (wpisz nazwƒô lub
                                        RCS)</label>
                                    <input list="products-options" id="new-env-product-display"
                                        oninput="onProductInput()" placeholder="Szukaj..."
                                        style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;"
                                        data-i18n="placeholder_search">
                                    <datalist id="products-options"></datalist>
                                    <input type="hidden" id="new-env-product">
                                </div>
                                <div id="selected-product-info" class="hidden"
                                    style="background: #1a1a1a; padding: 10px; border-radius: 6px; border-left: 3px solid var(--accent-green);">
                                    <div style="color: #888; font-size: 0.75rem;" data-i18n="label_selected_product">
                                        WYBRANY PRODUKT</div>
                                    <div id="selected-product-display" style="color: #fff; font-weight: bold;"></div>
                                </div>
                                <div>
                                    <label style="color: #888; font-size: 0.8rem;"
                                        data-i18n="label_warehouse_section">Sekcja Magazynowa</label>
                                    <select id="new-env-sec"
                                        style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;">
                                        <option value="A" data-i18n="option_section" data-i18n-args='["A"]'>Sekcja A
                                        </option>
                                        <option value="B" data-i18n="option_section" data-i18n-args='["B"]'>Sekcja B
                                        </option>
                                        <option value="C" data-i18n="option_section" data-i18n-args='["C"]'>Sekcja C
                                        </option>
                                        <option value="D" data-i18n="option_section" data-i18n-args='["D"]'>Sekcja D
                                        </option>
                                        <option value="E" data-i18n="option_section" data-i18n-args='["E"]'>Sekcja E
                                        </option>
                                        <option value="F" data-i18n="option_section" data-i18n-args='["F"]'>Sekcja F
                                        </option>
                                        <option value="G" data-i18n="option_section" data-i18n-args='["G"]'>Sekcja G
                                        </option>
                                        <option value="H" data-i18n="option_section" data-i18n-args='["H"]'>Sekcja H
                                        </option>
                                        <option value="I" data-i18n="option_section" data-i18n-args='["I"]'>Sekcja I
                                        </option>
                                        <option value="J" data-i18n="option_section" data-i18n-args='["J"]'>Sekcja J
                                        </option>
                                        <option value="K" data-i18n="option_section" data-i18n-args='["K"]'>Sekcja K
                                        </option>
                                        <option value="L" data-i18n="option_section" data-i18n-args='["L"]'>Sekcja L
                                        </option>
                                        <option value="M" data-i18n="option_section" data-i18n-args='["M"]'>Sekcja M
                                        </option>
                                        <option value="N" data-i18n="option_section" data-i18n-args='["N"]'>Sekcja N
                                        </option>
                                        <option value="O" data-i18n="option_section" data-i18n-args='["O"]'>Sekcja O
                                        </option>
                                        <option value="P" data-i18n="option_section" data-i18n-args='["P"]'>Sekcja P
                                        </option>
                                        <option value="Q" data-i18n="option_section" data-i18n-args='["Q"]'>Sekcja Q
                                        </option>
                                        <option value="R" data-i18n="option_section" data-i18n-args='["R"]'>Sekcja R
                                        </option>
                                    </select>

                                </div>
                                <!-- Ukryte pole dla kompatybilno≈õci wstecznej -->
                                <input id="new-env-rcs" type="hidden">
                                <button onclick="createNewEnvelope()" class="btn btn-green"
                                    style="padding: 12px; font-weight: bold; margin-top: 10px;"
                                    data-i18n="btn_create_envelope">
                                    UTW√ìRZ KOPERTƒò
                                </button>
                            </div>
                        </div>

                        <!-- HISTORIA -->
                        <div
                            style="background: #252525; padding: 20px; border-radius: 10px; border: 1px solid #333; display: flex; flex-direction: column;">
                            <h3 style="margin-top: 0; color: var(--accent-blue);" data-i18n="header_envelope_history">üîç
                                HISTORIA KOPERTY</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <input id="history-env-id" type="text" placeholder="Wpisz ID koperty..."
                                    style="flex: 1; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;"
                                    data-i18n="placeholder_envelope_id">
                                <button onclick="checkEnvelopeHistory()" class="btn btn-blue" style="padding: 0 20px;"
                                    data-i18n="btn_search">
                                    SZUKAJ
                                </button>
                            </div>
                            <div id="history-results"
                                style="flex: 1; background: #1a1a1a; border-radius: 6px; padding: 10px; overflow-y: auto; border: 1px solid #333;">
                                <div style="color: #555; text-align: center; margin-top: 20px;"
                                    data-i18n="history_results_empty">Wpisz ID aby zobaczyƒá
                                    historiƒô</div>
                            </div>
                        </div>

                        <!-- USUWANIE KOPERTY (NOWE) -->
                        <div
                            style="background: #252525; padding: 20px; border-radius: 10px; border: 1px solid #333; display: flex; flex-direction: column;">
                            <h3 style="margin-top: 0; color: #ff5555;" data-i18n="header_delete_envelope">üóëÔ∏è USUWANIE
                                KOPERTY</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <input id="delete-envelope-id" type="text" placeholder="ID koperty do usuniƒôcia..."
                                    style="flex: 1; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;"
                                    data-i18n="placeholder_delete_id">
                            </div>
                            <button onclick="deleteEnvelope()" class="btn"
                                style="background: #550000; border: 1px solid #ff4444; color: #ffaaaa; padding: 12px; font-weight: bold;"
                                data-i18n="btn_delete_permanent">
                                USU≈É TRWALE
                            </button>
                            <div style="color: #666; font-size: 0.8rem; margin-top: 10px; text-align: center;"
                                data-i18n="warning_delete_caution">
                                Ostro≈ºnie! Tej operacji nie mo≈ºna cofnƒÖƒá.
                            </div>
                        </div>
                    </div>

                    <!-- PANEL ZARZƒÑDZANIA MASZYNAMI (UKRYTY) -->
                    <div id="machine-management-panel" class="hidden"
                        style="flex: 1; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; overflow-y: auto;">

                        <!-- DODAWANIE MASZYNY -->
                        <div style="background: #252525; padding: 20px; border-radius: 10px; border: 1px solid #333;">
                            <h3 style="margin-top: 0; color: var(--accent-blue);">‚öôÔ∏è DODAJ MASZYNƒò</h3>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div>
                                    <label style="color: #888; font-size: 0.8rem;">Nazwa maszyny</label>
                                    <input id="new-machine-name" type="text" placeholder="np. BOOBST 3"
                                        style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="color: #888; font-size: 0.8rem;">PIN (4 cyfry)</label>
                                    <input id="new-machine-pin" type="text" placeholder="1234" maxlength="4"
                                        style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;">
                                </div>
                                <button onclick="addNewMachine()" class="btn btn-blue"
                                    style="padding: 12px; font-weight: bold; margin-top: 10px;">
                                    DODAJ MASZYNƒò
                                </button>
                            </div>
                        </div>

                        <!-- LISTA MASZYN -->
                        <div
                            style="background: #252525; padding: 20px; border-radius: 10px; border: 1px solid #333; display: flex; flex-direction: column;">
                            <h3 style="margin-top: 0; color: var(--accent-blue);">üìã LISTA MASZYN</h3>
                            <div id="machines-list"
                                style="flex: 1; background: #1a1a1a; border-radius: 6px; padding: 10px; overflow-y: auto; border: 1px solid #333; max-height: 500px;">
                                <div style="color: #555; text-align: center; margin-top: 20px;">
                                    ≈Åadowanie maszyn...
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- 3. EKRAN OPERATORA -->
    <div id="screen-operator" class="hidden col">
        <div class="op-header">
            <div class="flex center" style="gap: 15px; margin-left: 120px;">
                <div style="font-weight: 800; font-size: 1.2rem;">JAN KOWALSKI</div>
                <div class="machine-badge" id="operator-shift-badge">ZMIANA 1</div>
                <button class="btn" style="padding: 5px 15px; font-size: 0.8rem; background: #664422;"
                    onclick="logoutToHome()">‚åÇ</button>
                <button class="btn" style="padding: 5px 15px; font-size: 0.8rem; background: #444;" onclick="logout()"
                    data-i18n="btn_logout">WYLOGUJ</button>
            </div>
            <h1 style="margin: 0; color: #555;"><span data-i18n="machineLabel">MASZYNA</span> <span
                    id="lbl-machine-name" style="color: #fff">S1</span></h1>
        </div>

        <!-- EKRAN PALETYZACJI (GRID 2x2) - widoczny tylko dla PALLETIZING -->
        <!-- EKRAN PALETYZACJI (GRID 2x2) - widoczny tylko dla PALLETIZING -->
        <div id="operator-palletizing-view" class="hidden"
            style="flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <!-- SLOT 1 -->
            <div class="pallet-slot" id="slot-1"
                style="background: #222; border: 1px solid #444; border-radius: 10px; padding: 15px; min-height: 350px; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; color: #888; font-size: 1rem;" data-i18n="slot_label"
                    data-i18n-args='["1"]'>üì¶ SLOT 1</h3>
                <div class="slot-content flex col" style="flex: 1; position: relative;">
                    <!-- Input koperty -->
                    <input type="text" id="slot-input-1" placeholder="Nr koperty..." oninput="showSlotSuggestions(1)"
                        style="width: 90%; background: #333; border: 1px solid #555; color: #fff; padding: 10px; font-size: 1rem; border-radius: 4px; margin-bottom: 8px;">
                    <div id="slot-hints-1" class="slot-hints-container" style="display: none;"></div>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <button class="btn btn-blue" style="flex: 1; font-size: 0.9rem; padding: 8px;"
                            onclick="loadEnvelopeForSlot(1)" data-i18n="load_btn">ZA≈ÅADUJ</button>
                        <button class="btn" style="width: 50px; background: #444; font-size: 1rem;"
                            onclick="activateSlot(1)" title="Symuluj Skan">üì°</button>
                    </div>
                    <!-- Historia slotu -->
                    <div id="slot-history-1"
                        style="width: 90%; flex: 1; background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px; overflow-y: auto; min-height: 80px; margin-bottom: 8px; box-sizing: border-box;">
                        <div style="color: #555; font-size: 0.75rem; text-align: center;" data-i18n="no_entries">Brak
                            wpis√≥w</div>
                    </div>
                    <!-- Notatka + Zapisz -->
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="slot-note-1" data-i18n="slot_note_placeholder"
                            style="flex: 1; background: #333; border: 1px solid #555; color: #fff; padding: 8px; font-size: 0.85rem; border-radius: 4px;">
                        <button class="btn btn-blue" style="padding: 8px 10px; font-size: 0.8rem;"
                            onclick="openNoteImagePicker('slot-1')">üñºÔ∏è</button>
                        <button class="btn btn-green" style="padding: 8px 12px; font-size: 0.85rem;"
                            onclick="saveSlotNote(1)">üíæ</button>
                    </div>
                    <input type="file" id="note-image-input-slot-1" accept="image/*" capture="environment"
                        style="display:none" onchange="handleNoteImageSelected('slot-1', this)">
                    <div id="note-images-slot-1" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;"></div>
                </div>
            </div>
            <!-- SLOT 2 -->
            <div class="pallet-slot" id="slot-2"
                style="background: #222; border: 1px solid #444; border-radius: 10px; padding: 15px; min-height: 350px; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; color: #888; font-size: 1rem;" data-i18n="slot_label"
                    data-i18n-args='["2"]'>üì¶ SLOT 2</h3>
                <div class="slot-content flex col" style="flex: 1; position: relative;">
                    <input type="text" id="slot-input-2" data-i18n="slot_envelope_placeholder"
                        oninput="showSlotSuggestions(2)"
                        style="width: 90%; background: #333; border: 1px solid #555; color: #fff; padding: 10px; font-size: 1rem; border-radius: 4px; margin-bottom: 8px;">
                    <div id="slot-hints-2" class="slot-hints-container" style="display: none;"></div>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <button class="btn btn-blue" style="flex: 1; font-size: 0.9rem; padding: 8px;"
                            onclick="loadEnvelopeForSlot(2)" data-i18n="load_btn">ZA≈ÅADUJ</button>
                        <button class="btn" style="width: 50px; background: #444; font-size: 1rem;"
                            onclick="activateSlot(2)" title="Symuluj Skan">üì°</button>
                    </div>
                    <div id="slot-history-2"
                        style="width: 90%; flex: 1; background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px; overflow-y: auto; min-height: 80px; margin-bottom: 8px; box-sizing: border-box;">
                        <div style="color: #555; font-size: 0.75rem; text-align: center;" data-i18n="no_entries">Brak
                            wpis√≥w</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="slot-note-2" data-i18n="slot_note_placeholder"
                            style="flex: 1; background: #333; border: 1px solid #555; color: #fff; padding: 8px; font-size: 0.85rem; border-radius: 4px;">
                        <button class="btn btn-blue" style="padding: 8px 10px; font-size: 0.8rem;"
                            onclick="openNoteImagePicker('slot-2')">üñºÔ∏è</button>
                        <button class="btn btn-green" style="padding: 8px 12px; font-size: 0.85rem;"
                            onclick="saveSlotNote(2)">üíæ</button>
                    </div>
                    <input type="file" id="note-image-input-slot-2" accept="image/*" capture="environment"
                        style="display:none" onchange="handleNoteImageSelected('slot-2', this)">
                    <div id="note-images-slot-2" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;"></div>
                </div>
            </div>
            <!-- SLOT 3 -->
            <div class="pallet-slot" id="slot-3"
                style="background: #222; border: 1px solid #444; border-radius: 10px; padding: 15px; min-height: 350px; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; color: #888; font-size: 1rem;" data-i18n="slot_label"
                    data-i18n-args='["3"]'>üì¶ SLOT 3</h3>
                <div class="slot-content flex col" style="flex: 1; position: relative;">
                    <input type="text" id="slot-input-3" data-i18n="slot_envelope_placeholder"
                        oninput="showSlotSuggestions(3)"
                        style="width: 90%; background: #333; border: 1px solid #555; color: #fff; padding: 10px; font-size: 1rem; border-radius: 4px; margin-bottom: 8px;">
                    <div id="slot-hints-3" class="slot-hints-container" style="display: none;"></div>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <button class="btn btn-blue" style="flex: 1; font-size: 0.9rem; padding: 8px;"
                            onclick="loadEnvelopeForSlot(3)" data-i18n="load_btn">ZA≈ÅADUJ</button>
                        <button class="btn" style="width: 50px; background: #444; font-size: 1rem;"
                            onclick="activateSlot(3)" title="Symuluj Skan">üì°</button>
                    </div>
                    <div id="slot-history-3"
                        style="width: 90%; flex: 1; background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px; overflow-y: auto; min-height: 80px; margin-bottom: 8px; box-sizing: border-box;">
                        <div style="color: #555; font-size: 0.75rem; text-align: center;" data-i18n="no_entries">Brak
                            wpis√≥w</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="slot-note-3" data-i18n="slot_note_placeholder"
                            style="flex: 1; background: #333; border: 1px solid #555; color: #fff; padding: 8px; font-size: 0.85rem; border-radius: 4px;">
                        <button class="btn btn-blue" style="padding: 8px 10px; font-size: 0.8rem;"
                            onclick="openNoteImagePicker('slot-3')">üñºÔ∏è</button>
                        <button class="btn btn-green" style="padding: 8px 12px; font-size: 0.85rem;"
                            onclick="saveSlotNote(3)">üíæ</button>
                    </div>
                    <input type="file" id="note-image-input-slot-3" accept="image/*" capture="environment"
                        style="display:none" onchange="handleNoteImageSelected('slot-3', this)">
                    <div id="note-images-slot-3" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;"></div>
                </div>
            </div>
            <!-- SLOT 4 -->
            <div class="pallet-slot" id="slot-4"
                style="background: #222; border: 1px solid #444; border-radius: 10px; padding: 15px; min-height: 350px; display: flex; flex-direction: column;">
                <h3 style="margin: 0 0 10px 0; color: #888; font-size: 1rem;" data-i18n="slot_label"
                    data-i18n-args='["4"]'>üì¶ SLOT 4</h3>
                <div class="slot-content flex col" style="flex: 1; position: relative;">
                    <input type="text" id="slot-input-4" data-i18n="slot_envelope_placeholder"
                        oninput="showSlotSuggestions(4)"
                        style="width: 90%; background: #333; border: 1px solid #555; color: #fff; padding: 10px; font-size: 1rem; border-radius: 4px; margin-bottom: 8px;">
                    <div id="slot-hints-4" class="slot-hints-container" style="display: none;"></div>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <button class="btn btn-blue" style="flex: 1; font-size: 0.9rem; padding: 8px;"
                            onclick="loadEnvelopeForSlot(4)" data-i18n="load_btn">ZA≈ÅADUJ</button>
                        <button class="btn" style="width: 50px; background: #444; font-size: 1rem;"
                            onclick="activateSlot(4)" title="Symuluj Skan">üì°</button>
                    </div>
                    <div id="slot-history-4"
                        style="width: 90%; flex: 1; background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px; overflow-y: auto; min-height: 80px; margin-bottom: 8px; box-sizing: border-box;">
                        <div style="color: #555; font-size: 0.75rem; text-align: center;" data-i18n="no_entries">Brak
                            wpis√≥w</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="slot-note-4" data-i18n="slot_note_placeholder"
                            style="flex: 1; background: #333; border: 1px solid #555; color: #fff; padding: 8px; font-size: 0.85rem; border-radius: 4px;">
                        <button class="btn btn-blue" style="padding: 8px 10px; font-size: 0.8rem;"
                            onclick="openNoteImagePicker('slot-4')">üñºÔ∏è</button>
                        <button class="btn btn-green" style="padding: 8px 12px; font-size: 0.85rem;"
                            onclick="saveSlotNote(4)">üíæ</button>
                    </div>
                    <input type="file" id="note-image-input-slot-4" accept="image/*" capture="environment"
                        style="display:none" onchange="handleNoteImageSelected('slot-4', this)">
                    <div id="note-images-slot-4" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;"></div>
                </div>
            </div>
        </div>

        <!-- EKRAN STANDARDOWY (1 SLOT) - domy≈õlny -->
        <div id="operator-standard-view">

            <!-- PANEL WYBORU KOPERTY -->
            <div id="machine-search-panel"
                style="background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%); border-radius: 15px; padding: 30px; margin-bottom: 25px; border: 2px solid #333; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                <h3 style="margin: 0 0 20px 0; color: var(--accent-blue); font-size: 1.8rem; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(41, 121, 255, 0.5);"
                    data-i18n="envelopeSelect">
                    üìã WYBIERZ KOPERTƒò DO PRACY</h3>

                <div class="operator-search-controls">
                    <!-- Pole do wpisania numeru -->
                    <div class="operator-search-input-wrap">
                        <label
                            style="color: #aaa; font-size: 0.95rem; display: block; margin-bottom: 8px; font-weight: 600; text-transform: uppercase;"
                            data-i18n="envelope_number_label">Numer
                            koperty
                            (RCS#wersja#nr):</label>
                        <input type="text" id="envelope-input"
                            style="width: 100%; background: #1a1a1a; border: 2px solid #444; color: #fff; font-size: 1.3rem; padding: 16px; border-radius: 10px; font-weight: 600; transition: all 0.3s;"
                            placeholder="np. 765432345#1.2#45" oninput="showOperatorSuggestions()">

                        <!-- Lista podpowiedzi -->
                        <div id="operator-hints" style="
                        position: absolute; top: 100%; left: 0; right: 0; 
                        background: #1a1a1a; border: 2px solid #555; border-radius: 0 0 10px 10px;
                        max-height: 400px; overflow-y: auto; z-index: 100; display: none;
                        box-shadow: 0 6px 20px rgba(0,0,0,0.7);">
                        </div>
                    </div>

                    <!-- Przyciski -->
                    <div class="operator-search-actions">
                        <button class="btn btn-blue operator-search-btn" onclick="loadEnvelope()"
                            data-i18n="btn_search">
                            üîç SZUKAJ
                        </button>
                        <button class="btn btn-green operator-search-btn" onclick="simulateScan('load')"
                            data-i18n="scan_btn">
                            üì° SKANUJ
                        </button>
                    </div>
                </div>

                <!-- Komunikat b≈Çƒôdu/sukcesu -->
                <div id="envelope-message"
                    style="margin-top: 15px; padding: 15px; border-radius: 10px; display: none; font-size: 1.1rem; font-weight: 600;">
                </div>
            </div>

            <!-- Current Task (mniejsza sekcja) -->
            <!-- Dynamiczny Panel Zadania -->
            <div id="machine-active-panel" class="current-task-card hidden"
                style="padding: 25px; margin-bottom: 25px; border: 2px solid var(--accent-orange); background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%); border-radius: 15px; box-shadow: 0 4px 20px rgba(255,145,0,0.3);">
                <!-- Tu trafi aktywna koperta -->
            </div>



            <div class="knowledge-section" id="knowledge-section"
                style="display: none; flex-direction: column; height: 400px;">

                <!-- G√ìRA: HISTORIA NOTATEK (przewijalna) -->
                <div id="historia-container"
                    style="flex: 1; min-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 18px; margin-bottom: 18px; border: 2px solid #333;">
                    <h4 style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px;"
                        data-i18n="history_log_title">
                        üìú HISTORIA WPIS√ìW
                    </h4>
                    <!-- Karty historii bƒôdƒÖ generowane przez JS -->
                </div>

                <!-- D√ì≈Å: NOWY WPIS (Formularz Cornell) - STANDARD -->
                <div id="standard-notes-form"
                    style="background: linear-gradient(135deg, rgba(255,145,0,0.15) 0%, rgba(255,145,0,0.05) 100%); padding: 20px; border-radius: 12px; border: 2px solid var(--accent-orange); box-shadow: 0 4px 15px rgba(255,145,0,0.2);">
                    <h4 style="margin: 0 0 18px 0; color: var(--accent-orange); font-size: 1.3rem; text-transform: uppercase; letter-spacing: 1.5px;"
                        data-i18n="new_entry_title">
                        ‚ûï NOWY WPIS</h4>

                    <div style="display: flex; gap: 18px; margin-bottom: 12px;">
                        <div style="flex: 0.8;">
                            <label style="color: #aaa; font-size: 0.9rem; font-weight: 600;" data-i18n="params_label">‚öôÔ∏è
                                PARAMETRY</label>
                            <textarea id="note-params"
                                style="width: 90%; height: 90px; background: rgba(0,0,0,0.5); border: 2px solid #555; border-radius: 10px; color: var(--accent-orange); padding: 12px; font-size: 1rem; resize: none; font-family: monospace; font-weight: 600;"
                                placeholder="Prƒôdko≈õƒá: 5000&#10;Fider: 30%" data-i18n="param_placeholder"></textarea>
                        </div>
                        <div style="flex: 1;">
                            <label style="color: #aaa; font-size: 0.9rem; font-weight: 600;"
                                data-i18n="attention_label">‚ö†Ô∏è UWAGI</label>
                            <textarea id="note-attention"
                                style="width: 90%; height: 90px; background: rgba(0,0,0,0.4); border: 2px solid #555; border-radius: 10px; color: #fff; padding: 12px; font-size: 1rem; resize: none;"
                                placeholder="Na co zwracaƒá uwagƒô..." data-i18n="notes_placeholder"></textarea>
                        </div>
                    </div>

                    <label style="color: #aaa; font-size: 0.9rem; font-weight: 600;" data-i18n="summary_label">üìã
                        PODSUMOWANIE</label>
                    <textarea id="note-summary"
                        style="width: 90%; height: 50px; background: rgba(0,0,0,0.4); border: 2px solid #555; border-radius: 10px; color: #fff; padding: 12px; font-size: 1rem; resize: none; margin-bottom: 15px;"
                        placeholder="Kr√≥tkie podsumowanie zmiany..." data-i18n="summary_placeholder"></textarea>

                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 12px;">
                        <button class="btn btn-blue" style="padding: 8px 14px; font-size: 0.9rem;"
                            onclick="openNoteImagePicker('standard')">üì∑ ZR√ìB ZDJƒòCIE</button>
                        <span style="color: #888; font-size: 0.8rem;">Maks. 3 zdjƒôcia / notatkƒô</span>
                        <input type="file" id="note-image-input-standard" accept="image/*" capture="environment"
                            style="display:none" onchange="handleNoteImageSelected('standard', this)">
                    </div>
                    <div id="note-images-standard" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom: 14px;">
                    </div>

                    <div style="display: flex; gap: 18px;">
                        <button class="btn btn-green" style="flex: 1; font-size: 1.2rem;" onclick="saveNote()"
                            data-i18n="save_board_btn">üíæ ZAPISZ
                            DO
                            TABLICY</button>
                        <button class="btn btn-orange" style="flex: 1; font-size: 1.2rem;"
                            onclick="finishOperatorWork()" data-i18n="finish_btn">ZAKO≈ÉCZ</button>
                    </div>
                </div>

                <!-- D√ì≈Å: NOWY WPIS (PALETYZACJA) - SPECJALNY -->
                <div id="palletizing-notes-form" class="hidden"
                    style="background: rgba(0, 100, 255, 0.1); padding: 15px; border-radius: 10px; border-top: 3px solid var(--accent-blue);">
                    <h4 style="margin: 0 0 15px 0; color: var(--accent-blue); font-size: 0.9rem;"
                        data-i18n="new_entry_pallet">‚ûï NOWY WPIS
                        (PALETYZACJA)</h4>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <label style="color: #888; font-size: 0.75rem;" data-i18n="pressure_label">‚öñÔ∏è NACISK
                                (BAR)</label>
                            <input type="text" id="pal-pressure"
                                style="width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #444; border-radius: 8px; color: #fff; padding: 8px;"
                                placeholder="np. 2.5">
                        </div>
                        <div>
                            <label style="color: #888; font-size: 0.75rem;" data-i18n="layers_label">üìö ILO≈öƒÜ
                                WARSTW</label>
                            <input type="number" id="pal-layers"
                                style="width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #444; border-radius: 8px; color: #fff; padding: 8px;"
                                placeholder="np. 5">
                        </div>
                        <div>
                            <label style="color: #888; font-size: 0.75rem;" data-i18n="pallet_type_label">üß± RODZAJ
                                PALETY</label>
                            <select id="pal-type"
                                style="width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #444; border-radius: 8px; color: #fff; padding: 8px;">
                                <option value="EURO" data-i18n="pallet_euro">EURO</option>
                                <option value="CHEP" data-i18n="pallet_chep">CHEP (Niebieska)</option>
                                <option value="PRZEM" data-i18n="pallet_industrial">PRZEMYS≈ÅOWA</option>
                                <option value="DHP" data-i18n="pallet_dhp">DHP</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: #888; font-size: 0.75rem;" data-i18n="packs_label">üì¶ ILE
                                PAKS√ìW</label>
                            <input type="number" id="pal-packs"
                                style="width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #444; border-radius: 8px; color: #fff; padding: 8px;"
                                placeholder="np. 50">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px; margin-bottom: 12px;">
                        <button class="btn btn-blue" style="padding: 8px 14px; font-size: 0.9rem;"
                            onclick="openNoteImagePicker('pallet')">üì∑ ZR√ìB ZDJƒòCIE</button>
                        <span style="color: #888; font-size: 0.8rem;">Maks. 3 zdjƒôcia / notatkƒô</span>
                        <input type="file" id="note-image-input-pallet" accept="image/*" capture="environment"
                            style="display:none" onchange="handleNoteImageSelected('pallet', this)">
                    </div>
                    <div id="note-images-pallet" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom: 14px;">
                    </div>

                    <div style="display: flex; gap: 15px;">
                        <button class="btn btn-green" style="flex: 1;" onclick="savePalletNote()"
                            data-i18n="save_settings">üíæ ZAPISZ
                            USTAWIENIA</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- Zamkniƒôcie operator-standard-view -->

    <!-- SKRYPT LOGIKI UI -->
    <script>
        const screens = {
            role: document.getElementById('screen-role'),

            warehouse: document.getElementById('screen-warehouse'),
            operator: document.getElementById('screen-operator'),
            machineSelect: document.getElementById('screen-machine-select'),
            pin: document.getElementById('screen-pin')
        };
        const navigationHistory = [];
        let currentScreenKey = 'role';
        // Globalny przycisk cofania sterowany historiƒÖ ekran√≥w

        // Domy≈õlna lista maszyn (fallback, gdy API niedostƒôpne)
        const DEFAULT_MACHINES = [
            'PRINTER MAIN', 'PRINTER 2', 'VISON', 'ETERNA', 'CUTER',
            'ST2', 'VERSOR', 'BOOBST 1', 'BOOBST 2', 'PALLETIZING'
        ];
        let MACHINES = [...DEFAULT_MACHINES];

        let selectedMachineName = "";

        // SYMULACJA SEMAFORA (STANU ZAJƒòTO≈öCI)
        // W prawdziwej aplikacji to przychodzi z serwera
        const lockedMachines = {};

        // --- LANGUAGE SUPPORT ---
        function toggleOperatorLanguage() {
            const newLang = currentLang === 'pl' ? 'en' : 'pl';
            setLanguage(newLang);

            const btn = document.getElementById('lang-toggle-btn');
            if (btn) {
                btn.innerText = 'üåê ' + (newLang === 'pl' ? 'EN' : 'PL');
            }
        }
        // Note: Most other elements (buttons, placeholders) are now handled globally by setLanguage 
        // because we added data-i18n attributes to them.

        // Helper function to get translated text (for use in alerts/confirms)


        function hideAll() {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
        }

        function updateBackButton() {
            const backBtn = document.getElementById('global-back-btn');
            if (!backBtn) return;
            const canGoBack = currentScreenKey !== 'role' && navigationHistory.length > 0;
            backBtn.classList.toggle('hidden', !canGoBack);
        }

        function navigateToScreen(screenKey, { recordHistory = true, clearHistory = false } = {}) {
            if (!screens[screenKey]) return;

            if (clearHistory) {
                navigationHistory.length = 0;
            }

            if (recordHistory && currentScreenKey && currentScreenKey !== screenKey) {
                navigationHistory.push(currentScreenKey);
                if (navigationHistory.length > 50) navigationHistory.shift();
            }

            hideAll();
            screens[screenKey].classList.remove('hidden');
            currentScreenKey = screenKey;
            updateBackButton();
            window.scrollTo(0, 0);
        }

        function goBack() {
            if (navigationHistory.length === 0) return;
            const previousScreen = navigationHistory.pop();
            navigateToScreen(previousScreen, { recordHistory: false });
        }

        updateBackButton();

        async function loadMachinesFromAPI() {
            try {
                const response = await fetch(`${API_BASE}/machines`);
                if (!response.ok) throw new Error('API error');

                const machines = await response.json();
                if (Array.isArray(machines) && machines.length > 0) {
                    MACHINES = machines.map(m => m.machine);
                    return;
                }
            } catch (error) {
                console.warn('B≈ÇƒÖd pobierania maszyn, u≈ºywam fallback:', error);
            }
            MACHINES = [...DEFAULT_MACHINES];
        }

        // Funkcja renderujƒÖca przyciski maszyn z uwzglƒôdnieniem statusu
        function renderMachineButtons() {
            const container = document.getElementById('machine-list-grid');
            if (!container) return;
            container.innerHTML = ''; // Clear

            MACHINES.forEach((name, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.style.fontSize = '0.9rem';

                const isLocked = lockedMachines[name];

                if (isLocked) {
                    // ZAJƒòTA
                    btn.innerHTML = `üîí ${index + 1}. ${name}<br><span style="font-size:0.7em; color:#ffaaaa">ZAJƒòTA</span>`;
                    btn.style.background = '#3e1a1a'; // Dark Red
                    btn.style.border = '1px solid #ff4444';
                    btn.style.opacity = '0.7';
                    btn.onclick = () => {
                        alert(`‚õî ODMOWA DOSTƒòPU\nMaszyna zajƒôta przez: ${isLocked}`);
                    };
                } else {
                    // WOLNA
                    btn.innerHTML = `${index + 1}. ${name}`;
                    btn.classList.add('btn-blue');
                    btn.onclick = () => selectMachine(name);
                }

                container.appendChild(btn);
            });
        }

        function showRoleSelection(options = {}) {
            const { recordHistory = false, clearHistory = true } = options;
            navigateToScreen('role', { recordHistory, clearHistory });
        }

        function showWarehouse(options = {}) {
            const { recordHistory = true } = options;
            navigateToScreen('warehouse', { recordHistory });

            // Domy≈õlnie poka≈º panel logowania na prawo
            document.getElementById('warehouse-login-view').classList.remove('hidden');
            document.getElementById('warehouse-ops-view').classList.add('hidden');
            document.getElementById('warehouse-pin-input').value = "";
            document.getElementById('warehouse-pin-error').style.opacity = "0";
        }

        async function showOperator(options = {}) {
            const { recordHistory = true } = options;
            await loadMachinesFromAPI();
            renderMachineButtons(); // Od≈õwie≈º widok przycisk√≥w
            navigateToScreen('machineSelect', { recordHistory });

            // Symulacja "≈ºywego" systemu - dodajmy kogo≈õ po chwili
            if (!lockedMachines['ETERNA']) {
                setTimeout(() => {
                    //lockedMachines['ETERNA'] = 'Tomek (Remote)';
                    //renderMachineButtons(); -- mo≈ºna odkomentowaƒá by zobaczyƒá live update
                }, 5000)
            }
        }

        function selectMachine(machineName, options = {}) {
            const { recordHistory = true } = options;
            selectedMachineName = machineName;
            // Przejd≈∫ do ekranu PIN zamiast od razu do operatora
            navigateToScreen('pin', { recordHistory });
            document.getElementById('pin-machine-name').innerText = machineName;
            document.getElementById('pin-input').value = "";
            document.getElementById('pin-error').style.opacity = "0";
        }

        // LOGIKA PIN
        function addPin(num) {
            const input = document.getElementById('pin-input');
            if (input.value.length < 4) input.value += num;
        }

        function clearPin() {
            document.getElementById('pin-input').value = "";
        }

        async function verifyPin() {
            const input = document.getElementById('pin-input').value;

            if (!input || input.length !== 4) {
                const err = document.getElementById('pin-error');
                err.style.opacity = "1";
                err.innerText = "Wprowad≈∫ 4-cyfrowy PIN!";
                setTimeout(() => err.style.opacity = "0", 3000);
                return;
            }

            try {
                // Weryfikuj PIN maszyny przez API
                const response = await fetch(`${API_BASE}/auth/machine-verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machine: selectedMachineName, pin: input })
                });

                const result = await response.json();

                if (response.ok && result.machine) {
                    const operatorName = selectedMachineName;
                    lockedMachines[selectedMachineName] = operatorName;

                    navigateToScreen('operator', { recordHistory: true });

                    // Ustaw dane na ekranie
                    document.querySelector('#screen-operator .op-header div div:first-child').innerText = operatorName.toUpperCase();
                    document.getElementById('lbl-machine-name').innerText = selectedMachineName;

                    // Uproszczony badge (operator logowany PIN-em maszyny)
                    const shiftBadge = document.getElementById('operator-shift-badge');
                    shiftBadge.removeAttribute('data-i18n');
                    shiftBadge.innerText = "PIN OK";

                    // Notes are loaded when envelope is loaded, not when machine is selected

                    // Pamiƒôtaj operatora
                    currentOperator = { machine: selectedMachineName };

                    // Odtw√≥rz stan maszyny z bazy danych (czy jest w trakcie produkcji?)
                    checkMachineState(selectedMachineName);

                    // OBS≈ÅUGA WIDOKU PALETYZACJI
                    if (selectedMachineName === 'PALLETIZING') {
                        document.getElementById('operator-palletizing-view').classList.remove('hidden');
                        document.getElementById('operator-standard-view').classList.add('hidden');

                        // Poka≈º formularz notatek dla paletyzacji
                        document.getElementById('palletizing-notes-form').classList.remove('hidden');
                        document.getElementById('standard-notes-form').classList.add('hidden');
                    } else {
                        document.getElementById('operator-palletizing-view').classList.add('hidden');
                        document.getElementById('operator-standard-view').classList.remove('hidden');

                        // Poka≈º formularz notatek standardowy
                        document.getElementById('palletizing-notes-form').classList.add('hidden');
                        document.getElementById('standard-notes-form').classList.remove('hidden');
                    }
                } else {
                    const err = document.getElementById('pin-error');
                    err.style.opacity = "1";
                    err.innerText = result.error || "NIEPRAWID≈ÅOWY PIN!";
                    setTimeout(() => err.style.opacity = "0", 3000);
                }
            } catch (error) {
                console.error('Error verifying PIN:', error);
                const err = document.getElementById('pin-error');
                err.style.opacity = "1";
                err.innerText = "B≈ÇƒÖd po≈ÇƒÖczenia z serwerem!";
                setTimeout(() => err.style.opacity = "0", 3000);
            }
        }

        async function savePalletNote() {
            const pressure = document.getElementById('pal-pressure').value;
            const layers = document.getElementById('pal-layers').value;
            const type = document.getElementById('pal-type').value;
            const packs = document.getElementById('pal-packs').value;
            const draftImages = noteDraftImages.pallet || [];

            if (!pressure && !layers && !packs && draftImages.length === 0) {
                alert(t('fill_pallet_params'));
                return;
            }

            const operator = document.querySelector('#screen-operator .op-header div div:first-child').innerText;

            if (!currentEnvelopeRCS) {
                alert(t('load_envelope_first'));
                return;
            }

            try {
                const created = await saveOperatorNoteAPI({
                    envelope_id: currentEnvelopeRCS,
                    machine_id: selectedMachineName,
                    note_kind: 'pallet',
                    note_data_json: {
                        pressure,
                        layers,
                        type,
                        packs,
                        summary: `Zapisano konfiguracjƒô dla palety: ${type}`
                    },
                    author: operator
                });

                await uploadDraftImagesForNote('operator_note', created.note_id, 'pallet', operator);
                await renderHistoria();
                alert(t('settings_saved'));
            } catch (error) {
                console.error('savePalletNote error:', error);
                alert(`B≈ÇƒÖd zapisu ustawie≈Ñ: ${error.message || error}`);
            }
        }

        function logout() {
            if (confirm("Czy na pewno chcesz siƒô wylogowaƒá i zwolniƒá maszynƒô?")) {
                // Zwolnij blokadƒô
                delete lockedMachines[selectedMachineName];

                alert(t('logout_success'));
                showOperator({ recordHistory: false }); // Wr√≥ƒá do wyboru maszyny
            }
        }

        function logoutToHome() {
            if (confirm("Czy na pewno chcesz siƒô wylogowaƒá i wr√≥ciƒá do menu g≈Ç√≥wnego?")) {
                delete lockedMachines[selectedMachineName];
                showRoleSelection({ recordHistory: false, clearHistory: true });
            }
        }

        // NOTATKI OPERATORA - backend + obrazy
        const NOTES_KEY = 'koperty_historia_rcs';
        const ENVELOPE_NOTES_KEY = 'koperty_envelope_notes';
        const NOTES_MIGRATION_KEY = 'notes_backend_migrated_v2';
        const noteDraftImages = { standard: [], pallet: [], 'slot-1': [], 'slot-2': [], 'slot-3': [], 'slot-4': [] };
        const noteImageMetaCache = {};
        const noteImageRenderContext = {};
        let currentEnvelopeRCS = null;

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const color = type === 'error' ? '#ff1744' : (type === 'success' ? '#00e676' : '#2979ff');
            toast.textContent = message;
            toast.style.cssText = `position:fixed;right:20px;bottom:20px;background:#111;border:1px solid ${color};color:#fff;padding:10px 14px;border-radius:8px;z-index:5000;box-shadow:0 8px 20px rgba(0,0,0,.45);`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        function cleanupLegacyNotesStorageOnce() {
            if (localStorage.getItem(NOTES_MIGRATION_KEY) === '1') return;
            localStorage.removeItem(NOTES_KEY);
            localStorage.removeItem(ENVELOPE_NOTES_KEY);
            localStorage.setItem(NOTES_MIGRATION_KEY, '1');
            showToast('Stare notatki lokalne zosta≈Çy wyczyszczone. System dzia≈Ça teraz na bazie serwera.', 'info');
        }

        cleanupLegacyNotesStorageOnce();
        ['standard', 'pallet', 'slot-1', 'slot-2', 'slot-3', 'slot-4'].forEach(renderDraftImages);

        function openNoteImagePicker(scope) {
            const input = document.getElementById(`note-image-input-${scope}`);
            if (input) input.click();
        }

        function _escapeHtml(text) {
            return String(text || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function renderDraftImages(scope) {
            const container = document.getElementById(`note-images-${scope}`);
            if (!container) return;
            const items = noteDraftImages[scope] || [];
            container.innerHTML = items.map((item, idx) => `
                <div style=\"position:relative;\">
                    <img src=\"${item.previewUrl}\" style=\"width:70px;height:70px;object-fit:cover;border:1px solid #555;border-radius:6px;cursor:pointer;\" onclick=\"editDraftNoteImage('${scope}', ${idx})\" title=\"Edytuj adnotacje\" />
                    <button onclick=\"removeDraftNoteImage('${scope}', ${idx})\" style=\"position:absolute;top:-7px;right:-7px;background:#442222;color:#fff;border:1px solid #733;border-radius:50%;width:20px;height:20px;cursor:pointer;\">√ó</button>
                </div>
            `).join('');
        }

        function removeDraftNoteImage(scope, index) {
            if (!noteDraftImages[scope] || !noteDraftImages[scope][index]) return;
            const item = noteDraftImages[scope][index];
            if (item.previewUrl && item.previewUrl.startsWith('blob:')) URL.revokeObjectURL(item.previewUrl);
            noteDraftImages[scope].splice(index, 1);
            renderDraftImages(scope);
        }

        async function editDraftNoteImage(scope, index) {
            const item = noteDraftImages[scope]?.[index];
            if (!item) return;
            await NoteImageEditor.open({
                title: 'Adnotacje zdjƒôcia',
                imageSource: item.compressedBlob,
                annotations: item.annotations_json,
                onSave: async (annotationsJson) => {
                    item.annotations_json = annotationsJson || { objects: [] };
                }
            });
        }

        async function handleNoteImageSelected(scope, inputEl) {
            try {
                const file = inputEl.files && inputEl.files[0];
                inputEl.value = '';
                if (!file) return;
                if (!file.type.startsWith('image/')) {
                    alert('Wybierz plik graficzny.');
                    return;
                }
                if (file.size > 10 * 1024 * 1024) {
                    alert('Maksymalny rozmiar pliku to 10MB.');
                    return;
                }
                if ((noteDraftImages[scope] || []).length >= 3) {
                    alert('Limit 3 zdjƒôƒá na notatkƒô.');
                    return;
                }

                const compressedBlob = await NoteImageEditor.compressImageFile(file, { maxDimension: 1600, quality: 0.82 });
                const previewUrl = URL.createObjectURL(compressedBlob);
                const draftItem = {
                    originalName: file.name,
                    compressedBlob,
                    previewUrl,
                    annotations_json: { version: 1, objects: [] }
                };
                noteDraftImages[scope].push(draftItem);
                renderDraftImages(scope);
                await editDraftNoteImage(scope, noteDraftImages[scope].length - 1);
            } catch (error) {
                console.error('Image pick error:', error);
                alert('Nie uda≈Ço siƒô dodaƒá zdjƒôcia.');
            }
        }

        async function uploadNoteImageAPI(noteScope, noteId, draftItem, uploadedBy, orderIndex) {
            const formData = new FormData();
            formData.append('file', draftItem.compressedBlob, `${Date.now()}.webp`);
            formData.append('note_scope', noteScope);
            formData.append('note_id', String(noteId));
            formData.append('annotations_json', JSON.stringify(draftItem.annotations_json || { objects: [] }));
            formData.append('order_index', String(orderIndex));
            formData.append('uploaded_by', uploadedBy || 'Nieznany');

            const response = await fetch(`${API_BASE}/note-images`, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (response.status === 429) {
                const retryAfter = response.headers.get('Retry-After');
                throw new Error(`Limit uploadu przekroczony. Spr√≥buj ponownie za ${retryAfter || 60}s.`);
            }
            if (response.status === 413) {
                throw new Error(result.error || 'Plik przekracza limit rozmiaru.');
            }
            if (!response.ok || !result.success) {
                throw new Error(result.error || `HTTP ${response.status}`);
            }
            return result.image;
        }

        async function updateNoteImageAnnotationsAPI(imageId, annotationsJson, modifiedBy, expectedRevision) {
            const response = await fetch(`${API_BASE}/note-images/${imageId}/annotations`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    annotations_json: annotationsJson || { objects: [] },
                    modified_by: modifiedBy || 'Nieznany',
                    expected_revision: expectedRevision
                })
            });
            const result = await response.json();
            if (response.status === 409) return { conflict: true, data: result };
            if (!response.ok || !result.success) throw new Error(result.error || `HTTP ${response.status}`);
            return { conflict: false, data: result };
        }

        async function getSignedImageUrl(imageId) {
            const response = await fetch(`${API_BASE}/note-images/${imageId}/signed-url`);
            const result = await response.json();
            if (!response.ok || !result.success) throw new Error(result.error || `HTTP ${response.status}`);
            return result.url;
        }

        async function deleteNoteImageAPI(imageId) {
            const response = await fetch(`${API_BASE}/note-images/${imageId}`, { method: 'DELETE' });
            const result = await response.json();
            if (!response.ok || !result.success) throw new Error(result.error || `HTTP ${response.status}`);
            return true;
        }

        function _renderStoredImagesHtml(images, context) {
            if (!images || images.length === 0) return '';
            return `<div style=\"display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;\">${images.map((img) => {
                noteImageMetaCache[img.id] = img;
                noteImageRenderContext[img.id] = context;
                const src = _escapeHtml(img.signed_url || '');
                return `
                    <div style=\"position:relative;\">
                        <img src=\"${src}\" style=\"width:72px;height:72px;object-fit:cover;border:1px solid #444;border-radius:6px;cursor:pointer;\" onclick=\"editExistingNoteImage(${img.id})\" title=\"Edytuj adnotacje\" />
                        <button onclick=\"deleteExistingNoteImage(${img.id})\" style=\"position:absolute;top:-7px;right:-7px;background:#442222;color:#fff;border:1px solid #733;border-radius:50%;width:20px;height:20px;cursor:pointer;\">√ó</button>
                    </div>
                `;
            }).join('')}</div>`;
        }

        async function editExistingNoteImage(imageId) {
            try {
                const imageMeta = noteImageMetaCache[imageId];
                if (!imageMeta) return;
                const signedUrl = await getSignedImageUrl(imageId);
                const operator = document.querySelector('#screen-operator .op-header div div:first-child')?.innerText || 'Nieznany';
                await NoteImageEditor.open({
                    title: 'Edycja adnotacji',
                    imageSource: signedUrl,
                    annotations: imageMeta.annotations_json || { objects: [] },
                    onSave: async (annotationsJson) => {
                        const updateResult = await updateNoteImageAnnotationsAPI(
                            imageId,
                            annotationsJson,
                            operator,
                            imageMeta.revision
                        );
                        if (updateResult.conflict) {
                            showToast('Zdjƒôcie zosta≈Ço zmienione przez innego u≈ºytkownika. Od≈õwie≈º widok i spr√≥buj ponownie.', 'error');
                            await refreshNoteImageContext(imageId);
                            throw new Error('Conflict');
                        }
                        noteImageMetaCache[imageId] = updateResult.data.image;
                        await refreshNoteImageContext(imageId);
                    }
                });
            } catch (error) {
                console.error('editExistingNoteImage error:', error);
            }
        }

        async function deleteExistingNoteImage(imageId) {
            if (!confirm('UsunƒÖƒá zdjƒôcie z notatki?')) return;
            try {
                await deleteNoteImageAPI(imageId);
                delete noteImageMetaCache[imageId];
                await refreshNoteImageContext(imageId);
            } catch (error) {
                alert(`Nie uda≈Ço siƒô usunƒÖƒá zdjƒôcia: ${error.message || error}`);
            }
        }

        async function refreshNoteImageContext(imageId) {
            const ctx = noteImageRenderContext[imageId];
            if (!ctx) return;
            if (ctx.type === 'history') {
                await renderHistoria();
            } else if (ctx.type === 'slot' && ctx.slotId) {
                slotProductNotes[ctx.slotId] = null;
                await renderSlotHistory(ctx.slotId);
            }
        }

        async function saveOperatorNoteAPI(payload) {
            const response = await fetch(`${API_BASE}/operator-notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok || !result.success) throw new Error(result.error || `HTTP ${response.status}`);
            return result;
        }

        async function getOperatorNotesAPI(envelopeId, machineId, limit = 20, cursor = null) {
            let url = `${API_BASE}/operator-notes/${encodeURIComponent(envelopeId)}?machine_id=${encodeURIComponent(machineId)}&limit=${limit}`;
            if (cursor) url += `&cursor=${encodeURIComponent(cursor)}`;
            const response = await fetch(url);
            const result = await response.json();
            if (!response.ok || !result.success) throw new Error(result.error || `HTTP ${response.status}`);
            return result;
        }

        async function getAllOperatorNotesAPI(envelopeId, machineId, pageSize = 20, maxPages = 10) {
            let cursor = null;
            const allNotes = [];
            for (let page = 0; page < maxPages; page += 1) {
                const pageResult = await getOperatorNotesAPI(envelopeId, machineId, pageSize, cursor);
                const chunk = pageResult.notes || [];
                allNotes.push(...chunk);
                if (!pageResult.next_cursor) break;
                cursor = pageResult.next_cursor;
            }
            return allNotes;
        }

        async function uploadDraftImagesForNote(noteScope, noteId, draftScope, uploadedBy) {
            const drafts = noteDraftImages[draftScope] || [];
            for (let i = 0; i < drafts.length; i += 1) {
                await uploadNoteImageAPI(noteScope, noteId, drafts[i], uploadedBy, i);
                if (drafts[i].previewUrl && drafts[i].previewUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(drafts[i].previewUrl);
                }
            }
            noteDraftImages[draftScope] = [];
            renderDraftImages(draftScope);
        }

        async function saveNote() {
            const params = document.getElementById('note-params').value;
            const attention = document.getElementById('note-attention').value;
            const summary = document.getElementById('note-summary').value;
            const draftImages = noteDraftImages.standard || [];

            if (!currentEnvelopeRCS) {
                alert(t('load_envelope_first'));
                return;
            }

            if (!params && !attention && !summary && draftImages.length === 0) {
                alert(t('fill_one_field'));
                return;
            }

            try {
                const operator = document.querySelector('#screen-operator .op-header div div:first-child')?.innerText?.trim() || selectedMachineName || 'Nieznany';
                const created = await saveOperatorNoteAPI({
                    envelope_id: currentEnvelopeRCS,
                    machine_id: selectedMachineName,
                    note_kind: 'standard',
                    note_data_json: {
                        params,
                        attention,
                        summary
                    },
                    author: operator
                });

                await uploadDraftImagesForNote('operator_note', created.note_id, 'standard', operator);
                document.getElementById('note-params').value = '';
                document.getElementById('note-attention').value = '';
                document.getElementById('note-summary').value = '';
                await renderHistoria();
                alert(t('note_saved'));
            } catch (error) {
                console.error('saveNote error:', error);
                alert(`B≈ÇƒÖd zapisu notatki: ${error.message || error}`);
            }
        }

        async function renderHistoria() {
            const kontener = document.getElementById('historia-container');
            if (!kontener) return;

            kontener.innerHTML = `<h4 style=\"margin: 0 0 10px 0; color: var(--text-secondary); font-size: 0.85rem;\">üìú ${t('historyTitle')}</h4><p style=\"color:#666;\">≈Åadowanie...</p>`;
            if (!currentEnvelopeRCS || !selectedMachineName) {
                kontener.innerHTML = `<h4 style=\"margin: 0 0 10px 0; color: var(--text-secondary); font-size: 0.85rem;\">üìú ${t('historyTitle')}</h4><p style=\"color: #666; font-style: italic;\">${t('noEntries')}</p>`;
                return;
            }

            try {
                const historia = await getAllOperatorNotesAPI(currentEnvelopeRCS, selectedMachineName, 20, 15);
                kontener.innerHTML = `<h4 style=\"margin: 0 0 10px 0; color: var(--text-secondary); font-size: 0.85rem;\">üìú ${t('historyTitle')} (${historia.length})</h4>`;

                if (historia.length === 0) {
                    kontener.innerHTML += `<p style=\"color: #666; font-style: italic;\">${t('noEntries')}</p>`;
                    return;
                }

                historia.forEach((notatka) => {
                    const noteData = notatka.note_data || {};
                    let params = noteData.params || '-';
                    let attention = noteData.attention || '-';
                    let summary = noteData.summary || '-';

                    if (notatka.note_kind === 'pallet') {
                        params = `NACISK: ${noteData.pressure || '-'} BAR\\nWARSTWY: ${noteData.layers || '-'}\\nPALETA: ${noteData.type || '-'}\\nPAKSY: ${noteData.packs || '-'}`;
                        attention = 'USTAWIENIA PALETYZACJI';
                        summary = noteData.summary || 'Zapisano ustawienia paletyzacji';
                    }

                    const karta = `
                        <div style=\"background: #252525; border-left: 4px solid var(--accent-orange); padding: 12px; margin-bottom: 10px; border-radius: 8px;\">
                            <div style=\"display: flex; justify-content: space-between; margin-bottom: 8px;\">
                                <span style=\"color: var(--accent-blue); font-weight: bold;\">üë§ ${_escapeHtml(notatka.created_by || 'Nieznany')}</span>
                                <span style=\"color: #666; font-size: 0.8rem;\">üìÖ ${_escapeHtml(notatka.created_at || '')}</span>
                            </div>
                            <div style=\"display: flex; gap: 15px; font-size: 0.85rem;\">
                                <div style=\"flex: 0.8; color: var(--accent-orange); font-family: monospace; white-space: pre-wrap;\">${_escapeHtml(params)}</div>
                                <div style=\"flex: 1; color: #ccc; white-space: pre-wrap;\">${_escapeHtml(attention)}</div>
                            </div>
                            <div style=\"margin-top: 8px; padding-top: 8px; border-top: 1px solid #333; color: #aaa; font-size: 0.85rem; white-space: pre-wrap;\">
                                üìã ${_escapeHtml(summary)}
                            </div>
                            ${_renderStoredImagesHtml(notatka.images || [], { type: 'history' })}
                        </div>
                    `;
                    kontener.innerHTML += karta;
                });
            } catch (error) {
                kontener.innerHTML = `<h4 style=\"margin: 0 0 10px 0; color: var(--text-secondary); font-size: 0.85rem;\">üìú ${t('historyTitle')}</h4><p style=\"color:#ff6666;\">B≈ÇƒÖd pobierania historii notatek.</p>`;
            }
        }

        async function loadNotesForEnvelope(rcsNumber) {
            currentEnvelopeRCS = rcsNumber;
            const ks = document.getElementById('knowledge-section');
            if (ks) ks.style.display = 'flex';
            await renderHistoria();
        }

        function hideNotesSection() {
            currentEnvelopeRCS = null;
            const ks = document.getElementById('knowledge-section');
            if (ks) ks.style.display = 'none';

            const kontener = document.getElementById('historia-container');
            if (kontener) {
                kontener.innerHTML = `
                    <h4 style="margin: 0 0 10px 0; color: var(--text-secondary); font-size: 0.85rem;">üìú ${t('historyTitle')}</h4>
                    <p style="color:#888; margin:0;">Za≈Çaduj kopertƒô, aby zobaczyƒá historiƒô. Przycisk "üì∑ ZR√ìB ZDJƒòCIE" jest dostƒôpny poni≈ºej.</p>
                `;
            }
        }

        // --- LOGIKA MAGAZYNIERA ---

        // KONFIGURACJA API
        // Je≈õli otwarte z dysku (file://) u≈ºyj localhost, w przeciwnym razie (http://) u≈ºyj relatywnej ≈õcie≈ºki
        // Auto-detect API location (Improved for LAN/LiveServer)
        let apiBase = '/api';
        const loc = window.location;
        const host = loc.hostname;
        const port = loc.port;

        if (loc.protocol === 'file:') {
            // Opened as file -> localhost
            apiBase = 'http://localhost:5000/api';
        } else if (port && port !== '5000' && port !== '') {
            // Served on a specific port (e.g. 5500 LiveServer)
            // Assume backend is on the SAME host but port 5000
            apiBase = `${loc.protocol}//${host}:5000/api`;
        }
        // else: running on port 5000 or standard port 80/443 (empty port) -> use relative /api

        const API_BASE = apiBase;
        console.log('üîó API Base set to:', API_BASE);

        // Lokalna kopia bazy kopert (synchronizowana z API)
        let ENVELOPES_DB = [];

        // Inicjalizacja: pobierz koperty z API przy starcie
        async function initEnvelopesFromAPI() {
            try {
                const response = await fetch(`${API_BASE}/envelopes?limit=50`);
                if (response.ok) {
                    const result = await response.json();
                    ENVELOPES_DB = result.data || [];
                    console.log('‚úÖ Pobrano koperty z API (pierwsza strona):', ENVELOPES_DB.length);
                } else {
                    console.warn('‚ö†Ô∏è API niedostƒôpne, u≈ºywam lokalnych danych demo');
                    ENVELOPES_DB = getLocalDemoEnvelopes();
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è B≈ÇƒÖd po≈ÇƒÖczenia z API:', error.message);
                ENVELOPES_DB = getLocalDemoEnvelopes();
            }
        }

        function getLocalDemoEnvelopes() {
            return [
                { id: "765432345#1.2#45", product: "KOPERTA C5 BIA≈ÅA", status: "MAGAZYN", location: "Sekcja A", machine: null },
                { id: "111222333#1.0#01", product: "KOPERTA DL STANDARD", status: "MAGAZYN", location: "Sekcja A", machine: null },
                { id: "333444555#1.3#08", product: "KOPERTA C4 BIA≈ÅA", status: "W_PRODUKCJI", location: null, machine: "BOOBST 1" },
            ];
        }

        // Wywo≈Çaj inicjalizacjƒô przy starcie
        initEnvelopesFromAPI();

        // Funkcja do pobierania aktualnego statusu koperty z API
        async function fetchEnvelopeStatus(envelopeId) {
            try {
                const response = await fetch(`${API_BASE}/envelopes/${encodeURIComponent(envelopeId)}/status`);
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.warn('B≈ÇƒÖd pobierania statusu:', error);
            }
            // Fallback do lokalnej bazy
            return ENVELOPES_DB.find(e => e.id === envelopeId);
        }

        // Funkcja do wyszukiwania kopert przez API
        async function searchEnvelopesAPI(query, status = null) {
            try {
                let url = `${API_BASE}/envelopes/search?q=${encodeURIComponent(query)}`;
                if (status) {
                    url += `&status=${encodeURIComponent(status)}`;
                }
                const response = await fetch(url);
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.warn('B≈ÇƒÖd wyszukiwania API:', error);
            }
            // Fallback do lokalnej bazy
            let results = ENVELOPES_DB.filter(e => e.id.includes(query));
            if (status) {
                results = results.filter(e => e.status === status);
            }
            return results;
        }

        // Funkcja do za≈Çadowania koperty na maszynƒô (API)
        async function loadEnvelopeAPI(envelopeId, machineName) {
            try {
                const response = await fetch(`${API_BASE}/envelopes/${encodeURIComponent(envelopeId)}/load`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machine: machineName, operator_id: machineName })
                });
                const data = await response.json();
                if (response.ok) {
                    // Aktualizuj lokalnƒÖ bazƒô
                    const env = ENVELOPES_DB.find(e => e.id === envelopeId);
                    if (env) {
                        env.status = 'W_PRODUKCJI';
                        env.machine = machineName;
                        env.location = null;
                    }
                    return { success: true, data };
                } else {
                    return { success: false, error: data.error, machine: data.machine };
                }
            } catch (error) {
                console.warn('B≈ÇƒÖd API load:', error);
                // Fallback - aktualizuj lokalnie
                const env = ENVELOPES_DB.find(e => e.id === envelopeId);
                if (env) {
                    env.status = 'W_PRODUKCJI';
                    env.machine = machineName;
                }
                return { success: true };
            }
        }

        // Funkcja do zwolnienia koperty (API)
        async function releaseEnvelopeAPI(envelopeId, location) {
            try {
                const response = await fetch(`${API_BASE}/envelopes/${encodeURIComponent(envelopeId)}/release`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ location: location || 'Nieprzypisana' })
                });
                if (response.ok) {
                    const result = await response.json();
                    // Aktualizuj lokalnƒÖ bazƒô
                    const env = ENVELOPES_DB.find(e => e.id === envelopeId);
                    if (env) {
                        env.status = result.status;
                        env.machine = result.machine;
                        env.location = result.location;
                    }
                    return true;
                }
            } catch (error) {
                console.warn('B≈ÇƒÖd API release:', error);
                return false;
            }
        }

        // ========================
        // NOWE: NOTATKI PRODUKT + MASZYNA (API)
        // ========================
        // WALIDACJA FORMATU RCS
        // ========================

        /**
         * Waliduje format kodu RCS.
         * Format: opcjonalnie "RCS" + 6 cyfr + opcjonalnie ("/" + max 2 litery)
         * Przyk≈Çady poprawne: 123456, RCS123456, 123456/A, RCS123456/AB
         */
        function validateRCSFormat(code) {
            // Pattern: optional "RCS" + 6 digits + optional ("/" + 0-2 letters)
            const rcsPattern = /^(RCS)?[0-9]{6}(\/[A-Za-z]{0,2})?$/i;

            if (!code || !code.trim()) {
                return {
                    valid: false,
                    error: "Kod RCS nie mo≈ºe byƒá pusty"
                };
            }

            const cleanCode = code.trim().toUpperCase();

            if (!rcsPattern.test(cleanCode)) {
                return {
                    valid: false,
                    error: "Nieprawid≈Çowy format kodu RCS!\n\nWymagany format: opcjonalnie \"RCS\" + 6 cyfr + opcjonalnie \"/\" + max 2 litery\nPrzyk≈Çad: RCS123456/AB lub 123456/A"
                };
            }

            return {
                valid: true,
                code: cleanCode
            };
        }

        // ========================

        /**
         * Wydobywa kod produktu z ID koperty.
         * Np. '333444555#1.3#08' -> '333444555#1.3'
         */
        function getProductCode(envelopeId) {
            const parts = envelopeId.split('#');
            if (parts.length >= 2) {
                return `${parts[0]}#${parts[1]}`;
            }
            return envelopeId;
        }

        /**
         * Pobiera notatkƒô dla pary produkt+maszyna z API.
         */
        async function getProductMachineNoteAPI(productCode, machineId) {
            try {
                const response = await fetch(`${API_BASE}/product-notes/${encodeURIComponent(productCode)}/${encodeURIComponent(machineId)}`);
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.warn('B≈ÇƒÖd pobierania notatki:', error);
            }
            return { specific_note: null, global_note: null };
        }

        /**
         * Zapisuje notatkƒô dla pary produkt+maszyna do API.
         */
        async function saveProductMachineNoteAPI(productCode, machineId, content, user) {
            try {
                console.log('Wywo≈Çujƒô API:', `${API_BASE}/product-notes/${encodeURIComponent(productCode)}/${encodeURIComponent(machineId)}`);

                const response = await fetch(`${API_BASE}/product-notes/${encodeURIComponent(productCode)}/${encodeURIComponent(machineId)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        user: user,
                        note_type: 'specific'
                    })
                });

                console.log('Status odpowiedzi:', response.status, response.statusText);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Odpowied≈∫ API:', result);
                    return result;
                } else {
                    const errorText = await response.text();
                    console.error('B≈ÇƒÖd API:', response.status, errorText);
                    return { success: false, error: `HTTP ${response.status}: ${errorText}` };
                }
            } catch (error) {
                console.error('B≈ÇƒÖd zapisywania notatki:', error);
                return { success: false, error: error.message };
            }
        }

        // Przechowywanie aktualnych notatek dla slot√≥w (cache)
        const slotProductNotes = { 1: null, 2: null, 3: null, 4: null };

        let currentEnvelope = null;

        // Funkcja autouzupe≈Çniania dla operatora (u≈ºywa API)
        async function showOperatorSuggestions() {
            const input = document.getElementById('envelope-input');
            const hintsContainer = document.getElementById('operator-hints');
            const query = input.value.trim();

            if (query.length < 2) {
                hintsContainer.style.display = 'none';
                return;
            }

            // Pobierz z API (≈õwie≈ºe dane z bazy)
            let matches = await searchEnvelopesAPI(query);

            console.log(`üîç Search query: "${query}", Raw matches:`, matches.length);

            matches = matches.filter(e => {
                const loc = e.location ? String(e.location).trim().toUpperCase() : '';
                const stat = e.status ? String(e.status).trim().toUpperCase() : '';

                const allowedValues = ['CART-OUT-01', 'CART-RET-05', 'SHOP_FLOOR', 'SHOP FLOOR'];

                // Check if Location OR Status matches allowed values
                const isLocValid = loc && allowedValues.some(allowed => loc.includes(allowed));
                const isStatValid = stat && allowedValues.some(allowed => stat.includes(allowed));

                const isProduction = stat === 'W_PRODUKCJI';

                return isLocValid || isStatValid || isProduction;
            });

            if (matches.length === 0) {
                hintsContainer.style.display = 'none';
                return;
            }

            // Generuj listƒô
            hintsContainer.innerHTML = matches.map(e => `
                <div style="padding: 10px; border-bottom: 1px solid #444; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                     onclick="selectEnvelope('${e.id}')"
                     onmouseover="this.style.background='#444'"
                     onmouseout="this.style.background='transparent'">
                    <div>
                        <div style="color: #fff; font-weight: bold;">${e.id}</div>
                        <div style="color: #888; font-size: 0.8rem;">${e.product}</div>
                    </div>
                    <div style="font-size: 0.8rem; color: ${e.status === 'MAGAZYN' ? '#66ff66' : '#ff6666'}">
                        ${e.status === 'MAGAZYN' ? 'MAGAZYN' : (e.machine ? `‚öôÔ∏è ${e.machine}` : 'ZAJƒòTA')}
                    </div>
                </div>
            `).join('');

            hintsContainer.style.display = 'block';
        }

        // Funkcja zako≈Ñczenia pracy operatora - resetuje ekran i zwalnia kopertƒô
        async function finishOperatorWork() {
            if (!currentEnvelope) {
                alert(t('no_active_envelope_finish'));
                return;
            }

            if (!confirm(`${t('finishConfirm')} ${currentEnvelope.id}?\n${t('finishConfirm2')}`)) {
                return;
            }

            // Zwolnij kopertƒô przez API (wr√≥ƒá do magazynu)
            const result = await releaseEnvelopeAPI(currentEnvelope.id, 'Sekcja A');

            if (result && result.success) {
                console.log(`‚úÖ Koperta ${currentEnvelope.id} zwolniona`);
            } else {
                console.warn('‚ö†Ô∏è B≈ÇƒÖd zwalniania koperty przez API');
            }

            // Resetuj UI karty zadania
            document.querySelector('.task-info h1').innerText = 'WYBIERZ KOPERTƒò';
            document.querySelector('.task-info p').innerText = '‚óè OCZEKIWANIE';
            document.querySelector('.task-info div').innerText = 'RCS: ---';

            // Wyczy≈õƒá pole wyszukiwania
            document.getElementById('envelope-input').value = '';

            // Resetuj zmiennƒÖ
            currentEnvelope = null;
            hideNotesSection();

            // Od≈õwie≈º lokalnƒÖ bazƒô kopert
            await initEnvelopesFromAPI();

            alert(t('workFinished'));
        }

        function selectEnvelope(id) {
            const input = document.getElementById('envelope-input');
            const hintsContainer = document.getElementById('operator-hints');

            input.value = id;
            hintsContainer.style.display = 'none';

            // Automatycznie za≈Çaduj po wyborze
            loadEnvelope();
        }

        // --- OBS≈ÅUGA SLOT√ìW PALETYZACJI ---

        // ≈öledzenie za≈Çadowanych kopert w slotach
        const slotEnvelopes = { 1: null, 2: null, 3: null, 4: null };

        async function saveSlotNote(slotId) {
            // WALIDACJA: Sprawd≈∫ czy slot ma za≈ÇadowanƒÖ kopertƒô
            if (!slotEnvelopes[slotId]) {
                alert(t('load_envelope_first'));
                return;
            }

            const noteInput = document.getElementById('slot-note-' + slotId);
            const noteText = noteInput.value.trim();
            const draftScope = `slot-${slotId}`;
            const draftImages = noteDraftImages[draftScope] || [];

            if (!noteText && draftImages.length === 0) {
                alert(t('enter_note_content'));
                return;
            }

            // Pobierz nazwƒô operatora
            const operatorEl = document.querySelector('#screen-operator .op-header div div:first-child');
            if (!operatorEl) {
                console.error('Nie znaleziono elementu z nazwƒÖ operatora');
                alert(t('error_operator_name'));
                return;
            }
            const operator = operatorEl.innerText;

            const envelope = slotEnvelopes[slotId];
            const envelopeId = envelope.id;

            // WydobƒÖd≈∫ kod produktu (bez numeru kopii)
            const productCode = getProductCode(envelopeId);

            // Pobierz nazwƒô maszyny ze slotu (PALLETIZING lub z kontekstu)
            const machineId = 'PALLETIZING';  // Lub pobierz z kontekstu

            console.log('Zapisujƒô notatkƒô:', { productCode, machineId, noteText, operator, images: draftImages.length });

            // Zapisz do bazy SQL przez API
            const result = await saveProductMachineNoteAPI(productCode, machineId, noteText, operator);

            console.log('Wynik zapisu:', result);

            if (result.success) {
                // Wyczy≈õƒá input
                noteInput.value = '';
                if (result.note_id && draftImages.length > 0) {
                    await uploadDraftImagesForNote('product_machine_note', result.note_id, draftScope, operator);
                }
                slotProductNotes[slotId] = null;

                // Od≈õwie≈º widok
                await renderSlotHistory(slotId);

                console.log(`Notatka zapisana: produkt=${productCode}, maszyna=${machineId}`);

                // Poka≈º komunikat sukcesu
                alert(t('note_saved'));
            } else {
                console.error('B≈ÇƒÖd zapisu notatki:', result);
                alert(t('error_note_save'));
            }
        }

        async function renderSlotHistory(slotId) {
            const container = document.getElementById('slot-history-' + slotId);
            if (!container) return;

            const envelope = slotEnvelopes[slotId];

            // Je≈õli nie ma koperty, poka≈º pusty stan
            if (!envelope) {
                container.innerHTML = '<div style="color: #555; font-size: 0.75rem; text-align: center;">Za≈Çaduj kopertƒô</div>';
                return;
            }

            // WydobƒÖd≈∫ kod produktu
            const productCode = getProductCode(envelope.id);
            const machineId = 'PALLETIZING';

            // Pobierz notatkƒô z API (lub u≈ºyj cache)
            let noteData = slotProductNotes[slotId];
            if (!noteData) {
                noteData = await getProductMachineNoteAPI(productCode, machineId);
                slotProductNotes[slotId] = noteData;
            }

            let html = '';

            // Wy≈õwietl notatkƒô specyficznƒÖ dla maszyny
            if (noteData.specific_note && (noteData.specific_note.content || (noteData.specific_note.images || []).length > 0)) {
                const note = noteData.specific_note;
                const modDate = note.modified_at ? new Date(note.modified_at).toLocaleString('pl-PL') : '';
                html += `
                    <div style="background: rgba(0,230,118,0.15); padding: 8px; margin-bottom: 6px; border-radius: 6px; border-left: 3px solid var(--accent-green);">
                        <div style="color: #888; font-size: 0.7rem; margin-bottom: 4px;">
                            üìù NOTATKA DLA TEJ MASZYNY
                        </div>
                        <div style="color: #fff; font-size: 0.85rem; white-space: pre-wrap;">${note.content}</div>
                        <div style="color: #666; font-size: 0.65rem; margin-top: 4px;">
                            ${note.modified_by ? `${note.modified_by} ‚Ä¢ ` : ''}${modDate}
                        </div>
                        ${_renderStoredImagesHtml(note.images || [], { type: 'slot', slotId })}
                    </div>
                `;
            }

            // Wy≈õwietl notatkƒô globalnƒÖ (je≈õli istnieje i jest inna ni≈º specyficzna)
            if (noteData.global_note && (noteData.global_note.content || (noteData.global_note.images || []).length > 0)) {
                const note = noteData.global_note;
                const modDate = note.modified_at ? new Date(note.modified_at).toLocaleString('pl-PL') : '';
                html += `
                    <div style="background: rgba(255,152,0,0.15); padding: 8px; margin-bottom: 6px; border-radius: 6px; border-left: 3px solid #ff9800;">
                        <div style="color: #ff9800; font-size: 0.7rem; margin-bottom: 4px;">
                            üåê NOTATKA GLOBALNA (wszystkie maszyny)
                        </div>
                        <div style="color: #fff; font-size: 0.85rem; white-space: pre-wrap;">${note.content}</div>
                        <div style="color: #666; font-size: 0.65rem; margin-top: 4px;">
                            ${note.modified_by ? `${note.modified_by} ‚Ä¢ ` : ''}${modDate}
                        </div>
                        ${_renderStoredImagesHtml(note.images || [], { type: 'slot', slotId })}
                    </div>
                `;
            }

            // Je≈õli brak notatek
            if (!html) {
                html = `
                    <div style="color: #555; font-size: 0.75rem; text-align: center; padding: 20px;">
                        Brak notatek dla produktu <strong>${productCode}</strong><br>
                        <span style="font-size: 0.65rem;">(wpisz notatkƒô i naci≈õnij üíæ)</span>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Funkcja autouzupe≈Çniania dla slot√≥w paletyzacji
        async function showSlotSuggestions(slotId) {
            const input = document.getElementById('slot-input-' + slotId);
            const hintsContainer = document.getElementById('slot-hints-' + slotId);
            const query = input.value.trim();

            if (query.length < 2) {
                hintsContainer.style.display = 'none';
                return;
            }

            // Pobierz z API (≈õwie≈ºe dane z bazy)
            const matches = await searchEnvelopesAPI(query);

            if (matches.length === 0) {
                hintsContainer.style.display = 'none';
                return;
            }

            // Generuj listƒô
            hintsContainer.innerHTML = matches.map(e => `
                <div style="padding: 8px; border-bottom: 1px solid #444; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;"
                     onclick="selectSlotEnvelope(${slotId}, '${e.id}')"
                     onmouseover="this.style.background='#444'"
                     onmouseout="this.style.background='transparent'">
                    <div>
                        <div style="color: #fff; font-weight: bold;">${e.id}</div>
                        <div style="color: #888; font-size: 0.75rem;">${e.product}</div>
                    </div>
                    <div style="font-size: 0.75rem; color: ${e.status === 'MAGAZYN' ? '#66ff66' : '#ff6666'}">
                        ${e.status === 'MAGAZYN' ? 'MAGAZYN' : (e.machine ? `‚öôÔ∏è ${e.machine}` : 'ZAJƒòTA')}
                    </div>
                </div>
            `).join('');

            hintsContainer.style.display = 'block';
        }

        function selectSlotEnvelope(slotId, id) {
            const input = document.getElementById('slot-input-' + slotId);
            const hintsContainer = document.getElementById('slot-hints-' + slotId);

            input.value = id;
            hintsContainer.style.display = 'none';

            // Automatycznie za≈Çaduj po wyborze
            loadEnvelopeForSlot(slotId);
        }

        async function loadEnvelopeForSlot(slotId) {
            const inputId = 'slot-input-' + slotId;
            const input = document.getElementById(inputId);
            const val = input.value.trim();
            const slot = document.getElementById('slot-' + slotId);
            const content = slot.querySelector('.slot-content');

            if (!val) {
                alert(t('enter_envelope_number'));
                return;
            }

            // VALIDATE RCS FORMAT
            const validation = validateRCSFormat(val);
            if (!validation.valid) {
                alert(`‚ùå ${validation.error}`);
                input.focus();
                return;
            }

            const validatedCode = validation.code;

            // Szukaj w bazie (najpierw lokalnie, potem od≈õwie≈º z API)
            let envelope = ENVELOPES_DB.find(e => e.id === validatedCode);

            // Pobierz aktualny status z API
            const apiStatus = await fetchEnvelopeStatus(validatedCode);
            if (apiStatus) {
                envelope = apiStatus;
            }

            if (!envelope) {
                alert(t('envelope_not_found_db'));
                return;
            }

            // VALIDATE LOCATION FOR OPERATOR (Start 1.4 requirement)
            const allowedValues = ['CART-OUT-01', 'CART-RET-05', 'SHOP_FLOOR', 'SHOP FLOOR'];
            const eLoc = envelope.location ? String(envelope.location).trim().toUpperCase() : '';
            const eStat = envelope.status ? String(envelope.status).trim().toUpperCase() : '';

            const isLocValid = eLoc && allowedValues.some(allowed => eLoc.includes(allowed));
            const isStatValid = eStat && allowedValues.some(allowed => eStat.includes(allowed));
            const isProduction = eStat === 'W_PRODUKCJI';

            if (!isLocValid && !isStatValid && !isProduction) {
                console.warn(`‚õî Blocked loading ${envelope.id}: Loc='${eLoc}', Stat='${eStat}'`);
                // Show debug info in alert
                alert(`${t('envelope_location_error')} (Loc: ${eLoc}, Stat: ${eStat})`);
                return;
            }

            // --- AKTUALIZUJ BAZƒò SQL PRZEZ API ---
            const result = await loadEnvelopeAPI(validatedCode, 'PALLETIZING');
            if (!result.success) {
                alert(t('error_machine', result.error, result.machine));
                return;
            }
            if (result.data && result.data.operation === 'TRANSFER_AUTO') {
                showEnvelopeMessage(`üîÅ Automatyczny transfer na PALLETIZING`, 'success');
            }
            // --------------------------------------

            // Zapisz referencjƒô do za≈Çadowanej koperty dla tego slotu
            slotEnvelopes[slotId] = { ...envelope, status: 'W_PRODUKCJI', machine: 'PALLETIZING' };

            // Wyczy≈õƒá cache notatek dla tego slotu (pobierz ≈õwie≈ºe z API)
            slotProductNotes[slotId] = null;

            // Aktualizuj UI slotu - zachowaj historiƒô i pole notatki
            content.innerHTML = `
                <!-- Info o za≈Çadowanej kopercie -->
                <div style="text-align: center; margin-bottom: 10px; padding: 10px; background: rgba(0,230,118,0.1); border-radius: 8px;">
                    <h2 style="margin: 0; color: #fff; font-size: 1rem;">${envelope.product}</h2>
                    <div style="color: #888; font-size: 0.75rem;">${envelope.id}</div>
                    <div style="color: #666; font-size: 0.65rem;">Produkt: ${getProductCode(envelope.id)}</div>
                    <div style="background: var(--accent-green); color: #000; padding: 3px 8px; border-radius: 4px; font-weight: bold; display: inline-block; margin-top: 5px; font-size: 0.75rem;">
                        W PRODUKCJI
                    </div>
                </div>
                <!-- Historia slotu / Notatki produktu -->
                <div id="slot-history-${slotId}" style="flex: 1; background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px; overflow-y: auto; min-height: 80px; margin-bottom: 8px;">
                    <div style="color: #555; font-size: 0.75rem; text-align: center;">‚è≥ ≈Åadowanie notatek...</div>
                </div>
                <!-- Notatka + Zapisz -->
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" id="slot-note-${slotId}" placeholder="Wpisz notatkƒô dla tego produktu..."
                        style="flex: 1; background: #333; border: 1px solid #555; color: #fff; padding: 8px; font-size: 0.85rem; border-radius: 4px;">
                    <button class="btn btn-blue" style="padding: 8px 10px; font-size: 0.8rem;" onclick="openNoteImagePicker('slot-${slotId}')">üñºÔ∏è</button>
                    <button class="btn btn-green" style="padding: 8px 12px; font-size: 0.85rem;" onclick="saveSlotNote(${slotId})">üíæ</button>
                </div>
                <input type="file" id="note-image-input-slot-${slotId}" accept="image/*" capture="environment" style="display:none" onchange="handleNoteImageSelected('slot-${slotId}', this)">
                <div id="note-images-slot-${slotId}" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;"></div>
                <!-- Przycisk zwolnienia -->
                <button class="btn btn-orange" style="width: 100%; font-size: 0.85rem; padding: 8px;" onclick="releaseSlot(${slotId}, '${envelope.id}')">ZWOLNIJ SLOT</button>
            `;

            // Pobierz notatki z API i od≈õwie≈º widok
            await renderSlotHistory(slotId);
            renderDraftImages(`slot-${slotId}`);

            // Od≈õwie≈º lokalnƒÖ bazƒô kopert z API (synchronizacja)
            await initEnvelopesFromAPI();

            console.log(`Slot ${slotId} loaded with ${envelope.id} (produkt: ${getProductCode(envelope.id)}, synced with API)`);
        }


        async function activateSlot(slotId) {
            // Symulacja za≈Çadowania koperty do slotu (losowanie)
            // Najpierw od≈õwie≈º dane z API aby mieƒá aktualne statusy
            await initEnvelopesFromAPI();

            // Znajd≈∫ input i wpisz do niego losowƒÖ warto≈õƒá
            const available = ENVELOPES_DB.filter(e => e.status === "MAGAZYN");

            if (available.length === 0) {
                alert(t('no_envelopes_warehouse'));
                return;
            }

            const randomEnv = available[Math.floor(Math.random() * available.length)];
            const input = document.getElementById('slot-input-' + slotId);

            if (input) {
                input.value = randomEnv.id;
                loadEnvelopeForSlot(slotId); // Wywo≈Çaj normalne ≈Çadowanie
            }
        }

        async function releaseSlot(slotId, envelopeId) {
            const slot = document.getElementById('slot-' + slotId);
            const content = slot.querySelector('.slot-content');

            if (confirm(`Czy na pewno zwolniƒá slot ${slotId}?`)) {
                // Zaktualizuj stan w bazie SQL przez API
                if (envelopeId) {
                    await releaseEnvelopeAPI(envelopeId, 'Sekcja A');
                    console.log(`Envelope ${envelopeId} released from slot ${slotId} (synced with API)`);
                }

                // Reset ≈õledzenia koperty w slocie
                slotEnvelopes[slotId] = null;

                // Wyczy≈õƒá cache notatek dla tego slotu
                slotProductNotes[slotId] = null;
                noteDraftImages[`slot-${slotId}`] = [];

                // Przywr√≥cenie widoku inputa
                content.innerHTML = `
                    <input type="text" id="slot-input-${slotId}" placeholder="Nr koperty..." oninput="showSlotSuggestions(${slotId})" style="width: 100%; background: #333; border: 1px solid #555; color: #fff; padding: 12px; font-size: 1.1rem; border-radius: 4px; margin-bottom: 10px;">
                    <div id="slot-hints-${slotId}" class="slot-hints-container" style="display: none;"></div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-blue" style="flex: 1; font-size: 1rem; padding: 10px;" onclick="loadEnvelopeForSlot(${slotId})">ZA≈ÅADUJ</button>
                        <button class="btn" style="width: 60px; background: #444; font-size: 1.2rem;" onclick="activateSlot(${slotId})" title="Symuluj Skan">üì°</button>
                    </div>
                    <!-- Historia slotu -->
                    <div id="slot-history-${slotId}" style="width: 90%; flex: 1; background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px; overflow-y: auto; min-height: 60px; margin-bottom: 8px; margin-top: 10px; box-sizing: border-box;">
                        <div style="color: #555; font-size: 0.75rem; text-align: center;">Za≈Çaduj kopertƒô</div>
                    </div>
                    <!-- Notatka + Zapisz -->
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="slot-note-${slotId}" placeholder="Notatka..."
                            style="flex: 1; background: #333; border: 1px solid #555; color: #fff; padding: 8px; font-size: 0.85rem; border-radius: 4px;">
                        <button class="btn btn-blue" style="padding: 8px 10px; font-size: 0.8rem;" onclick="openNoteImagePicker('slot-${slotId}')">üñºÔ∏è</button>
                        <button class="btn btn-green" style="padding: 8px 12px; font-size: 0.85rem;" onclick="saveSlotNote(${slotId})">üíæ</button>
                    </div>
                    <input type="file" id="note-image-input-slot-${slotId}" accept="image/*" capture="environment" style="display:none" onchange="handleNoteImageSelected('slot-${slotId}', this)">
                    <div id="note-images-slot-${slotId}" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;"></div>
                `;
                renderDraftImages(`slot-${slotId}`);

                // Od≈õwie≈º lokalnƒÖ bazƒô kopert z API (synchronizacja)
                await initEnvelopesFromAPI();
                console.log('üîÑ Lokalna baza od≈õwie≈ºona po zwolnieniu slotu');
            }
        }

        async function checkMachineState(machineName) {
            // await initEnvelopesFromAPI(); // Niepotrzebne, pytamy API bezpo≈õrednio

            let activeEnv = null;
            try {
                const response = await fetch(`${API_BASE}/machines/${encodeURIComponent(machineName)}/status`);
                if (response.ok) {
                    const result = await response.json();
                    // API returns {status: "W_PRODUKCJI", data: {...}} or {status: "IDLE", data: null}
                    if (result && result.status === "W_PRODUKCJI" && result.data) {
                        activeEnv = result.data;
                    }
                }
            } catch (error) {
                console.warn("B≈ÇƒÖd sprawdzania statusu maszyny:", error);
            }

            const searchPanel = document.getElementById('machine-search-panel');
            const activePanel = document.getElementById('machine-active-panel');

            if (activeEnv) {
                // Jest aktywna praca
                if (searchPanel) searchPanel.classList.add('hidden');
                if (activePanel) {
                    activePanel.classList.remove('hidden');
                    const prodName = activeEnv.product || activeEnv.product_name || `Koperta ${activeEnv.id || activeEnv.rcs_id}`;

                    // Update currentEnvelope global variable just in case
                    currentEnvelope = { ...activeEnv, machine: machineName };
                    loadNotesForEnvelope(activeEnv.id || activeEnv.rcs_id);

                    activePanel.innerHTML = `
                        <div class="task-info">
                            <h1 style="font-size: 1.6rem; margin: 0; color: #fff;">${prodName}</h1>
                            <p style="margin: 5px 0 10px 0; color: var(--accent-orange); font-weight: bold;">‚óè W PRODUKCJI</p>
                            <div style="font-size: 0.9rem; color: #aaa; font-family: monospace;">RCS: ${activeEnv.id || activeEnv.rcs_id}</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-orange" style="width: 100%; padding: 15px; font-size: 1.1rem; font-weight: bold;" 
                                    onclick="releaseEnvelopeAPI('${activeEnv.id}', 'Sekcja A').then(() => { checkMachineState('${machineName}'); })">
                                ${t('btn_release_finish')}
                            </button>
                        </div>
                    `;
                }
            } else {
                // Maszyna wolna - poka≈º wyszukiwanie
                if (searchPanel) searchPanel.classList.remove('hidden');
                if (activePanel) {
                    activePanel.classList.add('hidden');
                    activePanel.innerHTML = '';
                }
                hideNotesSection();
            }
        }

        async function loadEnvelope(manualCode = null) {
            const code = manualCode || document.getElementById('envelope-input').value.trim();
            const hintsContainer = document.getElementById('operator-hints');

            // Ukryj podpowiedzi je≈õli sƒÖ
            if (hintsContainer) hintsContainer.style.display = 'none';

            if (!code) {
                showEnvelopeMessage(t('enterEnvelope'), 'warning');
                return;
            }

            // VALIDATE RCS FORMAT
            const validation = validateRCSFormat(code);
            if (!validation.valid) {
                showEnvelopeMessage(`‚ùå ${validation.error}`, 'error');
                document.getElementById('envelope-input').focus();
                return;
            }

            const validatedCode = validation.code;

            // Pobierz aktualny status z API
            const envelope = await fetchEnvelopeStatus(validatedCode);

            if (!envelope) {
                showEnvelopeMessage(t('envelopeNotFound'), 'error');
                return;
            }

            // VALIDATE LOCATION FOR OPERATOR (Start 1.4 requirement)
            const allowedValues = ['CART-OUT-01', 'CART-RET-05', 'SHOP_FLOOR', 'SHOP FLOOR'];
            const eLoc = envelope.location ? String(envelope.location).trim().toUpperCase() : '';
            const eStat = envelope.status ? String(envelope.status).trim().toUpperCase() : '';

            const isLocValid = eLoc && allowedValues.some(allowed => eLoc.includes(allowed));
            const isStatValid = eStat && allowedValues.some(allowed => eStat.includes(allowed));
            const isProduction = eStat === 'W_PRODUKCJI';

            if (!isLocValid && !isStatValid && !isProduction) {
                console.warn(`‚õî Blocked loading ${envelope.id}: Loc='${eLoc}', Stat='${eStat}'`);
                showEnvelopeMessage(`${t('envelope_location_error')} (Loc: ${eLoc}, Stat: ${eStat})`, 'error');
                return;
            }

            // Za≈Çaduj kopertƒô na maszynƒô przez API
            const result = await loadEnvelopeAPI(validatedCode, selectedMachineName);
            if (!result.success) {
                showEnvelopeMessage(`‚õî ${result.error}`, 'error');
                return;
            }

            // Sukces - za≈Çaduj kopertƒô
            currentEnvelope = { ...envelope, status: 'W_PRODUKCJI', machine: selectedMachineName };
            if (result.data && result.data.operation === 'TRANSFER_AUTO') {
                showEnvelopeMessage(`üîÅ Przejƒôto kopertƒô z maszyny ${result.data.from_machine || '-'}`, 'success');
            } else if (result.data && result.data.operation === 'ALREADY_ON_MACHINE') {
                showEnvelopeMessage(`‚ÑπÔ∏è Koperta ju≈º by≈Ça na tej maszynie`, 'success');
            } else {
                showEnvelopeMessage(`‚úÖ Za≈Çadowano: ${envelope.product || validatedCode}`, 'success');
            }

            // Za≈Çaduj notatki dla tego RCS
            loadNotesForEnvelope(validatedCode);

            // Od≈õwie≈º stan UI
            checkMachineState(selectedMachineName);
        }


        async function simulateOperatorScan() {
            // Najpierw od≈õwie≈º dane z API
            await initEnvelopesFromAPI();

            // Symulacja skanowania - losowa koperta z magazynu
            const available = ENVELOPES_DB.filter(e => e.status === "MAGAZYN");
            if (available.length > 0) {
                const randomEnv = available[Math.floor(Math.random() * available.length)];
                document.getElementById('envelope-input').value = randomEnv.id;
                await loadEnvelope();
            } else {
                showEnvelopeMessage('‚ö†Ô∏è Brak dostƒôpnych kopert w magazynie do symulacji.', 'warning');
            }
        }

        function showEnvelopeMessage(text, type) {
            const msgBox = document.getElementById('envelope-message');
            msgBox.style.display = 'block';
            msgBox.innerText = text;
            msgBox.style.background = type === 'error' ? '#3e1a1a' : type === 'success' ? '#1a3e1a' : '#3e3e1a';
            msgBox.style.color = type === 'error' ? '#ff6666' : type === 'success' ? '#66ff66' : '#ffff66';

            setTimeout(() => {
                msgBox.style.display = 'none';
            }, 5000);
        }

        function updateCurrentTaskCard(envelope) {
            document.querySelector('.task-info h1').innerText = envelope.product;
            document.querySelector('.task-info div').innerText = `RCS: ${envelope.id}`;

            // Zmie≈Ñ status koperty na W_PRODUKCJI przy tej maszynie
            envelope.status = "W_PRODUKCJI";
            envelope.machine = selectedMachineName;
            envelope.location = null;
        }

        // PIN MAGAZYNIERA
        const WAREHOUSE_PINS = {
            '5555': 'Magazynier Adam',
            '6666': 'Magazynier Bartek',
            '9999': 'ADMINISTRATOR'
        };

        let currentWarehouseUser = null;

        // Wybrana strefa magazynu (wymagana przed skanowaniem w IN)
        let selectedWarehouseZone = null;

        // Cache listy kopert DO ZWROTU (aktualizowana przy loadReturnCartList)
        let returnCartEnvelopes = [];

        function addWarehousePin(num) {
            const input = document.getElementById('warehouse-pin-input');
            if (input.value.length < 4) input.value += num;
        }

        function clearWarehousePin() {
            document.getElementById('warehouse-pin-input').value = "";
        }

        async function verifyWarehousePin() {
            const pin = document.getElementById('warehouse-pin-input').value;

            if (!pin || pin.length !== 4) {
                const err = document.getElementById('warehouse-pin-error');
                err.style.opacity = "1";
                err.innerText = "Wprowad≈∫ 4-cyfrowy PIN!";
                setTimeout(() => err.style.opacity = "0", 3000);
                return;
            }

            try {
                // Weryfikuj PIN przez API
                const response = await fetch(`${API_BASE}/auth/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin: pin })
                });

                const result = await response.json();

                if (response.ok && result.user) {
                    const user = result.user;

                    // Sprawd≈∫ czy u≈ºytkownik ma rolƒô WAREHOUSE lub ADMIN
                    if (user.role !== 'WAREHOUSE' && user.role !== 'ADMIN') {
                        const err = document.getElementById('warehouse-pin-error');
                        err.style.opacity = "1";
                        err.innerText = `Ten u≈ºytkownik to ${user.role}, nie Magazynier!`;
                        setTimeout(() => err.style.opacity = "0", 3000);
                        return;
                    }

                    // Sprawd≈∫ czy konto jest aktywne
                    if (!user.is_active) {
                        const err = document.getElementById('warehouse-pin-error');
                        err.style.opacity = "1";
                        err.innerText = "Konto nieaktywne! Skontaktuj siƒô z administratorem.";
                        setTimeout(() => err.style.opacity = "0", 3000);
                        return;
                    }

                    // Zalogowano pomy≈õlnie
                    currentWarehouseUser = user.role === 'ADMIN' ? 'ADMINISTRATOR' : (user.full_name || user.username);

                    // Prze≈ÇƒÖcz prawy panel
                    document.getElementById('warehouse-login-view').classList.add('hidden');
                    document.getElementById('warehouse-ops-view').classList.remove('hidden');

                    // Load return cart lists
                    loadReturnCartList('out');
                    loadReturnCartList('in');

                    // Je≈õli administrator - poka≈º przycisk panelu
                    if (user.role === 'ADMIN') {
                        document.getElementById('btn-admin-panel').classList.remove('hidden');
                        document.getElementById('btn-machine-panel').classList.remove('hidden');
                    } else {
                        document.getElementById('btn-admin-panel').classList.add('hidden');
                        document.getElementById('btn-machine-panel').classList.add('hidden');
                        document.getElementById('warehouse-admin-panel').classList.add('hidden');
                        document.getElementById('machine-management-panel').classList.add('hidden');
                        document.getElementById('warehouse-normal-panel').classList.remove('hidden');
                    }
                } else {
                    const err = document.getElementById('warehouse-pin-error');
                    err.style.opacity = "1";
                    err.innerText = result.error || "NIEPRAWID≈ÅOWY PIN!";
                    setTimeout(() => err.style.opacity = "0", 3000);
                }
            } catch (error) {
                console.error('Error verifying warehouse PIN:', error);
                const err = document.getElementById('warehouse-pin-error');
                err.style.opacity = "1";
                err.innerText = "B≈ÇƒÖd po≈ÇƒÖczenia z serwerem!";
                setTimeout(() => err.style.opacity = "0", 3000);
            }
        }

        let currentWarehouseView = 'out'; // 'out' (Wydania) lub 'in' (Przyjƒôcia)

        function toggleWarehouseView() {
            const colOut = document.getElementById('warehouse-col-out');
            const colIn = document.getElementById('warehouse-col-in');
            const toggleBtn = document.getElementById('btn-toggle-warehouse-view');

            if (currentWarehouseView === 'out') {
                colOut.style.display = 'none';
                colIn.style.display = 'flex';
                toggleBtn.innerText = 'ISSUE';
                toggleBtn.classList.remove('btn-orange');
                toggleBtn.classList.add('btn-green');
                currentWarehouseView = 'in';
            } else {
                colOut.style.display = 'flex';
                colIn.style.display = 'none';
                toggleBtn.innerText = 'RECEIVE';
                toggleBtn.classList.remove('btn-green');
                toggleBtn.classList.add('btn-orange');
                currentWarehouseView = 'out';
            }
        }

        function logoutWarehouse() {
            if (confirm('Wylogowaƒá z magazynu?')) {
                currentWarehouseUser = null;
                document.getElementById('warehouse-ops-view').classList.add('hidden');
                document.getElementById('warehouse-login-view').classList.remove('hidden');
                document.getElementById('warehouse-pin-input').value = "";
                // Ukryj admin panel
                document.getElementById('warehouse-admin-panel').classList.add('hidden');
                document.getElementById('machine-management-panel').classList.add('hidden');
                document.getElementById('btn-admin-panel').classList.add('hidden');
                document.getElementById('btn-machine-panel').classList.add('hidden');
                document.getElementById('warehouse-normal-panel').classList.remove('hidden');
            }
        }

        // --- PANEL ADMINA ---
        function toggleAdminPanel() {
            const adminPanel = document.getElementById('warehouse-admin-panel');
            const machinePanel = document.getElementById('machine-management-panel');
            const normalPanel = document.getElementById('warehouse-normal-panel');

            if (adminPanel.classList.contains('hidden')) {
                // Poka≈º panel admina, ukryj pozosta≈Çe
                adminPanel.classList.remove('hidden');
                machinePanel.classList.add('hidden');
                normalPanel.classList.add('hidden');
                loadProductsDropdown();
                loadProductsList();
            } else {
                // Ukryj panel admina, poka≈º normalny
                adminPanel.classList.add('hidden');
                normalPanel.classList.remove('hidden');
            }
        }

        function toggleMachinePanel() {
            const adminPanel = document.getElementById('warehouse-admin-panel');
            const machinePanel = document.getElementById('machine-management-panel');
            const normalPanel = document.getElementById('warehouse-normal-panel');

            if (machinePanel.classList.contains('hidden')) {
                // Poka≈º panel maszyn, ukryj pozosta≈Çe
                machinePanel.classList.remove('hidden');
                adminPanel.classList.add('hidden');
                normalPanel.classList.add('hidden');
                loadMachinesAdminList();
            } else {
                // Ukryj panel maszyn, poka≈º normalny
                machinePanel.classList.add('hidden');
                normalPanel.classList.remove('hidden');
            }
        }

        // --- ZARZƒÑDZANIE PRODUKTAMI ---
        let productsCache = [];

        async function loadProductsDropdown() {
            try {
                const response = await fetch(`${API_BASE}/products`);
                if (response.ok) {
                    productsCache = await response.json();
                    const datalist = document.getElementById('products-options');

                    datalist.innerHTML = '';
                    productsCache.forEach(product => {
                        const option = document.createElement('option');
                        option.value = `${product.company_name} | ${product.product_name} (${product.rcs_id})`;
                        datalist.appendChild(option);
                    });
                }
            } catch (err) {
                console.error('B≈ÇƒÖd ≈Çadowania produkt√≥w:', err);
            }
        }

        function onProductInput() {
            const inputVal = document.getElementById('new-env-product-display').value;
            const hiddenId = document.getElementById('new-env-product');
            const infoBox = document.getElementById('selected-product-info');
            const display = document.getElementById('selected-product-display');
            const rcsInput = document.getElementById('new-env-rcs');

            const product = productsCache.find(p => `${p.company_name} | ${p.product_name} (${p.rcs_id})` === inputVal);

            if (product) {
                hiddenId.value = product.id;
                infoBox.classList.remove('hidden');
                display.innerHTML = `<span style="color: var(--accent-green);">${product.company_name}</span><br>${product.product_name}<br><span style="color: #888; font-size: 0.85rem;">RCS: ${product.rcs_id}</span>`;
                if (rcsInput) rcsInput.value = product.rcs_id;
            } else {
                hiddenId.value = '';
                infoBox.classList.add('hidden');
                display.innerHTML = '';
                if (rcsInput) rcsInput.value = '';
            }
        }

        // loadProductsList moved to product-management.js


        // searchProductsAdmin moved to product-management.js




        async function createNewProduct() {
            const company = document.getElementById('new-product-company').value.trim();
            const name = document.getElementById('new-product-name').value.trim();
            const rcs = document.getElementById('new-product-rcs').value.trim();

            if (!company || !name || !rcs) {
                alert(t('fill_product_fields'));
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company_name: company,
                        product_name: name,
                        rcs_id: rcs
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(t('product_added_success', company, name));
                    // Reset formularza
                    document.getElementById('new-product-company').value = '';
                    document.getElementById('new-product-name').value = '';
                    document.getElementById('new-product-rcs').value = '';
                    // Od≈õwie≈º listƒô produkt√≥w
                    await loadProductsList();
                    await loadProductsDropdown();
                } else {
                    alert(`‚õî B≈ÇƒÖd: ${data.error}`);
                }
            } catch (err) {
                alert(t('error_network'));
                console.error(err);
            }
        }



        async function createNewEnvelope() {
            const productId = document.getElementById('new-env-product').value;
            const rcs = document.getElementById('new-env-rcs').value;
            const sec = document.getElementById('new-env-sec').value;

            if (!productId && !rcs) {
                alert(t('select_product'));
                return;
            }

            try {
                const body = {
                    warehouse_section: sec
                };

                // U≈ºyj product_id je≈õli dostƒôpny, w przeciwnym razie rcs_id
                if (productId) {
                    body.product_id = parseInt(productId);
                } else {
                    body.rcs_id = rcs;
                }

                const response = await fetch(`${API_BASE}/envelopes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`‚úÖ Sukces! ${data.message}`);
                    // Reset formularza
                    await initEnvelopesFromAPI(); // Od≈õwie≈º lokalnƒÖ bazƒô
                } else {
                    alert(`‚õî B≈ÇƒÖd: ${data.error}`);
                }
            } catch (err) {
                alert(t('error_network'));
                console.error(err);
            }
        }

        async function checkEnvelopeHistory() {
            const id = document.getElementById('history-env-id').value.trim();
            const container = document.getElementById('history-results');

            if (!id) return;

            container.innerHTML = '<div style="text-align:center; padding: 20px;">‚è≥ ≈Åadowanie...</div>';

            try {
                const response = await fetch(`${API_BASE}/envelopes/${encodeURIComponent(id)}/history?limit=5`);
                if (response.ok) {
                    const history = await response.json();

                    if (history.length === 0) {
                        container.innerHTML = '<div style="text-align:center; padding: 20px;">Brak historii dla tej koperty.</div>';
                        return;
                    }

                    container.innerHTML = history.map(h => {
                        const date = new Date(h.timestamp).toLocaleString('pl-PL');
                        return `
                        <div style="background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid #888;">
                            <div style="font-size: 0.75rem; color: #888;">${date} ‚Ä¢ ${h.user_id || 'System'}</div>
                            <div style="color: #fff; margin: 4px 0;">${h.from_status} ‚ûù <strong>${h.to_status}</strong></div>
                            <div style="font-size: 0.8rem; color: #aaa;">${h.from_holder || '-'} ‚ûù ${h.to_holder || '-'}</div>
                            ${h.comment ? `<div style="font-size: 0.75rem; color: var(--accent-orange); margin-top: 4px;">${h.comment}</div>` : ''}
                        </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div style="text-align:center; color: #ff6666; padding: 20px;">B≈ÇƒÖd pobierania historii.</div>';
                }
            } catch (err) {
                container.innerHTML = '<div style="text-align:center; color: #ff6666; padding: 20px;">B≈ÇƒÖd po≈ÇƒÖczenia.</div>';
            }
        }

        function renderMainScreenHistoryTimeline(history, envelopeId) {
            if (!history || history.length === 0) {
                return `<div style="text-align:center; color: #888; padding: 14px;">‚ÑπÔ∏è Brak historii dla ${envelopeId}.</div>`;
            }

            return history.map((h, index) => {
                const date = new Date(h.timestamp).toLocaleString('pl-PL', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                });

                const isFirst = index === 0;
                const borderColor = isFirst ? 'var(--accent-blue)' : '#555';

                return `
                <div style="background: ${isFirst ? 'rgba(41, 121, 255, 0.1)' : 'rgba(255,255,255,0.03)'};
                            padding: 15px; margin-bottom: 10px; border-radius: 8px;
                            border-left: 4px solid ${borderColor};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div style="font-size: 0.85rem; color: var(--accent-blue); font-weight: 600;">
                            ${isFirst ? 'üîµ OSTATNIA LOKALIZACJA' : `#${index + 1}`}
                        </div>
                        <div style="font-size: 0.75rem; color: #888;">‚è∞ ${date}</div>
                    </div>
                    <div style="margin-bottom: 6px;">
                        <span style="color: #aaa; font-size: 0.8rem;">Status:</span>
                        <span style="color: #fff; font-weight: 600; margin-left: 5px;">${h.to_status}</span>
                    </div>
                    <div style="margin-bottom: 6px;">
                        <span style="color: #aaa; font-size: 0.8rem;">Miejsce:</span>
                        <span style="color: var(--accent-green); font-weight: 600; margin-left: 5px;">
                            ${h.to_holder || '-'}
                        </span>
                    </div>
                    ${h.user_id ? `
                    <div style="margin-bottom: 0;">
                        <span style="color: #aaa; font-size: 0.8rem;">Operator/Magazynier:</span>
                        <span style="color: var(--accent-orange); font-weight: 600; margin-left: 5px;">
                            ${h.user_id}
                        </span>
                    </div>
                    ` : ''}
                    ${h.operation ? `
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #333;">
                        <span style="color: #666; font-size: 0.7rem;">Operacja: ${h.operation}</span>
                    </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        async function loadMainScreenHistoryForEnvelope(encodedEnvelopeId) {
            const envelopeId = decodeURIComponent(encodedEnvelopeId);
            const detailsContainer = document.getElementById('main-screen-history-details');
            if (!detailsContainer) return;

            detailsContainer.innerHTML = '<div style="text-align:center; padding: 12px;">‚è≥ ≈Åadowanie historii...</div>';

            try {
                const response = await fetch(`${API_BASE}/envelopes/${encodeURIComponent(envelopeId)}/history?limit=5`);
                if (response.status === 404) {
                    detailsContainer.innerHTML = `<div style="text-align:center; color: var(--accent-red); padding: 12px;">‚ùå Koperta ${envelopeId} nie znaleziona</div>`;
                    return;
                }

                if (!response.ok) {
                    detailsContainer.innerHTML = '<div style="text-align:center; color: var(--accent-red); padding: 12px;">‚ùå B≈ÇƒÖd pobierania historii</div>';
                    return;
                }

                const history = await response.json();
                detailsContainer.innerHTML = `
                    <div style="color: var(--accent-blue); font-weight: 700; margin: 8px 0 12px 0;">
                        Historia: ${envelopeId}
                    </div>
                    ${renderMainScreenHistoryTimeline(history, envelopeId)}
                `;
            } catch (err) {
                console.error('Main history details error:', err);
                detailsContainer.innerHTML = '<div style="text-align:center; color: var(--accent-red); padding: 12px;">‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z serwerem</div>';
            }
        }

        let mainScreenHistoryDebounceTimer = null;
        let mainScreenHistorySearchSeq = 0;

        function debouncedSearchMainScreenHistory() {
            clearTimeout(mainScreenHistoryDebounceTimer);
            mainScreenHistoryDebounceTimer = setTimeout(() => {
                searchMainScreenHistory();
            }, 220);
        }

        async function searchMainScreenHistory() {
            const query = document.getElementById('main-screen-history-search').value.trim();
            const container = document.getElementById('main-screen-history-results');
            const suggestionList = document.getElementById('main-screen-history-suggestions');
            const seq = ++mainScreenHistorySearchSeq;

            if (!query || query.length < 2) {
                if (suggestionList) suggestionList.innerHTML = '';
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Wpisz min. 2 znaki RCS/ID, aby zobaczyƒá listƒô kopert...</p>';
                return;
            }

            container.innerHTML = '<div style="text-align:center; padding: 20px;">‚è≥ Wyszukiwanie...</div>';

            try {
                const matches = await searchEnvelopesAPI(query);
                if (seq !== mainScreenHistorySearchSeq) return;
                if (!matches || matches.length === 0) {
                    if (suggestionList) suggestionList.innerHTML = '';
                    container.innerHTML = '<div style="text-align:center; color: var(--accent-red); padding: 20px;">‚ùå Brak wynik√≥w</div>';
                    return;
                }

                const limited = matches.slice(0, 20);
                if (suggestionList) {
                    suggestionList.innerHTML = limited.map(env => `<option value="${env.id}"></option>`).join('');
                }
                container.innerHTML = `
                    <div style="color: #888; font-size: 0.8rem; margin-bottom: 10px;">
                        Znalezione koperty: ${matches.length} (pokazano ${limited.length})
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
                        ${limited.map((env, index) => {
                    const location = env.status === 'MAGAZYN'
                        ? (env.location || 'MAGAZYN')
                        : (env.machine || env.location || '-');
                    return `
                                <button class="btn"
                                    onclick="loadMainScreenHistoryForEnvelope('${encodeURIComponent(env.id)}')"
                                    style="background: rgba(255,255,255,0.04); border: 1px solid #444; padding: 10px; font-size: 0.82rem; text-transform: none; letter-spacing: 0.2px; justify-content: space-between;">
                                    <span style="color: #fff; font-weight: 700;">${index + 1}. ${env.id}</span>
                                    <span style="color: #999;">${env.status} ‚Ä¢ ${location}</span>
                                </button>
                            `;
                }).join('')}
                    </div>
                    <div id="main-screen-history-details" style="border-top: 1px solid #333; padding-top: 10px; min-height: 70px;">
                        <p style="color: #666; text-align: center; padding: 12px;">‚è≥ Auto≈Çadowanie historii pierwszego wyniku...</p>
                    </div>
                `;

                // Auto-uzupe≈Çnianie: podpowiedzi w inpucie + auto-≈Çadowanie historii pierwszego wyniku.
                await loadMainScreenHistoryForEnvelope(encodeURIComponent(limited[0].id));
            } catch (err) {
                console.error('History search error:', err);
                container.innerHTML = '<div style="text-align:center; color: var(--accent-red); padding: 20px;">‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z serwerem</div>';
            }
        }

        async function deleteEnvelope() {
            const envId = document.getElementById('delete-envelope-id').value.trim();
            if (!envId) {
                alert(t('delete_envelope_prompt'));
                return;
            }

            if (!confirm(`‚ö†Ô∏è CZY JESTE≈ö PEWIEN? ‚ö†Ô∏è\n\nChcesz TRWALE usunƒÖƒá kopertƒô:\nüëâ ${envId}\n\nTej operacji nie mo≈ºna cofnƒÖƒá!`)) {
                return;
            }

            // Podw√≥jne potwierdzenie dla bezpiecze≈Ñstwa
            const confirmation = prompt(`Aby potwierdziƒá usuniƒôcie koperty ${envId}, wpisz s≈Çowo "YES":`);
            if (!confirmation || confirmation.toUpperCase() !== "YES") {
                alert(t('delete_cancelled'));
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/envelopes/${encodeURIComponent(envId)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(t('envelope_deleted_success', envId));

                    // Aktualizuj lokalnƒÖ bazƒô
                    const idx = ENVELOPES_DB.findIndex(e => e.id === envId);
                    if (idx !== -1) {
                        ENVELOPES_DB.splice(idx, 1);
                    }

                    // Wyczy≈õƒá pole
                    document.getElementById('delete-envelope-id').value = '';
                } else {
                    alert(t('delete_error', result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error("Delete error:", error);
                alert(t('error_network'));
            }
        }

        // --- ZARZƒÑDZANIE MASZYNAMI OPERATORA ---
        async function loadMachinesAdminList() {
            try {
                const response = await fetch(`${API_BASE}/machines?all=1`);
                const machines = await response.json();
                const listContainer = document.getElementById('machines-list');

                if (!machines || machines.length === 0) {
                    listContainer.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">Brak maszyn</div>';
                    return;
                }

                let html = '';
                machines.forEach(machine => {
                    const activeTag = machine.is_active
                        ? '<span style="background: #2a5; color: #fff; padding: 2px 8px; border-radius: 3px; font-size: 0.7rem; margin-left: 5px;">Aktywna</span>'
                        : '<span style="background: #d32f2f; color: #fff; padding: 2px 8px; border-radius: 3px; font-size: 0.7rem; margin-left: 5px;">Nieaktywna</span>';

                    html += `
                        <div style="background: #252525; padding: 15px; margin-bottom: 10px; border-radius: 6px; border-left: 3px solid #2196F3;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: #fff; font-size: 1rem; margin-bottom: 4px;">
                                        ${machine.machine}
                                        ${activeTag}
                                    </div>
                                    <div style="color: #888; font-size: 0.8rem;">ID: ${machine.id}</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px; margin-top: 10px;">
                                <button onclick="editMachine(${machine.id}, '${machine.machine.replace(/'/g, "\\'")}')" class="btn" style="flex: 1; background: #444; color: #fff; padding: 8px; font-size: 0.8rem;">
                                    ‚úèÔ∏è Nazwa
                                </button>
                                <button onclick="changeMachinePin(${machine.id}, '${machine.machine.replace(/'/g, "\\'")}')" class="btn" style="flex: 1; background: #555; color: #fff; padding: 8px; font-size: 0.8rem;">
                                    üîë PIN
                                </button>
                                <button onclick="toggleMachineActive(${machine.id}, ${machine.is_active ? 0 : 1}, '${machine.machine.replace(/'/g, "\\'")}')" class="btn" style="background: #661111; color: #ffaaaa; padding: 8px; font-size: 0.8rem;">
                                    ${machine.is_active ? '‚õî' : '‚úÖ'}
                                </button>
                            </div>
                        </div>
                    `;
                });

                listContainer.innerHTML = html;
            } catch (error) {
                console.error('Error loading machines:', error);
                document.getElementById('machines-list').innerHTML = '<div style="color: #ff5555; text-align: center; padding: 20px;">B≈ÇƒÖd ≈Çadowania maszyn</div>';
            }
        }

        async function addNewMachine() {
            const machine = document.getElementById('new-machine-name').value.trim();
            const pin = document.getElementById('new-machine-pin').value.trim();

            if (!machine || !pin) {
                alert('Uzupe≈Çnij nazwƒô maszyny i PIN.');
                return;
            }

            if (!/^\d{4}$/.test(pin)) {
                alert('PIN musi sk≈Çadaƒá siƒô z 4 cyfr.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/machines`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machine, pin })
                });
                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ Dodano maszynƒô: ${machine}`);
                    document.getElementById('new-machine-name').value = '';
                    document.getElementById('new-machine-pin').value = '';
                    await loadMachinesAdminList();
                    await loadMachinesFromAPI();
                } else {
                    alert(`‚ùå B≈ÇƒÖd: ${result.error || 'Nie uda≈Ço siƒô dodaƒá maszyny'}`);
                }
            } catch (error) {
                console.error('Error adding machine:', error);
                alert(t('error_network'));
            }
        }

        async function editMachine(machineId, currentName) {
            const newName = prompt('Nowa nazwa maszyny:', currentName);
            if (newName === null) return;
            const clean = newName.trim();
            if (!clean) {
                alert('Nazwa maszyny nie mo≈ºe byƒá pusta.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/machines/${machineId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ machine: clean })
                });
                const result = await response.json();
                if (response.ok) {
                    await loadMachinesAdminList();
                    await loadMachinesFromAPI();
                } else {
                    alert(`‚ùå B≈ÇƒÖd: ${result.error}`);
                }
            } catch (error) {
                console.error('Error editing machine:', error);
                alert(t('error_network'));
            }
        }

        async function changeMachinePin(machineId, machineName) {
            const newPin = prompt(`Zmie≈Ñ PIN maszyny: ${machineName}\\n\\nWpisz nowy PIN (4 cyfry):`);
            if (!newPin) return;
            if (!/^\d{4}$/.test(newPin)) {
                alert('PIN musi sk≈Çadaƒá siƒô z 4 cyfr.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/machines/${machineId}/pin`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_pin: newPin })
                });
                const result = await response.json();
                if (response.ok) {
                    alert(`‚úÖ PIN dla ${machineName} zosta≈Ç zaktualizowany.`);
                    await loadMachinesAdminList();
                } else {
                    alert(`‚ùå B≈ÇƒÖd: ${result.error}`);
                }
            } catch (error) {
                console.error('Error changing machine PIN:', error);
                alert(t('error_network'));
            }
        }

        async function toggleMachineActive(machineId, targetActive, machineName) {
            const action = targetActive ? 'aktywowaƒá' : 'dezaktywowaƒá';
            if (!confirm(`Czy na pewno chcesz ${action} maszynƒô ${machineName}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/machines/${machineId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: targetActive })
                });
                const result = await response.json();
                if (response.ok) {
                    await loadMachinesAdminList();
                    await loadMachinesFromAPI();
                } else {
                    alert(`‚ùå B≈ÇƒÖd: ${result.error}`);
                }
            } catch (error) {
                console.error('Error toggling machine state:', error);
                alert(t('error_network'));
            }
        }

        // Funkcja autouzupe≈Çniania dla magazynu (OUT/IN)
        async function showWarehouseSuggestions(type) {
            const input = document.getElementById('manual-input-' + type);
            const hintsContainer = document.getElementById('warehouse-hints-' + type);
            const query = input.value.trim();

            if (query.length < 2) {
                hintsContainer.style.display = 'none';
                return;
            }

            // Pobierz z API
            const matches = await searchEnvelopesAPI(query);

            if (matches.length === 0) {
                hintsContainer.style.display = 'none';
                return;
            }

            // Generuj listƒô
            hintsContainer.innerHTML = matches.map(e => `
                <div style="padding: 8px; border-bottom: 1px solid #444; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                     onclick="selectWarehouseEnvelope('${type}', '${e.id}')"
                     onmouseover="this.style.background='#444'"
                     onmouseout="this.style.background='transparent'">
                    <div>
                        <div style="color: #fff; font-weight: bold;">${e.id}</div>
                        <div style="color: #888; font-size: 0.75rem;">${e.product || 'Koperta'}</div>
                    </div>
                    <div style="font-size: 0.75rem; color: ${e.status === 'MAGAZYN' ? '#66ff66' : '#ff6666'}">
                        ${e.status === 'MAGAZYN' ? (e.location || 'MAGAZYN') : (e.machine ? `‚öôÔ∏è ${e.machine}` : 'ZAJƒòTA')}
                    </div>
                </div>
            `).join('');

            hintsContainer.style.display = 'block';
        }

        function selectWarehouseEnvelope(type, id) {
            const input = document.getElementById('manual-input-' + type);
            const hintsContainer = document.getElementById('warehouse-hints-' + type);

            input.value = id;
            hintsContainer.style.display = 'none';
        }

        async function searchEnvelopes() {
            const query = document.getElementById('search-envelope-input').value.trim();
            const resultsContainer = document.getElementById('search-results');

            if (query.length < 2) {
                resultsContainer.classList.remove('search-results-active');
                resultsContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Wpisz min. 2 znaki...</p>';
                return;
            }

            // Poka≈º ≈Çadowanie
            resultsContainer.classList.add('search-results-active');
            resultsContainer.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">üîç Wyszukiwanie...</p>';

            // FILTROWANIE SHOP FLOOR
            const onlyShopFloor = document.getElementById('filter-shop-floor')?.checked;
            const status = onlyShopFloor ? 'SHOP_FLOOR' : null;

            // Pobierz z API (lub fallback do lokalnej tablicy)
            let matches = await searchEnvelopesAPI(query, status);

            if (matches.length === 0) {
                resultsContainer.innerHTML = '<p style="color: #ff6666; text-align: center; padding: 20px;">Nie znaleziono kopert</p>';
                return;
            }

            resultsContainer.innerHTML = matches.map(env => {
                const isInWarehouse = env.status === "MAGAZYN";
                const statusColor = isInWarehouse ? 'var(--accent-green)' : 'var(--accent-orange)';
                const statusIcon = isInWarehouse ? 'üì¶' : '‚öôÔ∏è';
                const locationText = isInWarehouse
                    ? `üìç ${env.location || 'Nieprzypisana'}`
                    : `üîß Przy maszynie: <strong>${env.machine}</strong>`;

                return `
                    <div class="list-item" style="border-left-color: ${statusColor}; flex-direction: column; align-items: flex-start;">
                        <div style="font-weight: 700; color: #fff; margin-bottom: 8px;">${env.id}</div>
                        <div style="display: flex; justify-content: space-between; width: 100%;">
                            <span style="color: ${statusColor}; font-weight: 600;">${statusIcon} ${env.status}</span>
                            <span style="color: #aaa;">${locationText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function manualAddEnvelope(type) {
            const inputId = type === 'out' ? 'manual-input-out' : 'manual-input-in';
            const input = document.getElementById(inputId);
            const val = input.value.trim();

            if (!val) {
                alert(t('enter_envelope_code'));
                return;
            }

            // VALIDATE RCS FORMAT
            const validation = validateRCSFormat(val);
            if (!validation.valid) {
                alert(`‚ùå ${validation.error}`);
                input.focus();
                return;
            }

            const validatedCode = validation.code;

            // SEMAFOR: Sprawd≈∫ aktualny status koperty w bazie (async request)
            const envelope = await fetchEnvelopeStatus(validatedCode);

            if (type === 'out') {
                // Dla wydawania - koperta MUSI byƒá w magazynie
                if (!envelope) {
                    alert(t('envelope_not_found_base'));
                    return;
                }
                if (envelope.status !== 'MAGAZYN') {
                    alert(`‚õî SEMAFOR: Koperta zajƒôta!\n\nStatus: ${envelope.status}\nMaszyna: ${envelope.machine || 'N/A'}\n\nNie mo≈ºna wydaƒá koperty, kt√≥ra jest ju≈º w produkcji.`);
                    // showWarehouseSuggestions('out'); // Function might not exist or be needed
                    return;
                }
            }

            if (type === 'in') {
                // Dla przyjƒôcia - koperta NIE mo≈ºe byƒá ju≈º w magazynie (duuplikat)
                // I NIE mo≈ºe byƒá aktywnie zajƒôta przez maszynƒô produkcyjnƒÖ
                if (!envelope) {
                    alert(t('envelope_not_found_base'));
                    return;
                }
                if (envelope.status === 'MAGAZYN') {
                    alert(`‚ö†Ô∏è Koperta ju≈º jest w magazynie!\n\nLokalizacja: ${envelope.location || 'Nieznana'}\n\nNie mo≈ºna przyjƒÖƒá koperty, kt√≥ra ju≈º jest na stanie.`);
                    // showWarehouseSuggestions('in');
                    return;
                }
                // Sprawd≈∫ czy koperta jest zajƒôta przez maszynƒô (nie przez w√≥zek transportowy)
                if (envelope.status === 'W_PRODUKCJI' && envelope.machine && !envelope.machine.startsWith('CART')) {
                    alert(`‚õî SEMAFOR: Koperta zajƒôta na maszynie!\n\nStatus: ${envelope.status}\nMaszyna: ${envelope.machine}\n\nNie mo≈ºna przyjƒÖƒá koperty, kt√≥ra jest aktywnie u≈ºywana na maszynie.\nNajpierw ZWOLNIJ kopertƒô na maszynie ${envelope.machine}.`);
                    // showWarehouseSuggestions('in');
                    return;
                }
            }

            // Clear input and proceed with validated code
            input.value = '';
            simulateScan(type, validatedCode);
        }

        // ========================
        // WAREHOUSE SEARCH LIST (OUT ONLY)
        // ========================

        // Load today's search list
        async function loadSearchList(type) {
            if (type !== 'out') return; // Only for OUT
            try {
                const response = await fetch(`${API_BASE}/search-list/today`);
                if (response.ok) {
                    const items = await response.json();
                    displaySearchList(type, items);
                }
            } catch (err) {
                console.error('Error loading search list:', err);
            }
        }

        // Display search list in UI
        function displaySearchList(type, items) {
            const container = document.getElementById(`search-list-${type}`);
            const counter = document.getElementById(`search-list-count-${type}`);

            if (!container) return;

            if (!items || items.length === 0) {
                container.innerHTML = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">Lista pusta</div>';
                if (counter) counter.textContent = '0/0';
                return;
            }

            const foundCount = items.filter(item => item.found).length;
            if (counter) counter.textContent = `${foundCount}/${items.length}`;

            container.innerHTML = items.map(item => {
                const isFound = item.found;
                const bgColor = isFound ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255,255,255,0.03)';
                const borderColor = isFound ? 'var(--accent-green)' : '#555';
                const icon = isFound ? '‚úÖ' : '‚è≥';

                return `
                    <div style="background: ${bgColor}; padding: 8px; margin-bottom: 6px; border-radius: 4px; border-left: 3px solid ${borderColor}; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="color: #fff; font-size: 0.85rem; font-weight: bold;">${icon} ${item.envelope_id}</div>
                            ${isFound ? `<div style="color: #666; font-size: 0.7rem;">${new Date(item.found_at).toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' })}</div>` : ''}
                        </div>
                        <button onclick="deleteSearchItem(${item.id}, '${type}')" class="btn" 
                            style="padding: 4px 8px; font-size: 0.7rem; background: var(--accent-red);">
                            ‚ùå
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Show add modal
        function showAddToSearchList(type) {
            // Reuse existing modal logic (assumes modal exists in HTML)
            if (type !== 'out') return;
            document.getElementById('add-search-envelope-id').value = '';
            document.getElementById('add-search-modal').classList.remove('hidden');
        }

        // Execute add to search list
        async function executeAddToSearchList() {
            const envelopeId = document.getElementById('add-search-envelope-id').value.trim();
            if (!envelopeId) { alert(t('enter_envelope_id')); return; }

            try {
                const response = await fetch(`${API_BASE}/search-list/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ envelope_id: envelopeId })
                });
                const result = await response.json();
                if (result.success) {
                    alert(t('added_to_list'));
                    closeAddSearchModal();
                    loadSearchList('out');
                } else {
                    alert(`‚ùå ${result.error}`);
                }
            } catch (err) {
                alert(t('error_connection'));
            }
        }

        // Show import modal
        function showImportSearchList(type) {
            if (type !== 'out') return;
            document.getElementById('import-search-file-input').value = '';
            document.getElementById('import-search-progress').classList.add('hidden');
            document.getElementById('import-search-results').classList.add('hidden');
            document.getElementById('import-search-btn').disabled = false;
            document.getElementById('import-search-modal').classList.remove('hidden');
        }

        // Execute import
        async function executeImportSearchList() {
            const fileInput = document.getElementById('import-search-file-input');
            const file = fileInput.files[0];
            if (!file) { alert(t('choose_file')); return; }

            const formData = new FormData();
            formData.append('file', file);
            const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
            const endpoint = isExcel ? '/search-list/import-excel' : '/search-list/import-csv';

            document.getElementById('import-search-progress').classList.remove('hidden');
            document.getElementById('import-search-progress-bar').style.width = '50%';
            document.getElementById('import-search-status').textContent = 'Importowanie...';
            document.getElementById('import-search-btn').disabled = true;

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, { method: 'POST', body: formData });
                const result = await response.json();
                document.getElementById('import-search-progress-bar').style.width = '100%';

                if (result.success) {
                    document.getElementById('import-search-status').textContent = 'Import zako≈Ñczony!';
                    const stats = result.stats;
                    let resultsHTML = `
                        <div style="color: var(--accent-green); font-weight: bold; margin-bottom: 10px;">‚úÖ Import zako≈Ñczony pomy≈õlnie!</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div style="background: #1a1a1a; padding: 10px; border-radius: 4px; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">Dodano</div>
                                <div style="color: var(--accent-green); font-size: 1.2rem; font-weight: bold;">${stats.added}</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 10px; border-radius: 4px; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">Pominiƒôto</div>
                                <div style="color: var(--accent-orange); font-size: 1.2rem; font-weight: bold;">${stats.skipped}</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 10px; border-radius: 4px; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">B≈Çƒôdy</div>
                                <div style="color: var(--accent-red); font-size: 1.2rem; font-weight: bold;">${stats.errors}</div>
                            </div>
                        </div>`;
                    document.getElementById('import-search-results').innerHTML = resultsHTML;
                    document.getElementById('import-search-results').classList.remove('hidden');
                    loadSearchList('out');
                } else {
                    document.getElementById('import-search-status').textContent = 'B≈ÇƒÖd importu!';
                    document.getElementById('import-search-results').innerHTML = `<div style="color: var(--accent-red);">‚ùå ${result.error}</div>`;
                    document.getElementById('import-search-results').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('import-search-status').textContent = 'B≈ÇƒÖd!';
            } finally {
                document.getElementById('import-search-btn').disabled = false;
            }
        }

        // Delete item
        async function deleteSearchItem(itemId, type) {
            if (!confirm('UsunƒÖƒá z listy?')) return;
            try {
                const response = await fetch(`${API_BASE}/search-list/${itemId}`, { method: 'DELETE' });
                if (response.ok) loadSearchList('out');
            } catch (err) { alert(t('error_delete')); }
        }

        // Clear list
        async function clearSearchList(type) {
            if (!confirm('Wyczy≈õciƒá ca≈ÇƒÖ dzisiejszƒÖ listƒô?')) return;
            try {
                const response = await fetch(`${API_BASE}/search-list/clear`, { method: 'DELETE' });
                if (response.ok) loadSearchList('out');
            } catch (err) { alert(t('error_clear')); }
        }

        // Check match
        async function checkSearchListMatch(envelopeId) {
            try {
                const response = await fetch(`${API_BASE}/search-list/mark-found/${encodeURIComponent(envelopeId)}`, { method: 'PUT' });
                if (response.ok) {
                    const result = await response.json();
                    if (result.updated > 0) {
                        showMatchNotification(envelopeId);
                        loadSearchList('out');
                        return true;
                    }
                }
            } catch (err) { console.error('Error checking search match:', err); }
            return false;
        }

        // Show match notification
        function showMatchNotification(envelopeId) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--accent-green); color: #fff; padding: 30px 50px;
                border-radius: 15px; font-size: 1.5rem; font-weight: bold; z-index: 10000;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: pulse 0.5s ease-in-out;
            `;
            toast.textContent = `‚úÖ ZNALEZIONO: ${envelopeId}`;
            document.body.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        // Modal helpers
        function closeAddSearchModal() { document.getElementById('add-search-modal').classList.add('hidden'); }
        function closeImportSearchModal() { document.getElementById('import-search-modal').classList.add('hidden'); }

        // ========================
        // RETURN CART DISPLAY (CART-RET-05)
        // ========================

        // Load return cart envelopes from CART-RET-05 status
        async function loadReturnCartList(type) {
            try {
                const response = await fetch(`${API_BASE}/stats/cart-return-list`);
                if (response.ok) {
                    const items = await response.json();
                    returnCartEnvelopes = items;  // Cache globally for validation
                    displayReturnCartList(type, items);
                }
            } catch (err) {
                console.error('Error loading return cart list:', err);
            }
        }

        // Display return cart list
        function displayReturnCartList(type, items) {
            const container = document.getElementById(`return-cart-list-${type}`);
            const counter = document.getElementById(`return-cart-count-${type}`);

            if (!items || items.length === 0) {
                container.innerHTML = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">Brak kopert</div>';
                counter.textContent = '0';
                return;
            }

            counter.textContent = items.length;

            container.innerHTML = items.map(item => {
                return `
                    <div style="background: rgba(255,152,0,0.1); padding: 8px; margin-bottom: 6px; border-radius: 4px; border-left: 3px solid var(--accent-orange);">
                        <div style="color: #fff; font-size: 0.85rem; font-weight: bold;">${item.unique_key}</div>
                        ${item.rcs_id ? `<div style="color: #888; font-size: 0.7rem;">${item.rcs_id}</div>` : ''}
                    </div>
                `;
            }).join('');
        }


        // ========================
        // WAREHOUSE SEARCH LIST
        // ========================

        let currentSearchListType = 'out'; // or 'in'

        // Load today's search list
        async function loadSearchList(type) {
            try {
                const response = await fetch(`${API_BASE}/search-list/today`);
                if (response.ok) {
                    const items = await response.json();
                    displaySearchList(type, items);
                }
            } catch (err) {
                console.error('Error loading search list:', err);
            }
        }

        // Display search list in UI
        function displaySearchList(type, items) {
            const container = document.getElementById(`search-list-${type}`);
            const counter = document.getElementById(`search-list-count-${type}`);

            if (!items || items.length === 0) {
                container.innerHTML = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">Lista pusta</div>';
                counter.textContent = '0/0';
                return;
            }

            const foundCount = items.filter(item => item.found).length;
            counter.textContent = `${foundCount}/${items.length}`;

            container.innerHTML = items.map(item => {
                const isFound = item.found;
                const bgColor = isFound ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255,255,255,0.03)';
                const borderColor = isFound ? 'var(--accent-green)' : '#555';
                const icon = isFound ? '‚úÖ' : '‚è≥';

                return `
                    <div style="background: ${bgColor}; padding: 8px; margin-bottom: 6px; border-radius: 4px; border-left: 3px solid ${borderColor}; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="color: #fff; font-size: 0.85rem; font-weight: bold;">${icon} ${item.envelope_id}</div>
                            ${isFound ? `<div style="color: #666; font-size: 0.7rem;">${new Date(item.found_at).toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' })}</div>` : ''}
                        </div>
                        <button onclick="deleteSearchItem(${item.id}, '${type}')" class="btn" 
                            style="padding: 4px 8px; font-size: 0.7rem; background: var(--accent-red);">
                            ‚ùå
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Show add modal
        function showAddToSearchList(type) {
            currentSearchListType = type;
            document.getElementById('add-search-envelope-id').value = '';
            document.getElementById('add-search-modal').classList.remove('hidden');
        }

        function closeAddSearchModal() {
            document.getElementById('add-search-modal').classList.add('hidden');
        }

        // Execute add to search list
        async function executeAddToSearchList() {
            const envelopeId = document.getElementById('add-search-envelope-id').value.trim();

            if (!envelopeId) {
                alert(t('enter_envelope_id'));
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/search-list/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ envelope_id: envelopeId })
                });

                const result = await response.json();

                if (result.success) {
                    alert(t('added_to_list'));
                    closeAddSearchModal();
                    loadSearchList('out');
                    loadSearchList('in');
                } else {
                    alert(`‚ùå ${result.error}`);
                }
            } catch (err) {
                alert(t('error_connection'));
            }
        }

        // Show import modal
        function showImportSearchList(type) {
            currentSearchListType = type;
            document.getElementById('import-search-file-input').value = '';
            document.getElementById('import-search-progress').classList.add('hidden');
            document.getElementById('import-search-results').classList.add('hidden');
            document.getElementById('import-search-btn').disabled = false;
            document.getElementById('import-search-modal').classList.remove('hidden');
        }

        function closeImportSearchModal() {
            document.getElementById('import-search-modal').classList.add('hidden');
        }

        // Execute import
        async function executeImportSearchList() {
            const fileInput = document.getElementById('import-search-file-input');
            const file = fileInput.files[0];

            if (!file) {
                alert(t('choose_file'));
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
            const endpoint = isExcel ? '/search-list/import-excel' : '/search-list/import-csv';

            // Show progress
            document.getElementById('import-search-progress').classList.remove('hidden');
            document.getElementById('import-search-progress-bar').style.width = '50%';
            document.getElementById('import-search-status').textContent = 'Importowanie...';
            document.getElementById('import-search-btn').disabled = true;

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                document.getElementById('import-search-progress-bar').style.width = '100%';

                if (result.success) {
                    const stats = result.stats;
                    document.getElementById('import-search-status').textContent = 'Import zako≈Ñczony!';

                    let resultsHTML = `
                        <div style="color: var(--accent-green); font-weight: bold; margin-bottom: 10px;">
                            ‚úÖ Import zako≈Ñczony pomy≈õlnie!
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div style="background: #1a1a1a; padding: 10px; border-radius: 4px; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">Dodano</div>
                                <div style="color: var(--accent-green); font-size: 1.2rem; font-weight: bold;">${stats.added}</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 10px; border-radius: 4px; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">Pominiƒôto</div>
                                <div style="color: var(--accent-orange); font-size: 1.2rem; font-weight: bold;">${stats.skipped}</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 10px; border-radius: 4px; text-align: center;">
                                <div style="color: #888; font-size: 0.8rem;">B≈Çƒôdy</div>
                                <div style="color: var(--accent-red); font-size: 1.2rem; font-weight: bold;">${stats.errors}</div>
                            </div>
                        </div>
                    `;

                    document.getElementById('import-search-results').innerHTML = resultsHTML;
                    document.getElementById('import-search-results').classList.remove('hidden');

                    // Reload both lists
                    loadSearchList('out');
                    loadSearchList('in');
                } else {
                    document.getElementById('import-search-status').textContent = 'B≈ÇƒÖd importu!';
                    document.getElementById('import-search-results').innerHTML = `
                        <div style="color: var(--accent-red);">‚ùå ${result.error}</div>
                    `;
                    document.getElementById('import-search-results').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('import-search-status').textContent = 'B≈ÇƒÖd!';
                document.getElementById('import-search-results').innerHTML = `
                    <div style="color: var(--accent-red);">‚ùå B≈ÇƒÖd po≈ÇƒÖczenia</div>
                `;
                document.getElementById('import-search-results').classList.remove('hidden');
            } finally {
                document.getElementById('import-search-btn').disabled = false;
            }
        }

        // Delete item from search list
        async function deleteSearchItem(itemId, type) {
            if (!confirm('UsunƒÖƒá z listy?')) return;

            try {
                const response = await fetch(`${API_BASE}/search-list/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadSearchList('out');
                    loadSearchList('in');
                }
            } catch (err) {
                alert(t('error_delete'));
            }
        }

        // Clear today's search list
        async function clearSearchList(type) {
            if (!confirm('Wyczy≈õciƒá ca≈ÇƒÖ dzisiejszƒÖ listƒô?')) return;

            try {
                const response = await fetch(`${API_BASE}/search-list/clear`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadSearchList('out');
                    loadSearchList('in');
                }
            } catch (err) {
                alert(t('error_clear'));
            }
        }

        // Check if scanned envelope matches search list
        async function checkSearchListMatch(envelopeId) {
            try {
                const response = await fetch(`${API_BASE}/search-list/mark-found/${encodeURIComponent(envelopeId)}`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.updated > 0) {
                        // Match found! Show notification
                        showMatchNotification(envelopeId);
                        loadSearchList('out');
                        loadSearchList('in');
                        return true;
                    }
                }
            } catch (err) {
                console.error('Error checking search match:', err);
            }
            return false;
        }

        // Show match notification
        function showMatchNotification(envelopeId) {
            // Play success sound (optional)
            // new Audio('/success.mp3').play();

            // Show toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--accent-green);
                color: #fff;
                padding: 30px 50px;
                border-radius: 15px;
                font-size: 1.5rem;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                animation: pulse 0.5s ease-in-out;
            `;
            toast.textContent = `‚úÖ ZNALEZIONO: ${envelopeId}`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }


        // --- LOGIKA ZATWIERDZANIA W√ìZK√ìW ---
        // Lista kopert dodanych do w√≥zka OUT (do wydania)
        let cartOutEnvelopes = [];
        // Lista kopert dodanych do w√≥zka IN (do przyjƒôcia)
        let cartInEnvelopes = [];

        async function confirmCartOut() {
            if (cartOutEnvelopes.length === 0) {
                alert(t('cart_empty_warning'));
                return;
            }

            if (!confirm(`Czy zatwierdziƒá w√≥zek z ${cartOutEnvelopes.length} kopertami?\nStatusy zostanƒÖ zmienione na "SHOP_FLOOR".`)) {
                return;
            }

            let successCount = 0;
            let failedEnvelopes = [];

            // Wydaj ka≈ºdƒÖ kopertƒô z magazynu przez API
            for (const envId of cartOutEnvelopes) {
                try {
                    const response = await fetch(`${API_BASE}/envelopes/${encodeURIComponent(envId)}/issue`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cart_id: 'CART-OUT-01' })
                    });

                    if (response.ok) {
                        // Aktualizuj lokalnƒÖ bazƒô
                        const env = ENVELOPES_DB.find(e => e.id === envId);
                        if (env) {
                            env.status = "SHOP_FLOOR";
                            env.machine = "CART-OUT-01";
                            env.location = null;
                        }
                        successCount++;
                        console.log(`Koperta ${envId} -> SHOP_FLOOR`);
                    } else {
                        const errorData = await response.json();
                        failedEnvelopes.push({ id: envId, error: errorData.error });
                        console.error(`B≈ÇƒÖd wydania ${envId}:`, errorData.error);
                    }
                } catch (error) {
                    failedEnvelopes.push({ id: envId, error: 'B≈ÇƒÖd po≈ÇƒÖczenia' });
                    console.error(`B≈ÇƒÖd sieci dla ${envId}:`, error);
                }
            }

            if (failedEnvelopes.length > 0) {
                alert(`‚ö†Ô∏è Wydano ${successCount} kopert.\n\nB≈Çƒôdy (${failedEnvelopes.length}):\n${failedEnvelopes.map(f => `‚Ä¢ ${f.id}: ${f.error}`).join('\n')}`);
            } else {
                alert(`‚úÖ Zatwierdzono w√≥zek!\n${successCount} kopert zmieni≈Ço status na SHOP_FLOOR.\n\nKoperty sƒÖ gotowe do za≈Çadowania na maszyny.`);
            }

            // Wyczy≈õƒá listƒô i UI
            cartOutEnvelopes = [];
            document.getElementById('list-out').innerHTML = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">Brak zeskanowanych kopert</div>';
        }

        async function confirmCartIn() {
            if (cartInEnvelopes.length === 0) {
                alert(t('no_envelopes_receive'));
                return;
            }

            const targetLocation = manualZone || "Sekcja A";

            if (!confirm(`Czy zako≈Ñczyƒá przyjƒôcie ${cartInEnvelopes.length} kopert na stan magazynowy (${targetLocation})?`)) {
                return;
            }

            let successCount = 0;
            let failedEnvelopes = [];

            // Wywo≈Çaj API /return dla ka≈ºdej koperty
            for (const envId of cartInEnvelopes) {
                try {
                    const response = await fetch(`${API_BASE}/envelopes/${encodeURIComponent(envId)}/return`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ location: targetLocation })
                    });

                    if (response.ok) {
                        // Aktualizuj lokalnƒÖ bazƒô
                        const env = ENVELOPES_DB.find(e => e.id === envId);
                        if (env) {
                            env.status = "MAGAZYN";
                            env.machine = null;
                            env.location = targetLocation;
                        }
                        successCount++;
                        console.log(`Koperta ${envId} -> MAGAZYN (${targetLocation})`);
                    } else {
                        const errorData = await response.json();
                        failedEnvelopes.push({ id: envId, error: errorData.error });
                    }
                } catch (error) {
                    failedEnvelopes.push({ id: envId, error: 'B≈ÇƒÖd po≈ÇƒÖczenia' });
                }
            }

            if (failedEnvelopes.length > 0) {
                alert(`‚ö†Ô∏è Przyjƒôto ${successCount} kopert.\nB≈Çƒôdy (${failedEnvelopes.length}):\n${failedEnvelopes.map(f => `‚Ä¢ ${f.id}: ${f.error}`).join('\n')}`);
            } else {
                alert(`‚úÖ Przyjƒôcie zako≈Ñczone!\n${successCount} kopert przyjƒôtych na stan ${targetLocation}.`);
            }

            // Wyczy≈õƒá listƒô i UI
            cartInEnvelopes = [];
            document.getElementById('list-in').innerHTML = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">Brak zeskanowanych kopert</div>';
        }

        // Symulacja skanowania
        let scanCounterOut = 0;
        let scanCounterIn = 0;
        let manualZone = null;

        function setManualZone(zone) {
            manualZone = zone;
            selectedWarehouseZone = zone;  // Zapisz te≈º dla walidacji skanowania

            // Resetuj style wszystkich przycisk√≥w stref
            document.querySelectorAll('.btn-zone').forEach(btn => {
                btn.style.background = '#333';
                btn.style.color = '#fff';
                btn.style.fontWeight = 'normal';
            });

            // Pod≈õwietl wybrany
            const selectedBtn = document.getElementById('btn-zone-' + zone);
            if (selectedBtn) {
                selectedBtn.style.background = 'var(--accent-orange)'; // Jasny pomara≈Ñcz zdefiniowany w CSS
                selectedBtn.style.color = '#000';
                selectedBtn.style.fontWeight = 'bold';
            }
        }

        let html5QrcodeScanner = null;
        let currentScanType = null;
        let scannerState = 'idle'; // idle | starting | running | stopping
        let scannerRunToken = 0;
        const scannerTelemetry = {
            decodeSuccess: { out: 0, in: 0, load: 0 },
            cameraStartErrors: 0
        };
        window.scannerTelemetry = scannerTelemetry;

        // Zmienna do unikania pƒôtli schowka (mechanizm konsumpcji)
        let lastProcessedClipboardContent = null;
        let lastDecodedFingerprint = null;
        let lastDecodedAt = 0;

        function isSecureCameraContext() {
            return window.isSecureContext || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        }

        function getCameraErrorMessage(err) {
            if (!err) return t('camera_unknown_error');
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') return t('camera_permission_denied');
            if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') return t('camera_not_found');
            if (err.name === 'NotReadableError' || err.name === 'TrackStartError') return t('camera_in_use');
            if (typeof err === 'string') return err;
            return err.message || t('camera_unknown_error');
        }

        function onScanError(error, scanType) {
            // html5-qrcode raportuje tu te≈º zwyk≈Çe "brak kodu w klatce".
            if (error && String(error).includes('NotFoundException')) return;
            console.debug('Scan decode error', scanType, error);
        }

        async function simulateScan(type, manualValue = null) {
            currentScanType = type;
            if (manualValue) { processScanResult(manualValue, type, true); return; }

            try {
                const text = await navigator.clipboard.readText();
                if (text && text.trim().length > 0) {
                    const cleanText = text.trim();
                    // Sprawd≈∫ czy to ten sam kod co ostatnio
                    if (cleanText !== lastProcessedClipboardContent) {
                        console.log("üìã Pobrano ze schowka:", cleanText);
                        lastProcessedClipboardContent = cleanText; // "Zu≈ºyj" dane
                        processScanResult(cleanText, type, false, true);
                        return;
                    }
                    console.log("‚ôªÔ∏è Schowek pominiƒôty (dane ju≈º przetworzone):", cleanText);
                }
            } catch (err) {
                console.debug('Schowek niedostƒôpny:', err);
            }

            // Je≈õli schowek pusty lub "zu≈ºyty" -> odpal kamerƒô
            await openScanner(type);
        }

        async function openScanner(scanType) {
            currentScanType = scanType || currentScanType;

            if (!isSecureCameraContext()) {
                alert(`${t('camera_blocked')}\n\n${t('camera_secure_context_hint')}`);
                return;
            }

            if (typeof Html5Qrcode === 'undefined') {
                alert(t('camera_lib_missing'));
                return;
            }

            if (scannerState === 'running' || scannerState === 'starting') return;
            if (scannerState === 'stopping') {
                setTimeout(() => openScanner(scanType), 150);
                return;
            }

            const modal = document.getElementById('scanner-modal');
            scannerState = 'starting';
            modal.classList.remove('hidden');
            const runToken = ++scannerRunToken;

            try {
                if (html5QrcodeScanner === null) {
                    html5QrcodeScanner = new Html5Qrcode("reader");
                }

                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                await html5QrcodeScanner.start(
                    { facingMode: "environment" },
                    config,
                    (decodedText) => onScanDecoded(decodedText, currentScanType),
                    (errorMessage) => onScanError(errorMessage, currentScanType)
                );

                if (runToken !== scannerRunToken) {
                    await closeScanner();
                    return;
                }
                scannerState = 'running';
            } catch (err) {
                scannerTelemetry.cameraStartErrors += 1;
                scannerState = 'idle';
                modal.classList.add('hidden');
                console.error("Camera start error:", err);
                alert(`‚õî ${t('camera_start_error')}\n${getCameraErrorMessage(err)}`);
            }
        }

        async function closeScanner() {
            const modal = document.getElementById('scanner-modal');
            if (scannerState === 'idle') {
                modal.classList.add('hidden');
                return;
            }
            if (scannerState === 'stopping') return;

            scannerState = 'stopping';
            try {
                if (html5QrcodeScanner) {
                    await html5QrcodeScanner.stop();
                    await html5QrcodeScanner.clear();
                }
            } catch (err) {
                console.debug('Scanner stop info:', err);
            } finally {
                modal.classList.add('hidden');
                scannerState = 'idle';
            }
        }

        // Backward-compatible alias for existing handlers.
        function stopScanner() {
            closeScanner();
        }

        function onScanDecoded(decodedText, scanType) {
            const resolvedType = scanType || currentScanType;
            if (!resolvedType || !decodedText) return;

            const fingerprint = `${resolvedType}:${decodedText}`;
            const now = Date.now();
            if (fingerprint === lastDecodedFingerprint && now - lastDecodedAt < 1200) return;
            lastDecodedFingerprint = fingerprint;
            lastDecodedAt = now;

            if (scannerTelemetry.decodeSuccess[resolvedType] !== undefined) {
                scannerTelemetry.decodeSuccess[resolvedType] += 1;
            }

            closeScanner();
            processScanResult(decodedText, resolvedType);
        }

        function processScanResult(code, type, isManual = false, isClipboard = false) {
            // VALIDATE RCS FORMAT
            const validation = validateRCSFormat(code);
            if (!validation.valid) {
                alert(`‚ùå ${validation.error}`);
                return; // Stop processing
            }

            const validatedCode = validation.code; // Use uppercase normalized code


            const now = new Date().toLocaleTimeString();
            if (type === 'out') {
                scanCounterOut++;
                const list = document.getElementById('list-out');
                const item = document.createElement('div');
                item.className = 'list-item status-ok';
                cartOutEnvelopes.push(validatedCode);
                let icon = isManual ? ' ‚úèÔ∏è' : (isClipboard ? ' üìã' : ' üì∑');
                item.innerHTML = `<div><div style="font-weight:700; color:#fff">${validatedCode}${icon}</div><div style="font-size:0.8em; color:#666">${now}</div></div><div style="color: var(--accent-green); font-weight:800;">OK</div>`;
                list.prepend(item);
            } else if (type === 'in') {
                // WALIDACJA 1: Czy wybrano strefƒô?
                if (!selectedWarehouseZone) {
                    alert(t('select_zone_first'));
                    return;
                }

                // WALIDACJA 2: Czy koperta jest na li≈õcie zwrot√≥w?
                const onReturnCart = returnCartEnvelopes.some(e =>
                    e.unique_key === validatedCode || e.rcs_id === validatedCode
                );

                if (!onReturnCart) {
                    // Opcjonalnie: d≈∫wiƒôk b≈Çƒôdu
                    alert(`‚õî KOPERTA ${validatedCode} NIE JEST NA LI≈öCIE DO ZWROTU!`);
                    return;
                }

                // WALIDACJA 3: Czy strefa siƒô zgadza? (Ostrze≈ºenie)
                const suffix = `/${selectedWarehouseZone}`;
                if (!validatedCode.endsWith(suffix)) {
                    // Je≈õli kod nie ko≈Ñczy siƒô na /X (gdzie X to wybrana strefa)
                    // Mozna zablokowaƒá lub tylko ostrzec. U≈ºytkownik prosi≈Ç o "skanowanie tych co nale≈ºƒÖ do strefy"
                    if (!confirm(`‚ö†Ô∏è Koperta ${validatedCode} nie pasuje do strefy ${selectedWarehouseZone}. Dodaƒá mimo to?`)) {
                        return;
                    }
                }

                scanCounterIn++;
                const list = document.getElementById('list-in');
                const locDisplay = document.getElementById('loc-display');

                // U≈ºyj wybranej strefy
                let zone = selectedWarehouseZone;

                locDisplay.innerText = `[ ${zone} ]`;
                locDisplay.classList.remove('hidden');
                setTimeout(() => { locDisplay.classList.add('hidden'); }, 1500);

                const item = document.createElement('div');
                item.className = 'list-item status-loc';
                cartInEnvelopes.push(validatedCode);

                let icon = isManual ? ' ‚úèÔ∏è' : (isClipboard ? ' üìã' : ' üì∑');
                item.innerHTML = `<div><div style="font-weight:700; color:#fff">${validatedCode}${icon}</div><div style="font-size:0.8em; color:#666">${now}</div></div><div style="color: var(--accent-blue); font-weight:900; font-size: 1.2rem;">${zone}</div>`;
                list.prepend(item);
            } else if (type === 'load') {
                // Obs≈Çuga skanowania w panelu operatora
                if (document.getElementById('screen-operator').classList.contains('hidden')) {
                    alert(t('go_to_op_panel'));
                    return;
                }
                // Wpisz kod w pole i za≈Çaduj
                document.getElementById('envelope-input').value = validatedCode;
                loadEnvelope(validatedCode);
            }
        }


        function simulateScan_OLD(type, manualValue = null) {
            const now = new Date().toLocaleTimeString();

            if (type === 'out') {
                scanCounterOut++;
                const list = document.getElementById('list-out');
                const item = document.createElement('div');
                item.className = 'list-item status-ok';

                // U≈ºyj rƒôcznego kodu lub wygeneruj
                const code = manualValue ? manualValue : `RCS-SIM-OUT#${100 + scanCounterOut}`;

                // DODAJ DO LISTY W√ìZKA OUT
                cartOutEnvelopes.push(code);

                item.innerHTML = `
                    <div>
                        <div style="font-weight:700; color:#fff">${code}${manualValue ? ' ‚úèÔ∏è' : ''}</div>
                        <div style="font-size:0.8em; color:#666">${now}</div>
                    </div>
                    <div style="color: var(--accent-green); font-weight:800;">OK</div>
                `;
                list.prepend(item);
            }
            else if (type === 'in') {
                scanCounterIn++;
                const list = document.getElementById('list-in');

                // Poka≈º animacjƒô lokalizacji
                const locDisplay = document.getElementById('loc-display');
                // const scanIcon = locDisplay.previousElementSibling.previousElementSibling; 

                // U≈ºyj wybranej strefy lub losuj
                let zone = manualZone;
                if (!zone) {
                    const zones = ['A', 'B', 'C', 'D', 'E', 'F'];
                    zone = zones[Math.floor(Math.random() * zones.length)];
                }

                locDisplay.innerText = `[ ${zone} ]`;
                locDisplay.classList.remove('hidden');

                setTimeout(() => {
                    locDisplay.classList.add('hidden');
                }, 1500);

                const item = document.createElement('div');
                item.className = 'list-item status-loc';

                // U≈ºyj rƒôcznego kodu lub wygeneruj
                const code = manualValue ? manualValue : `RCS-SIM-IN#${50 + scanCounterIn}`;

                // DODAJ DO LISTY W√ìZKA IN
                cartInEnvelopes.push(code);

                item.innerHTML = `
                    <div>
                        <div style="font-weight:700; color:#fff">${code}${manualValue ? ' ‚úèÔ∏è' : ''}</div>
                        <div style="font-size:0.8em; color:#666">${now}</div>
                    </div>
                    <div style="color: var(--accent-blue); font-weight:900; font-size: 1.2rem;">${zone}</div>
                `;
                list.prepend(item);
            }
        }
        // --- LICZNIK ZWROT√ìW (CART-RET-05) + SPRAWDZANIE PO≈ÅƒÑCZENIA ---
        async function updateCartReturnCount() {
            const statusDot = document.getElementById('connection-dot');
            const statusText = document.getElementById('connection-text');
            const debugText = document.getElementById('api-url-debug');

            // Poka≈º jaki URL jest u≈ºywany (tylko raz lub zawsze)
            if (debugText && !debugText.innerText) {
                debugText.innerText = `(${API_BASE})`;
            }

            try {
                const response = await fetch(`${API_BASE}/stats/cart-return-count`);
                if (response.ok) {
                    const data = await response.json();
                    const el = document.getElementById('cart-return-count');
                    if (el) el.innerText = data.count;

                    // Update Status: OK
                    if (statusDot) statusDot.style.background = '#66ff66'; // Green
                    if (statusText) statusText.innerText = 'Online';
                    if (statusText) statusText.style.color = '#ccc';
                } else {
                    throw new Error('API Error');
                }
            } catch (e) {
                // Update Status: ERROR
                if (statusDot) statusDot.style.background = '#ff6666'; // Red
                if (statusText) statusText.innerText = 'Brak po≈ÇƒÖczenia';
                if (statusText) statusText.style.color = '#ff6666';
            }
        }
        setInterval(updateCartReturnCount, 5000);
        updateCartReturnCount();


    </script>
</body>

</html><!-- Modal edycji produktu -->
<div id="edit-product-modal" class="hidden"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <div
        style="background: #1a1a1a; padding: 30px; border-radius: 10px; border: 2px solid var(--accent-orange); max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0; color: var(--accent-orange);">‚úèÔ∏è Edytuj Produkt</h2>
        <input type="hidden" id="edit-product-id">
        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
            <div>
                <label style="color: #888; font-size: 0.8rem;">Nazwa Firmy</label>
                <input id="edit-product-company" type="text"
                    style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;">
            </div>
            <div>
                <label style="color: #888; font-size: 0.8rem;">Nazwa Produktu</label>
                <input id="edit-product-name" type="text"
                    style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;">
            </div>
            <div>
                <label style="color: #888; font-size: 0.8rem;">Identyfikator RCS</label>
                <input id="edit-product-rcs" type="text"
                    style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;">
            </div>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeEditProductModal()" class="btn" style="padding: 10px 20px; background: #555;">
                Anuluj
            </button>
            <button onclick="saveProductChanges()" class="btn btn-orange" style="padding: 10px 20px;">
                üíæ Zapisz
            </button>
        </div>
    </div>
</div>

<!-- Modal importu -->
<div id="import-modal" class="hidden"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <div
        style="background: #1a1a1a; padding: 30px; border-radius: 10px; border: 2px solid var(--accent-orange); max-width: 600px; width: 90%;">
        <h2 id="import-modal-title" style="margin-top: 0; color: var(--accent-orange);"
            data-i18n="import_products_title">üì§ Import Produkt√≥w</h2>

        <div
            style="background: #252525; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 3px solid var(--accent-blue);">
            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;" data-i18n="file_format_label">Format
                pliku:</div>
            <code style="color: #fff; font-size: 0.9rem;">company_name, product_name, rcs_id</code>
        </div>

        <input type="file" id="import-file-input" accept=".csv,.xlsx,.xls"
            style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; margin-bottom: 15px;">

        <div id="import-progress" class="hidden" style="margin-bottom: 15px;">
            <div style="background: #333; height: 8px; border-radius: 4px; overflow: hidden;">
                <div id="import-progress-bar"
                    style="background: var(--accent-green); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <div id="import-status" style="color: #888; font-size: 0.85rem; margin-top: 5px; text-align: center;"></div>
        </div>

        <div id="import-results" class="hidden"
            style="background: #252525; padding: 15px; border-radius: 6px; margin-bottom: 15px; max-height: 200px; overflow-y: auto;">
            <!-- Wyniki importu -->
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeImportModal()" class="btn" style="padding: 10px 20px; background: #555;"
                data-i18n="btn_cancel_modal">
                Anuluj
            </button>
            <button id="import-btn" onclick="executeImport()" class="btn btn-orange" style="padding: 10px 20px;"
                data-i18n="btn_import">
                üì§ Importuj
            </button>
        </div>
    </div>
</div>

<!-- MODAL: Dodaj kopertƒô do listy wyszukiwania -->
<div id="add-search-modal" class="modal hidden">
    <div
        style="background: #1a1a1a; padding: 30px; border-radius: 10px; border: 2px solid var(--accent-blue); max-width: 400px; width: 90%;">
        <h2 style="margin-top: 0; color: var(--accent-blue);" data-i18n="add_to_search_title">üîç Dodaj do listy
            szukanych</h2>

        <div style="margin-bottom: 20px;">
            <label style="color: #888; font-size: 0.85rem; margin-bottom: 5px; display: block;"
                data-i18n="envelope_id_label">ID Koperty:</label>
            <input type="text" id="add-search-envelope-id" placeholder="np. RCS044761/A"
                style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;"
                data-i18n="envelope_placeholder">
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeAddSearchModal()" class="btn" style="padding: 10px 20px; background: #555;"
                data-i18n="btn_cancel_modal">
                Anuluj
            </button>
            <button onclick="executeAddToSearchList()" class="btn btn-blue" style="padding: 10px 20px;"
                data-i18n="btn_add">
                ‚úÖ Dodaj
            </button>
        </div>
    </div>
</div>

<!-- MODAL: Import listy wyszukiwania -->
<div id="import-search-modal" class="modal hidden">
    <div
        style="background: #1a1a1a; padding: 30px; border-radius: 10px; border: 2px solid var(--accent-blue); max-width: 600px; width: 90%;">
        <h2 id="import-search-modal-title" style="margin-top: 0; color: var(--accent-blue);"
            data-i18n="import_search_title">üì§ Import Listy Szukanych
        </h2>

        <div
            style="background: #252525; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 3px solid var(--accent-blue);">
            <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;" data-i18n="file_format_label">Format
                pliku:</div>
            <code style="color: #fff; font-size: 0.9rem;"
                data-i18n="file_format_search_hint">Jedna koperta na liniƒô (CSV lub Excel z 1 kolumnƒÖ)</code>
        </div>

        <input type="file" id="import-search-file-input" accept=".csv,.xlsx,.xls"
            style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; margin-bottom: 15px;">

        <div id="import-search-progress" class="hidden" style="margin-bottom: 15px;">
            <div style="background: #333; height: 8px; border-radius: 4px; overflow: hidden;">
                <div id="import-search-progress-bar"
                    style="background: var(--accent-green); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <div id="import-search-status"
                style="color: #888; font-size: 0.85rem; margin-top: 5px; text-align: center;"></div>
        </div>

        <div id="import-search-results" class="hidden"
            style="background: #252525; padding: 15px; border-radius: 6px; margin-bottom: 15px; max-height: 200px; overflow-y: auto;">
            <!-- Wyniki importu -->
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeImportSearchModal()" class="btn" style="padding: 10px 20px; background: #555;"
                data-i18n="btn_cancel_modal">
                Anuluj
            </button>
            <button id="import-search-btn" onclick="executeImportSearchList()" class="btn btn-blue"
                style="padding: 10px 20px;" data-i18n="btn_import">
                üì§ Importuj
            </button>
        </div>
    </div>
</div>

<script src="product-management.js"></script>
</body>

</html>